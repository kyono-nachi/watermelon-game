<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ã‚¦ã‚©ãƒ¼ã‚¿ãƒ¼ãƒ¡ãƒ­ãƒ³ã‚²ãƒ¼ãƒ </title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Rounded Mplus 1c', 'Arial', sans-serif;
            background: linear-gradient(180deg, #C8A882 0%, #A67C52 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow: hidden;
            touch-action: none;
        }

        /* ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç”»é¢ */
        #passwordScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(180deg, #C8A882 0%, #A67C52 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        #passwordScreen.hidden {
            display: none;
        }

        #passwordBox {
            background: rgba(255, 248, 230, 0.98);
            padding: 50px 60px;
            border-radius: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            text-align: center;
            border: 3px solid #D2691E;
        }

        #passwordBox h2 {
            font-size: 28px;
            color: #D2691E;
            margin-bottom: 30px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }

        #passwordInput {
            width: 100%;
            padding: 15px 20px;
            font-size: 18px;
            border: 2px solid #D2B48C;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            outline: none;
            transition: border-color 0.3s;
        }

        #passwordInput:focus {
            border-color: #D2691E;
        }

        #passwordSubmit {
            width: 100%;
            background: linear-gradient(135deg, #FFB347 0%, #FF8C42 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
            box-shadow: 0 4px 15px rgba(255, 140, 66, 0.4);
        }

        #passwordSubmit:hover {
            transform: translateY(-2px);
        }

        #passwordSubmit:active {
            transform: translateY(0);
        }

        #passwordError {
            color: #dc3545;
            font-size: 14px;
            margin-top: 10px;
            min-height: 20px;
        }

        #gameContainer {
            position: relative;
            width: 100vw;
            max-width: 100%;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            gap: 15px;
        }

        #topPanel {
            display: flex;
            justify-content: center;
            gap: 20px;
            width: 100%;
            max-width: 500px;
        }

        .info-bubble {
            background: rgba(255, 248, 230, 0.95);
            border-radius: 50%;
            width: 120px;
            height: 120px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(139, 69, 19, 0.3);
            border: 3px solid rgba(255, 255, 255, 0.5);
            flex-shrink: 0;
        }

        .info-label {
            font-size: 14px;
            color: #8B4513;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .info-value {
            font-size: 28px;
            font-weight: bold;
            color: #D2691E;
        }

        .best-score-label {
            font-size: 10px;
            color: #8B4513;
            opacity: 0.7;
        }

        #nextBall {
            background: rgba(255, 248, 230, 0.95);
            border-radius: 50%;
            width: 120px;
            height: 120px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(139, 69, 19, 0.3);
            border: 3px solid rgba(255, 255, 255, 0.5);
            flex-shrink: 0;
        }

        #nextBall h3 {
            font-size: 14px;
            color: #8B4513;
            margin-bottom: 8px;
            font-weight: bold;
        }

        #nextPreview {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        #nextPreview img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        #gameArea {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            max-width: 500px;
            gap: 10px;
        }

        #canvasWrapper {
            position: relative;
            width: 100%;
            flex-shrink: 0;
        }

        #gameCanvas {
            display: block;
            background: linear-gradient(180deg, #FFF8E7 0%, #F5E6D3 100%);
            border-radius: 15px;
            box-shadow: 
                0 8px 20px rgba(0,0,0,0.2),
                inset 0 2px 5px rgba(255,255,255,0.5);
            border: 4px solid #D2B48C;
            cursor: pointer;
            touch-action: none;
            width: 100%;
        }

        #sinkaBar {
            width: 100%;
            background: rgba(255, 248, 230, 0.95);
            border-radius: 15px;
            padding: 15px;
            box-shadow: 0 4px 15px rgba(139, 69, 19, 0.3);
            border: 3px solid rgba(255, 255, 255, 0.5);
            flex-shrink: 0;
        }

        #sinkaBar h3 {
            font-size: 14px;
            color: #8B4513;
            text-align: center;
            margin-bottom: 10px;
            font-weight: bold;
        }

        #sinkaBarImage {
            width: 100%;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            min-height: 60px;
        }

        #sinkaBarImage img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .placeholder-text {
            font-size: 12px;
            color: #8B4513;
            opacity: 0.5;
            text-align: center;
        }

        #gameOver {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 248, 230, 0.98);
            padding: 40px;
            border-radius: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.4);
            text-align: center;
            display: none;
            pointer-events: all;
            border: 3px solid #D2691E;
            z-index: 1000;
        }

        #gameOver h2 {
            font-size: 32px;
            color: #D2691E;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }

        #gameOver p {
            font-size: 18px;
            color: #8B4513;
            margin-bottom: 30px;
        }

        #restartBtn {
            background: linear-gradient(135deg, #FFB347 0%, #FF8C42 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 30px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
            box-shadow: 0 4px 15px rgba(255, 140, 66, 0.4);
            text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
        }

        #restartBtn:active {
            transform: scale(0.95);
        }

        .game-line {
            position: absolute;
            left: 4px;
            right: 4px;
            height: 2px;
            background: rgba(255, 107, 107, 0.6);
            pointer-events: none;
            z-index: 10;
        }

        @media (max-width: 768px) {
            #gameContainer {
                padding: 15px;
            }
            
            .info-bubble, #nextBall {
                width: 100px;
                height: 100px;
            }
            
            .info-label {
                font-size: 12px;
            }
            
            .info-value {
                font-size: 24px;
            }
            
            #nextPreview {
                width: 60px;
                height: 60px;
            }
        }

        @media (max-width: 480px) {
            #gameContainer {
                padding: 10px;
            }
            
            .info-bubble, #nextBall {
                width: 85px;
                height: 85px;
            }
            
            .info-label, #nextBall h3 {
                font-size: 11px;
            }
            
            .info-value {
                font-size: 20px;
            }
            
            .best-score-label {
                font-size: 9px;
            }
            
            #nextPreview {
                width: 50px;
                height: 50px;
            }
        }
    </style>
</head>
<body>
    <!-- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰èªè¨¼ç”»é¢ -->
    <div id="passwordScreen">
        <div id="passwordBox">
            <h2>ğŸ”’ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›</h2>
            <input type="password" id="passwordInput" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" autocomplete="off">
            <button id="passwordSubmit">å…¥å®¤</button>
            <div id="passwordError"></div>
        </div>
    </div>

    <div id="gameContainer">
        <div id="topPanel">
            <div class="info-bubble">
                <span class="info-label">ã‚¹ã‚³ã‚¢</span>
                <span class="info-value" id="scoreValue">0</span>
                <span class="best-score-label">BEST SCORE</span>
                <span class="info-value" style="font-size: 16px;" id="worldRecord">5322</span>
            </div>
            <div id="nextBall">
                <h3>ãƒã‚¯ã‚¹ãƒˆ</h3>
                <div id="nextPreview"></div>
            </div>
        </div>
        <div id="gameArea">
            <div id="canvasWrapper">
                <canvas id="gameCanvas"></canvas>
                <div class="game-line"></div>
                <div id="gameOver">
                    <h2>ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼</h2>
                    <p>ã‚¹ã‚³ã‚¢: <span id="finalScore">0</span></p>
                    <button id="restartBtn">ãƒªã‚¹ã‚¿ãƒ¼ãƒˆ</button>
                </div>
            </div>
            <div id="sinkaBar">
                <h3>ã‚·ãƒ³ã‚«ã®æ£’</h3>
                <div id="sinkaBarImage">
                    <span class="placeholder-text">ç”»åƒã‚’é…ç½®</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ====================
        // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰èªè¨¼
        // ====================
        const PASSWORD = "suika"; // ã“ã“ã§ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è¨­å®š
        
        const passwordScreen = document.getElementById('passwordScreen');
        const passwordInput = document.getElementById('passwordInput');
        const passwordSubmit = document.getElementById('passwordSubmit');
        const passwordError = document.getElementById('passwordError');
        const gameContainer = document.getElementById('gameContainer');
        
        // åˆæœŸçŠ¶æ…‹ï¼šã‚²ãƒ¼ãƒ ã‚’éè¡¨ç¤º
        gameContainer.style.display = 'none';
        
        // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç¢ºèª
        function checkPassword() {
            const inputPassword = passwordInput.value;
            
            if (inputPassword === PASSWORD) {
                // æ­£è§£
                passwordScreen.classList.add('hidden');
                gameContainer.style.display = 'flex';
                initGame(); // ã‚²ãƒ¼ãƒ åˆæœŸåŒ–
            } else {
                // ä¸æ­£è§£
                passwordError.textContent = 'âŒ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™';
                passwordInput.value = '';
                passwordInput.focus();
                
                // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’3ç§’å¾Œã«æ¶ˆã™
                setTimeout(() => {
                    passwordError.textContent = '';
                }, 3000);
            }
        }
        
        // ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯
        passwordSubmit.addEventListener('click', checkPassword);
        
        // Enterã‚­ãƒ¼ã§ã‚‚é€ä¿¡
        passwordInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                checkPassword();
            }
        });
        
        // ====================
        // ã‚²ãƒ¼ãƒ æœ¬ä½“
        // ====================
        
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        // ====================
        // ç”»åƒè¨­å®šã‚¨ãƒªã‚¢
        // ====================
        const FRUIT_IMAGES = {
            0: 'images/fruit_0.png',
            1: 'images/fruit_1.png',
            2: 'images/fruit_2.png',
            3: 'images/fruit_3.png',
            4: 'images/fruit_4.png',
            5: 'images/fruit_5.png',
            6: 'images/fruit_6.png',
            7: 'images/fruit_7.png',
            8: 'images/fruit_8.png',
            9: 'images/fruit_9.png',
            10: 'images/fruit_10.png'
        };
        
        // ã‚·ãƒ³ã‚«ã®æ£’ã®ç”»åƒãƒ‘ã‚¹
        const SINKA_BAR_IMAGE = 'images/sinka_bar.png';
        
        // ====================
        
        // ç”»åƒã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æ ¼ç´
        const fruitImageObjects = {};
        let sinkaBarImageObject = null;
        let imagesLoaded = false;
        
        // ç”»åƒã‚’ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰
        function preloadImages() {
            let loadedCount = 0;
            let totalImages = 0;
            
            // ãƒ•ãƒ«ãƒ¼ãƒ„ç”»åƒã®æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
            for (let key in FRUIT_IMAGES) {
                if (FRUIT_IMAGES[key]) totalImages++;
            }
            
            // ã‚·ãƒ³ã‚«ã®æ£’ç”»åƒã‚’ã‚«ã‚¦ãƒ³ãƒˆ
            if (SINKA_BAR_IMAGE) totalImages++;
            
            if (totalImages === 0) {
                imagesLoaded = true;
                return;
            }
            
            function checkAllLoaded() {
                loadedCount++;
                if (loadedCount === totalImages) {
                    imagesLoaded = true;
                }
            }
            
            // ãƒ•ãƒ«ãƒ¼ãƒ„ç”»åƒã‚’èª­ã¿è¾¼ã¿
            for (let key in FRUIT_IMAGES) {
                if (FRUIT_IMAGES[key]) {
                    const img = new Image();
                    img.onload = checkAllLoaded;
                    img.onerror = checkAllLoaded;
                    img.src = FRUIT_IMAGES[key];
                    fruitImageObjects[key] = img;
                }
            }
            
            // ã‚·ãƒ³ã‚«ã®æ£’ç”»åƒã‚’èª­ã¿è¾¼ã¿
            if (SINKA_BAR_IMAGE) {
                sinkaBarImageObject = new Image();
                sinkaBarImageObject.onload = () => {
                    checkAllLoaded();
                    // UIè¡¨ç¤º
                    const sinkaBarImg = document.getElementById('sinkaBarImage');
                    sinkaBarImg.innerHTML = '';
                    const imgElement = document.createElement('img');
                    imgElement.src = SINKA_BAR_IMAGE;
                    sinkaBarImg.appendChild(imgElement);
                };
                sinkaBarImageObject.onerror = checkAllLoaded;
                sinkaBarImageObject.src = SINKA_BAR_IMAGE;
            }
        }
        
        preloadImages();
        
        // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚µã‚¤ã‚ºã‚’è¨­å®šï¼ˆæ¨ª1ï¼šç¸¦1.1ã®æ¯”ç‡ï¼‰
        function resizeCanvas() {
            const wrapper = document.getElementById('canvasWrapper');
            const maxWidth = wrapper.clientWidth;
            
            // æ¨ªå¹…ã‚’åŸºæº–ã«ã€ç¸¦ã‚’1.1å€ã«è¨­å®š
            canvas.width = maxWidth;
            canvas.height = maxWidth * 1.1;
            
            // ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ³ã®ä½ç½®ã‚’æ›´æ–°
            const gameLine = document.querySelector('.game-line');
            gameLine.style.top = (canvas.height * 0.15) + 'px';
            
            // ã‚·ãƒ³ã‚«ã®æ£’ã®é«˜ã•ã‚’è¨­å®šï¼ˆæ¨ªå¹…ã®0.3å€ï¼‰
            const sinkaBar = document.getElementById('sinkaBar');
            sinkaBar.style.height = (maxWidth * 0.3) + 'px';
        }
        
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);
        
        // ã‚²ãƒ¼ãƒ è¨­å®š
        const GRAVITY = 0.5;
        const BOUNCE = 0.3;
        const FRICTION = 0.99;
        const GAME_LINE_Y_RATIO = 0.15; // ã‚­ãƒ£ãƒ³ãƒã‚¹é«˜ã•ã®15%ã®ä½ç½®
        const WALL_THICKNESS_RATIO = 0.02; // ã‚­ãƒ£ãƒ³ãƒã‚¹å¹…ã®2%
        
        // ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ³ã®å®Ÿéš›ã®Yåº§æ¨™ã‚’å–å¾—
        function getGameLineY() {
            return canvas.height * GAME_LINE_Y_RATIO;
        }
        
        // å£ã®åšã•ã‚’å–å¾—
        function getWallThickness() {
            return canvas.width * WALL_THICKNESS_RATIO;
        }
        
        // ãƒ•ãƒ«ãƒ¼ãƒ„é¢¨ã®ãƒœãƒ¼ãƒ«ã®è‰²è¨­å®šï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚«ãƒ©ãƒ¼ï¼šç”»åƒãŒãªã„å ´åˆï¼‰
        const BALL_COLORS = [
            '#FFE66D', // 0: ãƒã‚§ãƒªãƒ¼ï¼ˆé»„è‰²ï¼‰
            '#FFB347', // 1: ã‚ªãƒ¬ãƒ³ã‚¸
            '#FF6B6B', // 2: ã‚¹ãƒˆãƒ­ãƒ™ãƒªãƒ¼ï¼ˆèµ¤ï¼‰
            '#C77DFF', // 3: ã‚°ãƒ¬ãƒ¼ãƒ—ï¼ˆç´«ï¼‰
            '#FFD93D', // 4: ãƒ¬ãƒ¢ãƒ³ï¼ˆé»„è‰²æ˜ã‚‹ã‚ï¼‰
            '#FF8C42', // 5: ãƒ”ãƒ¼ãƒï¼ˆã‚ªãƒ¬ãƒ³ã‚¸èµ¤ï¼‰
            '#4ECDC4', // 6: ãƒ¡ãƒ­ãƒ³ï¼ˆã‚¿ãƒ¼ã‚³ã‚¤ã‚ºï¼‰
            '#95E1D3', // 7: ãƒ©ã‚¤ãƒï¼ˆãƒŸãƒ³ãƒˆï¼‰
            '#F38181', // 8: ã‚¢ãƒƒãƒ—ãƒ«ï¼ˆèµ¤ï¼‰
            '#FFEB3B', // 9: ãƒ‘ã‚¤ãƒŠãƒƒãƒ—ãƒ«ï¼ˆé»„è‰²ï¼‰
            '#FFD700'  // 10: ã‚¹ã‚¤ã‚«ï¼ˆã‚´ãƒ¼ãƒ«ãƒ‰ï¼‰
        ];
        
        // ãƒœãƒ¼ãƒ«ã®ã‚µã‚¤ã‚ºè¨­å®šï¼ˆ11å€‹ã®ãƒœãƒ¼ãƒ«ã€æœ€å¤§ãŒæ¨ªå¹…ã®45%ï¼‰
        function getBallSize(type) {
            // æœ€å¤§ã‚µã‚¤ã‚ºï¼ˆtype 10ï¼‰ãŒæ¨ªå¹…ã®45%
            const maxSize = canvas.width * 0.45 / 2; // ç›´å¾„ã®45%ãªã®ã§åŠå¾„ã¯22.5%
            // æœ€å°ã‚µã‚¤ã‚ºï¼ˆtype 0ï¼‰ã‚’æœ€å¤§ã‚µã‚¤ã‚ºã®20%ã«è¨­å®š
            const minSize = maxSize * 0.2;
            // ç·šå½¢ã«å¢—åŠ 
            return minSize + (maxSize - minSize) * (type / 10);
        }
        
        // ã‚²ãƒ¼ãƒ çŠ¶æ…‹
        let balls = [];
        let score = 0;
        let nextBallType = 0;
        let isGameOver = false;
        let currentBall = null;
        let worldRecord = 5322;
        let frameCount = 0;
        let checkGameOverDelay = 0;
        
        // æ¬¡ã®ãƒœãƒ¼ãƒ«ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«é¸æŠï¼ˆ0-4ã®ç¯„å›²ï¼‰
        function getRandomBallType() {
            return Math.floor(Math.random() * 5);
        }
        
        // ãƒœãƒ¼ãƒ«ã‚¯ãƒ©ã‚¹
        class Ball {
            constructor(x, y, type) {
                this.x = x;
                this.y = y;
                this.type = type;
                this.radius = getBallSize(type);
                this.vx = 0;
                this.vy = 0;
                this.color = BALL_COLORS[type];
                this.merged = false;
                this.rotation = 0; // æœ€åˆã¯æ­£é¢å‘ã
                this.angularVelocity = 0;
            }
            
            update() {
                if (this.merged) return;
                
                const wallThickness = getWallThickness();
                
                // é‡åŠ›ã‚’é©ç”¨
                this.vy += GRAVITY;
                
                // æ‘©æ“¦ã‚’é©ç”¨
                this.vx *= FRICTION;
                this.vy *= FRICTION;
                
                // è§’é€Ÿåº¦ã‚’é€Ÿåº¦ã«åŸºã¥ã„ã¦æ›´æ–°ï¼ˆè»¢ãŒã‚‹åŠ¹æœï¼‰
                this.angularVelocity = -this.vx / (this.radius * 0.15); // è»¢ã’è½ã¡ã‚‹å›è»¢
                this.rotation += this.angularVelocity;
                
                // è§’é€Ÿåº¦ã®æ¸›è¡°ï¼ˆç·©ã‚„ã‹ã«ï¼‰
                this.angularVelocity *= 0.98;
                
                // ä½ç½®ã‚’æ›´æ–°
                this.x += this.vx;
                this.y += this.vy;
                
                // å£ã¨ã®è¡çª
                if (this.x - this.radius < wallThickness) {
                    this.x = wallThickness + this.radius;
                    this.vx *= -BOUNCE;
                }
                if (this.x + this.radius > canvas.width - wallThickness) {
                    this.x = canvas.width - wallThickness - this.radius;
                    this.vx *= -BOUNCE;
                }
                
                // åºŠã¨ã®è¡çª
                if (this.y + this.radius > canvas.height - wallThickness) {
                    this.y = canvas.height - wallThickness - this.radius;
                    this.vy *= -BOUNCE;
                    this.vx *= 0.95; // åºŠã§ã®æ‘©æ“¦
                }
            }
            
            draw() {
                if (this.merged) return;
                
                ctx.save();
                
                // ãƒœãƒ¼ãƒ«ã®å½±
                ctx.fillStyle = 'rgba(139, 69, 19, 0.3)';
                ctx.beginPath();
                ctx.ellipse(this.x + 5, this.y + 5, this.radius * 0.95, this.radius * 0.3, 0, 0, Math.PI * 2);
                ctx.fill();
                
                // å›è»¢ã‚’é©ç”¨
                ctx.translate(this.x, this.y);
                ctx.rotate(this.rotation);
                
                // ç”»åƒãŒã‚ã‚‹å ´åˆã¯ç”»åƒã‚’æç”»
                if (fruitImageObjects[this.type]) {
                    ctx.drawImage(
                        fruitImageObjects[this.type],
                        -this.radius, -this.radius,
                        this.radius * 2, this.radius * 2
                    );
                } else {
                    // ç”»åƒãŒãªã„å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®æç”»
                    // ãƒœãƒ¼ãƒ«æœ¬ä½“ï¼ˆã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
                    const gradient = ctx.createRadialGradient(
                        -this.radius * 0.3, -this.radius * 0.3, 0,
                        0, 0, this.radius
                    );
                    gradient.addColorStop(0, this.lightenColor(this.color, 40));
                    gradient.addColorStop(1, this.color);
                    
                    ctx.fillStyle = gradient;
                    ctx.beginPath();
                    ctx.arc(0, 0, this.radius, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // ãƒœãƒ¼ãƒ«ã®ç¸
                    ctx.strokeStyle = this.darkenColor(this.color, 30);
                    ctx.lineWidth = 3;
                    ctx.stroke();
                    
                    // å›è»¢ãŒéå¸¸ã«åˆ†ã‹ã‚Šã‚„ã™ã„æ”¾å°„çŠ¶ã®ãƒ©ã‚¤ãƒ³ï¼ˆã‚¹ã‚¤ã‚«é¢¨ï¼‰
                    ctx.strokeStyle = this.darkenColor(this.color, 40);
                    ctx.lineWidth = 3;
                    for (let i = 0; i < 6; i++) {
                        const angle = (Math.PI * 2 / 6) * i;
                        ctx.beginPath();
                        ctx.moveTo(0, 0);
                        ctx.lineTo(
                            Math.cos(angle) * this.radius * 0.9,
                            Math.sin(angle) * this.radius * 0.9
                        );
                        ctx.stroke();
                    }
                    
                    // ä¸­å¤®ã«æ•°å­—ã‚’è¡¨ç¤ºï¼ˆå›è»¢ã®ç¢ºèªç”¨ï¼‰
                    ctx.fillStyle = 'white';
                    ctx.font = `bold ${this.radius * 0.6}px Arial`;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(this.type, 0, 0);
                }
                
                ctx.restore();
            }
            
            lightenColor(color, percent) {
                const num = parseInt(color.replace("#",""), 16);
                const amt = Math.round(2.55 * percent);
                const R = (num >> 16) + amt;
                const G = (num >> 8 & 0x00FF) + amt;
                const B = (num & 0x0000FF) + amt;
                return "#" + (0x1000000 + (R<255?R<1?0:R:255)*0x10000 +
                    (G<255?G<1?0:G:255)*0x100 + (B<255?B<1?0:B:255))
                    .toString(16).slice(1);
            }
            
            darkenColor(color, percent) {
                const num = parseInt(color.replace("#",""), 16);
                const amt = Math.round(2.55 * percent);
                const R = (num >> 16) - amt;
                const G = (num >> 8 & 0x00FF) - amt;
                const B = (num & 0x0000FF) - amt;
                return "#" + (0x1000000 + (R>0?R:0)*0x10000 +
                    (G>0?G:0)*0x100 + (B>0?B:0))
                    .toString(16).slice(1);
            }
        }
        
        // ãƒœãƒ¼ãƒ«åŒå£«ã®è¡çªåˆ¤å®šã¨å‡¦ç†
        function handleCollisions() {
            const newBalls = [];
            
            for (let i = 0; i < balls.length; i++) {
                if (balls[i].merged) continue;
                
                for (let j = i + 1; j < balls.length; j++) {
                    if (balls[j].merged) continue;
                    
                    const dx = balls[j].x - balls[i].x;
                    const dy = balls[j].y - balls[i].y;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    const minDist = balls[i].radius + balls[j].radius;
                    
                    if (distance < minDist) {
                        // åŒã˜ã‚¿ã‚¤ãƒ—ã®ãƒœãƒ¼ãƒ«ãŒè¡çª â†’ åˆæˆ
                        if (balls[i].type === balls[j].type && balls[i].type < 10) {
                            const newType = balls[i].type + 1;
                            const newX = (balls[i].x + balls[j].x) / 2;
                            const newY = (balls[i].y + balls[j].y) / 2;
                            
                            const newBall = new Ball(newX, newY, newType);
                            newBalls.push(newBall);
                            
                            balls[i].merged = true;
                            balls[j].merged = true;
                            
                            // ã‚¹ã‚³ã‚¢åŠ ç®—
                            score += Math.pow(2, newType) * 10;
                            updateScore();
                            
                            break;
                        } else {
                            // ç‰©ç†çš„ãªæŠ¼ã—å‡ºã—
                            const overlap = minDist - distance;
                            const angle = Math.atan2(dy, dx);
                            
                            const pushX = Math.cos(angle) * overlap / 2;
                            const pushY = Math.sin(angle) * overlap / 2;
                            
                            balls[i].x -= pushX;
                            balls[i].y -= pushY;
                            balls[j].x += pushX;
                            balls[j].y += pushY;
                            
                            // é€Ÿåº¦äº¤æ›ï¼ˆç°¡æ˜“ç‰ˆï¼‰
                            const vx1 = balls[i].vx;
                            const vy1 = balls[i].vy;
                            
                            balls[i].vx = balls[j].vx * 0.8;
                            balls[i].vy = balls[j].vy * 0.8;
                            balls[j].vx = vx1 * 0.8;
                            balls[j].vy = vy1 * 0.8;
                        }
                    }
                }
            }
            
            // ãƒãƒ¼ã‚¸ã•ã‚ŒãŸãƒœãƒ¼ãƒ«ã‚’å‰Šé™¤
            balls = balls.filter(b => !b.merged);
            
            // æ–°ã—ã„ãƒœãƒ¼ãƒ«ã‚’è¿½åŠ 
            balls.push(...newBalls);
        }
        
        // ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼åˆ¤å®š
        function checkGameOver() {
            // ãƒœãƒ¼ãƒ«ãŒè½ã¡ã¦ã‹ã‚‰å°‘ã—å¾…ã¤
            if (checkGameOverDelay > 0) {
                checkGameOverDelay--;
                return false;
            }
            
            const gameLineY = getGameLineY();
            
            for (let ball of balls) {
                // ãƒœãƒ¼ãƒ«ãŒå®Œå…¨ã«é™æ­¢ã—ã¦ã„ãªã„å ´åˆã¯åˆ¤å®šã—ãªã„
                if (Math.abs(ball.vy) > 2) {
                    return false;
                }
                
                if (ball.y - ball.radius < gameLineY) {
                    return true;
                }
            }
            return false;
        }
        
        // ã‚¹ã‚³ã‚¢æ›´æ–°
        function updateScore() {
            document.getElementById('scoreValue').textContent = score;
            if (score > worldRecord) {
                worldRecord = score;
                document.getElementById('worldRecord').textContent = worldRecord;
            }
        }
        
        // æ¬¡ã®ãƒœãƒ¼ãƒ«ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–°
        function updateNextPreview() {
            const preview = document.getElementById('nextPreview');
            preview.innerHTML = '';
            
            if (fruitImageObjects[nextBallType]) {
                // ç”»åƒãŒã‚ã‚‹å ´åˆ
                const img = document.createElement('img');
                img.src = fruitImageObjects[nextBallType].src;
                preview.appendChild(img);
            } else {
                // ç”»åƒãŒãªã„å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚«ãƒ©ãƒ¼
                preview.style.backgroundColor = BALL_COLORS[nextBallType];
                preview.textContent = nextBallType;
            }
        }
        
        // ãƒã‚¦ã‚¹/ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆ
        let mouseX = canvas.width / 2;
        
        canvas.addEventListener('mousemove', (e) => {
            if (isGameOver) return;
            const rect = canvas.getBoundingClientRect();
            mouseX = e.clientX - rect.left;
        });
        
        canvas.addEventListener('click', (e) => {
            if (isGameOver || currentBall) return;
            
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            
            // ãƒœãƒ¼ãƒ«ã‚’è½ã¨ã™
            dropBall(x);
        });
        
        // ã‚¿ãƒƒãƒå¯¾å¿œ
        canvas.addEventListener('touchmove', (e) => {
            if (isGameOver) return;
            e.preventDefault();
            const rect = canvas.getBoundingClientRect();
            mouseX = e.touches[0].clientX - rect.left;
        });
        
        canvas.addEventListener('touchend', (e) => {
            if (isGameOver || currentBall) return;
            e.preventDefault();
            
            const rect = canvas.getBoundingClientRect();
            const x = e.changedTouches[0].clientX - rect.left;
            
            dropBall(x);
        });
        
        // ãƒœãƒ¼ãƒ«ã‚’è½ã¨ã™
        function dropBall(x) {
            const wallThickness = getWallThickness();
            const radius = getBallSize(nextBallType);
            
            // å£ã‹ã‚‰é›¢ã‚ŒãŸä½ç½®ã«åˆ¶é™
            x = Math.max(wallThickness + radius, Math.min(canvas.width - wallThickness - radius, x));
            
            currentBall = new Ball(x, 50, nextBallType);
            balls.push(currentBall);
            
            // ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼åˆ¤å®šã‚’é…ã‚‰ã›ã‚‹ï¼ˆ180ãƒ•ãƒ¬ãƒ¼ãƒ  = ç´„3ç§’ï¼‰
            checkGameOverDelay = 180;
            
            // æ¬¡ã®ãƒœãƒ¼ãƒ«ã‚’æº–å‚™
            nextBallType = getRandomBallType();
            updateNextPreview();
            
            // å°‘ã—å¾…ã£ã¦ã‹ã‚‰æ¬¡ã®ãƒœãƒ¼ãƒ«ã‚’è½ã¨ã›ã‚‹ã‚ˆã†ã«
            setTimeout(() => {
                currentBall = null;
            }, 500);
        }
        
        // ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ—
        function gameLoop() {
            const wallThickness = getWallThickness();
            const gameLineY = getGameLineY();
            
            // èƒŒæ™¯ã‚’ã‚¯ãƒªã‚¢
            ctx.fillStyle = '#FFF8E7';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // æœ¨è£½ã®å£ã‚’æç”»
            ctx.fillStyle = '#D2B48C';
            ctx.fillRect(0, 0, wallThickness, canvas.height); // å·¦å£
            ctx.fillRect(canvas.width - wallThickness, 0, wallThickness, canvas.height); // å³å£
            ctx.fillRect(0, canvas.height - wallThickness, canvas.width, wallThickness); // åºŠ
            
            // å£ã®æœ¨ç›®æ¨¡æ§˜
            ctx.strokeStyle = '#8B7355';
            ctx.lineWidth = 2;
            for (let i = 0; i < 8; i++) {
                ctx.beginPath();
                ctx.moveTo(wallThickness / 2, i * canvas.height / 8);
                ctx.lineTo(wallThickness / 2, (i + 1) * canvas.height / 8);
                ctx.stroke();
                
                ctx.beginPath();
                ctx.moveTo(canvas.width - wallThickness / 2, i * canvas.height / 8);
                ctx.lineTo(canvas.width - wallThickness / 2, (i + 1) * canvas.height / 8);
                ctx.stroke();
            }
            
            // ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ³ã‚’æç”»ï¼ˆå£ã®å†…å´ã ã‘ï¼‰
            ctx.strokeStyle = 'rgba(255, 107, 107, 0.6)';
            ctx.lineWidth = 3;
            ctx.setLineDash([10, 5]);
            ctx.beginPath();
            ctx.moveTo(wallThickness, gameLineY);
            ctx.lineTo(canvas.width - wallThickness, gameLineY);
            ctx.stroke();
            ctx.setLineDash([]);
            
            if (!isGameOver) {
                // ãƒœãƒ¼ãƒ«ã‚’æ›´æ–°
                for (let ball of balls) {
                    ball.update();
                }
                
                // è¡çªåˆ¤å®š
                handleCollisions();
                
                // ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼åˆ¤å®š
                if (checkGameOver()) {
                    isGameOver = true;
                    showGameOver();
                }
            }
            
            // ãƒœãƒ¼ãƒ«ã‚’æç”»
            for (let ball of balls) {
                ball.draw();
            }
            
            // æ¬¡ã®ãƒœãƒ¼ãƒ«ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆãƒã‚¦ã‚¹ä½ç½®ï¼‰
            if (!isGameOver && !currentBall) {
                const radius = getBallSize(nextBallType);
                const x = Math.max(wallThickness + radius, Math.min(canvas.width - wallThickness - radius, mouseX));
                
                ctx.save();
                ctx.globalAlpha = 0.5;
                ctx.translate(x, 50);
                
                // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒœãƒ¼ãƒ«ã®æç”»
                if (fruitImageObjects[nextBallType]) {
                    ctx.drawImage(
                        fruitImageObjects[nextBallType],
                        -radius, -radius,
                        radius * 2, radius * 2
                    );
                } else {
                    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
                    const gradient = ctx.createRadialGradient(
                        -radius * 0.3, -radius * 0.3, 0,
                        0, 0, radius
                    );
                    gradient.addColorStop(0, lightenColorUtil(BALL_COLORS[nextBallType], 40));
                    gradient.addColorStop(1, BALL_COLORS[nextBallType]);
                    
                    ctx.fillStyle = gradient;
                    ctx.beginPath();
                    ctx.arc(0, 0, radius, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // æ•°å­—
                    ctx.fillStyle = 'white';
                    ctx.font = `bold ${radius * 0.6}px Arial`;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(nextBallType, 0, 0);
                }
                
                ctx.restore();
            }
            
            requestAnimationFrame(gameLoop);
        }
        
        // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
        function lightenColorUtil(color, percent) {
            const num = parseInt(color.replace("#",""), 16);
            const amt = Math.round(2.55 * percent);
            const R = (num >> 16) + amt;
            const G = (num >> 8 & 0x00FF) + amt;
            const B = (num & 0x0000FF) + amt;
            return "#" + (0x1000000 + (R<255?R<1?0:R:255)*0x10000 +
                (G<255?G<1?0:G:255)*0x100 + (B<255?B<1?0:B:255))
                .toString(16).slice(1);
        }
        
        // ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼è¡¨ç¤º
        function showGameOver() {
            document.getElementById('finalScore').textContent = score;
            document.getElementById('gameOver').style.display = 'block';
        }
        
        // ãƒªã‚¹ã‚¿ãƒ¼ãƒˆ
        document.getElementById('restartBtn').addEventListener('click', () => {
            balls = [];
            score = 0;
            isGameOver = false;
            currentBall = null;
            nextBallType = getRandomBallType();
            checkGameOverDelay = 0;
            
            updateScore();
            updateNextPreview();
            document.getElementById('gameOver').style.display = 'none';
        });
        
        // ã‚²ãƒ¼ãƒ åˆæœŸåŒ–é–¢æ•°
        function initGame() {
            nextBallType = getRandomBallType();
            updateNextPreview();
            updateScore();
            gameLoop();
        }
        
        // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰èªè¨¼å¾Œã« initGame() ãŒå‘¼ã°ã‚Œã¾ã™
    </script>
</body>
</html>
