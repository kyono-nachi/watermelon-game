<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>ã‚¦ã‚©ãƒ¼ã‚¿ãƒ¼ãƒ¡ãƒ­ãƒ³ã‚²ãƒ¼ãƒ  v5.8</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2C4A4A">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ã‚¦ã‚©ãƒ¼ã‚¿ãƒ¼ãƒ¡ãƒ­ãƒ³">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700;900&family=Space+Mono:wght@700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/matter-js@0.19.0/build/matter.min.js"></script>
    <style>
        /* ==================== */
        /* ãƒ‡ã‚¶ã‚¤ãƒ³ã‚·ã‚¹ãƒ†ãƒ  */
        /* ==================== */
        :root {
            /* ========== èƒŒæ™¯ ========== */
            --bg-main: #3A4F4F;              /* æš—ã„é’ç·‘ï¼ˆãƒ¡ã‚¤ãƒ³èƒŒæ™¯ï¼‰ */
            --bg-overlay: rgba(0, 0, 0, 0.7); /* ãƒ¢ãƒ¼ãƒ€ãƒ«èƒŒæ™¯ */
            
            /* ========== ã‚«ãƒ¼ãƒ‰ãƒ»ãƒ‘ãƒãƒ« ========== */
            --card-base: #F5F0E8;            /* æ·¡ã„ãƒ™ãƒ¼ã‚¸ãƒ¥ï¼ˆã‚«ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹ï¼‰ */
            --card-secondary: rgba(255, 248, 241, 0.9); /* åŠé€æ˜ã‚«ãƒ¼ãƒ‰ */
            
            /* ========== æ ç·šãƒ»å¢ƒç•Œ ========== */
            --border-brown: #8B6F47;         /* èŒ¶è‰²ã®æ ç·š */
            --border-light: rgba(139, 111, 71, 0.3); /* è–„ã„æ ç·š */
            
            /* ========== ãƒ†ã‚­ã‚¹ãƒˆ ========== */
            --text-primary: #5C4A3A;         /* æ¿ƒã„èŒ¶è‰²ï¼ˆãƒ¡ã‚¤ãƒ³ãƒ†ã‚­ã‚¹ãƒˆï¼‰ */
            --text-secondary: rgba(92, 74, 58, 0.7); /* è–„ã„ãƒ†ã‚­ã‚¹ãƒˆ */
            --text-white: #FFFFFF;
            
            /* ========== ãƒœã‚¿ãƒ³ï¼ˆæ·¡ã„ã‚ªãƒ¬ãƒ³ã‚¸ç³»ï¼‰ ========== */
            --btn-primary: #E8B896;          /* æ·¡ã„ã‚ªãƒ¬ãƒ³ã‚¸ï¼ˆãƒ¡ã‚¤ãƒ³ãƒœã‚¿ãƒ³ï¼‰ */
            --btn-primary-hover: #D4A682;    /* ãƒ›ãƒãƒ¼æ™‚ */
            
            --btn-green: #8CAF99;            /* æ·¡ã„ç·‘ï¼ˆãƒã‚¤ã‚¹ã‚³ã‚¢ã€ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã€ãŠçŸ¥ã‚‰ã›ï¼‰ */
            --btn-green-hover: #7A9B87;      /* ãƒ›ãƒãƒ¼æ™‚ */
            
            --btn-neutral: #D4C4B0;          /* ãƒ™ãƒ¼ã‚¸ãƒ¥ï¼ˆé–‰ã˜ã‚‹ã€ãƒªã‚¹ã‚¿ãƒ¼ãƒˆï¼‰ */
            --btn-neutral-hover: #C0B09C;    /* ãƒ›ãƒãƒ¼æ™‚ */
            
            /* ========== ã‚¢ã‚¯ã‚»ãƒ³ãƒˆï¼ˆé’ç·‘ï¼‰ ========== */
            --accent-teal: #6B9D9A;          /* é’ç·‘ï¼ˆãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã€ãƒã‚§ãƒƒã‚¯ãƒãƒ¼ã‚¯ï¼‰ */
            --accent-teal-light: rgba(107, 157, 154, 0.2); /* è–„ã„é’ç·‘ */
            
            /* ========== ç‰¹åˆ¥ãªè‰² ========== */
            --accent-gold: #E8C878;          /* æŸ”ã‚‰ã‹ã„é‡‘è‰²ï¼ˆã‚´ãƒ¼ãƒ«ãƒ‰è¦ç´ ï¼‰ */
            --accent-gold-bright: #FFD700;   /* æ˜ã‚‹ã„é‡‘è‰²ï¼ˆTOP3å°‚ç”¨ï¼‰ */
            --accent-red: #D4907C;           /* æŸ”ã‚‰ã‹ã„èµ¤ï¼ˆè­¦å‘Šã€æ³¨æ„ï¼‰ */
            
            /* ========== æ—§ã‚·ã‚¹ãƒ†ãƒ äº’æ›ï¼ˆæ®µéšçš„ã«ç½®ãæ›ãˆï¼‰ ========== */
            --primary: var(--border-brown);
            --bg-gradient: linear-gradient(180deg, #3A4F4F 0%, #2C3E3E 100%);
            --bg-light: var(--card-base);
            --bg-cream: #F5EDE3;
            --bg-card: linear-gradient(135deg, #F5F0E8 0%, #F5EDE3 100%);
            
            /* ========== ã‚·ãƒ£ãƒ‰ã‚¦ï¼ˆæ§ãˆã‚ï¼‰ ========== */
            --shadow-minimal: 0 2px 8px rgba(0, 0, 0, 0.1);
            --shadow-soft: 0 2px 12px rgba(0, 0, 0, 0.15);
            --shadow-medium: 0 3px 15px rgba(0, 0, 0, 0.2);
            --shadow-strong: 0 4px 20px rgba(0, 0, 0, 0.25);
            
            /* ========== ãƒ•ã‚©ãƒ³ãƒˆ ========== */
            --font-display: 'Noto Sans JP', sans-serif; /* ã‚¿ã‚¤ãƒˆãƒ«ãƒ»è¦‹å‡ºã—ç”¨ï¼ˆãã¡ã£ã¨ã—ãŸè§’ã‚´ã‚·ãƒƒã‚¯ï¼‰ */
            --font-body: 'Noto Sans JP', sans-serif;
            --font-numbers: 'Space Mono', monospace;
            
            /* ========== è§’ä¸¸ ========== */
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 20px;
            --radius-xl: 30px;
            
            /* ========== ãƒˆãƒ©ãƒ³ã‚¸ã‚·ãƒ§ãƒ³ ========== */
            --transition-fast: 0.2s;
            --transition-medium: 0.3s;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: var(--font-body);
            background: 
                radial-gradient(circle at 20% 80%, rgba(107, 157, 154, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(107, 157, 154, 0.15) 0%, transparent 50%),
                linear-gradient(180deg, #3A4F4F 0%, #2C3E3E 100%);
            min-height: 100vh;
            overflow-y: auto;
            overflow-x: hidden;
        }

        /* ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç”»é¢ */
        /* ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ */
        #startScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10001;
        }

        #startScreen.active {
            display: flex;
        }

        #startBox {
            background: var(--bg-card);
            padding: 60px 80px;
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-strong);
            text-align: center;
            border: 3px solid var(--border-brown);
        }

        #startBox h2 {
            font-family: var(--font-display);
            font-size: 36px;
            font-weight: 900;
            color: var(--border-brown);
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }

        #startBox p {
            font-size: 16px;
            color: var(--text-primary);
            margin-bottom: 30px;
        }

        #startButton {
            width: 100%;
            background: var(--btn-primary);
            color: var(--text-primary);
            border: none;
            padding: 18px 50px;
            border-radius: var(--radius-md);
            font-size: 22px;
            font-weight: bold;
            cursor: pointer;
            transition: all var(--transition-fast);
            box-shadow: var(--shadow-minimal);
        }

        #startButton:hover {
            background: var(--btn-primary-hover);
            transform: translateY(-2px);
            box-shadow: var(--shadow-soft);
        }

        #startButton:active {
            transform: translateY(0);
        }

        /* é›£æ˜“åº¦é¸æŠç”»é¢ */
        #difficultyScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 80%, rgba(107, 157, 154, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(107, 157, 154, 0.15) 0%, transparent 50%),
                linear-gradient(180deg, #3A4F4F 0%, #2C3E3E 100%);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10001;
        }

        #difficultyScreen.active {
            display: flex;
        }

        #versionLabel {
            position: fixed;
            bottom: 20px;
            right: 20px;
            font-size: 14px;
            color: rgba(245, 240, 232, 0.6);
            font-weight: bold;
            user-select: none;
            pointer-events: none;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
        }

        #difficultyBox {
            background: var(--bg-card);
            padding-top: 50px;
            padding-bottom: 32px;
            padding-left: 60px;
            padding-right: 60px;
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-strong);
            text-align: center;
            border: 3px solid var(--border-brown);
            max-width: 400px;
        }

        #difficultyBox h2 {
            font-family: var(--font-display);
            font-size: 20px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border-brown);
            text-align: center;
        }

        .difficulty-button {
            width: 100%;
            background: var(--btn-primary);
            color: var(--text-primary);
            border: none;
            padding: 18px 60px;
            border-radius: var(--radius-md);
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            transition: all var(--transition-fast);
            box-shadow: var(--shadow-minimal);
            margin-bottom: 15px;
        }

        .difficulty-button:hover {
            background: var(--btn-primary-hover);
            transform: translateY(-2px);
            box-shadow: var(--shadow-soft);
        }

        .difficulty-button:active {
            transform: translateY(0);
        }

        .difficulty-button.locked {
            background: #C0C0C0;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .difficulty-button.locked:hover {
            transform: none;
            box-shadow: var(--shadow-minimal);
        }

        .difficulty-button.green {
            background: var(--btn-green);
            width: 80%;
            padding: 12px 28px;
            font-size: 14px;
        }

        .difficulty-button.green:hover {
            background: var(--btn-green-hover);
        }

        .difficulty-description {
            font-size: 14px;
            color: var(--text-primary);
            margin-top: -10px;
            margin-bottom: 15px;
        }

        /* ==================== */
        /* å…±é€šãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¹ã‚¿ã‚¤ãƒ« */
        /* ==================== */
        .modal-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            animation: fadeIn var(--transition-medium) ease-out;
        }

        .modal-screen.active {
            display: flex;
        }

        .modal-box {
            background: var(--bg-card);
            padding: 40px 30px;
            border-radius: var(--radius-lg);
            max-width: 500px;
            width: 90%;
            box-shadow: var(--shadow-medium);
            border: 3px solid var(--border-brown);
        }

        .modal-box h2 {
            font-family: var(--font-display);
            font-size: 28px;
            font-weight: 900;
            color: var(--border-brown);
            margin-bottom: 20px;
            text-align: center;
        }

        /* ãƒã‚¤ã‚¹ã‚³ã‚¢ä¸€è¦§ç”»é¢ */
        #highScoreScreen {
            z-index: 10002;
        }

        #highScoreBox {
            max-width: 400px;
        }

        #highScoreList {
            margin-bottom: 25px;
        }

        .high-score-section {
            margin-bottom: 20px;
        }

        .high-score-section h3 {
            font-family: var(--font-display);
            font-size: 16px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 2px solid var(--border-light);
        }

        .high-score-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background: rgba(255, 255, 255, 0.6);
            border-radius: 10px;
            margin-bottom: 8px;
        }

        .difficulty-name {
            font-size: 18px;
            color: #8B4513;
            font-weight: bold;
        }

        .score-value {
            font-size: 22px;
            color: #D2691E;
            font-weight: bold;
        }

        .high-score-divider {
            height: 2px;
            background: linear-gradient(90deg, transparent, rgba(139, 69, 19, 0.3), transparent);
            margin: 20px 0;
        }

        /* é–‰ã˜ã‚‹ãƒ»ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³ï¼ˆçµ±ä¸€ã‚¹ã‚¿ã‚¤ãƒ«ï¼‰ */
        #closeHighScore,
        #closeNews,
        #debugClose {
            width: 100%;
            background: var(--btn-neutral);
            color: var(--text-primary);
            border: none;
            padding: 15px;
            border-radius: var(--radius-md);
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all var(--transition-fast);
            box-shadow: var(--shadow-minimal);
        }

        #closeHighScore:hover,
        #closeNews:hover,
        #debugClose:hover {
            background: var(--btn-neutral-hover);
            transform: translateY(-2px);
            box-shadow: var(--shadow-soft);
        }

        /* ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ©ãƒ³ã‚­ãƒ³ã‚°ç”»é¢ */
        #rankingScreen {
            z-index: 10003;
        }

        #rankingBox {
            max-height: 80vh;
            overflow-y: auto;
        }

        /* ãŠçŸ¥ã‚‰ã›ç”»é¢ */
        #newsScreen {
            z-index: 10003;
        }

        #newsBox {
            position: relative;
            max-height: 80vh;
            overflow-y: auto;
        }

        .news-item {
            background: rgba(255, 255, 255, 0.7);
            padding: 15px;
            border-radius: var(--radius-md);
            margin-bottom: 15px;
            border: 2px solid var(--primary);
        }

        .news-item h3 {
            font-family: var(--font-display);
            color: var(--primary);
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .news-item ul {
            list-style: none;
            padding-left: 0;
            margin: 0;
        }

        .news-item li {
            padding: 5px 0;
            font-size: 14px;
            color: var(--text-primary);
        }

        /* closeNewsã¯ä¸Šã®çµ±ä¸€ã‚¹ã‚¿ã‚¤ãƒ«ã§å¯¾å¿œ */


        #rankingModeSelect {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .ranking-mode-btn {
            flex: 1;
            min-width: 100px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.6);
            border: 2px solid var(--border-brown);
            border-radius: var(--radius-sm);
            font-size: 14px;
            font-weight: bold;
            color: var(--text-primary);
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .ranking-mode-btn:hover {
            background: rgba(255, 255, 255, 0.9);
        }

        .ranking-mode-btn.active {
            background: var(--border-brown);
            color: var(--text-white);
        }

        #rankingList {
            background: rgba(255, 255, 255, 0.7);
            border-radius: var(--radius-md);
            padding: 15px;
            margin-bottom: 20px;
            min-height: 200px;
        }

        .ranking-item {
            display: flex;
            align-items: center;
            padding: 12px 10px;
            background: rgba(245, 240, 232, 0.9);
            border-radius: var(--radius-sm);
            margin-bottom: 8px;
            border: 2px solid var(--border-light);
            transition: all var(--transition-fast);
        }

        .ranking-item:hover {
            background: rgba(245, 240, 232, 1);
            border-color: var(--border-brown);
        }

        .ranking-item.top3 {
            background: var(--accent-gold-bright);
            border-color: var(--border-brown);
        }

        .ranking-rank {
            font-size: 20px;
            font-weight: bold;
            color: var(--border-brown);
            min-width: 40px;
            text-align: center;
        }

        .ranking-item.top3 .ranking-rank {
            color: var(--text-primary);
        }

        .ranking-player {
            flex: 1;
            font-size: 16px;
            color: var(--text-primary);
            font-weight: bold;
            padding: 0 10px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .ranking-score {
            font-size: 18px;
            font-weight: bold;
            color: var(--border-brown);
        }

        .ranking-item.top3 .ranking-score {
            color: var(--text-primary);
        }

        .loading {
            text-align: center;
            padding: 40px 20px;
            font-size: 16px;
            color: var(--text-primary);
        }

        .error {
            text-align: center;
            padding: 40px 20px;
            font-size: 14px;
            color: #FF6B6B;
        }

        /* Congratulationsã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ */
        #congratsScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10003;
            animation: fadeIn var(--transition-medium) ease-out;
        }

        #congratsScreen.active {
            display: flex;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        #congratsBox {
            background: linear-gradient(135deg, #F0D898 0%, var(--accent-gold) 100%);
            padding: 30px 20px;
            border-radius: var(--radius-xl);
            text-align: center;
            position: relative;
            border: 5px solid var(--border-brown);
            animation: popIn 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            max-width: 90vw;
            box-sizing: border-box;
            box-shadow: var(--shadow-strong);
        }

        @keyframes popIn {
            0% { transform: scale(0); }
            100% { transform: scale(1); }
        }

        @keyframes spinRight {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }

        @keyframes spinLeft {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(-360deg); }
        }

        #congratsBox h1 {
            font-family: var(--font-display);
            font-size: clamp(20px, 7vw, 48px);
            font-weight: 900;
            color: var(--text-primary);
            text-shadow: 2px 2px 4px rgba(255, 255, 255, 0.5);
            margin-bottom: 15px;
            animation: pulse 1s infinite;
            line-height: 1.2;
            word-break: keep-all;
            overflow-wrap: break-word;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        #congratsFruit {
            width: clamp(120px, 40vw, 200px);
            height: clamp(120px, 40vw, 200px);
            margin: 20px auto;
            position: relative;
            animation: float 2s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(5deg); }
        }

        #congratsBonus {
            font-size: clamp(20px, 6vw, 32px);
            color: var(--text-primary);
            font-weight: bold;
            margin: 20px 0;
            text-shadow: 1px 1px 3px rgba(255, 255, 255, 0.5);
        }

        #congratsContinue {
            font-family: var(--font-display);
            font-size: clamp(16px, 4vw, 20px);
            background: var(--accent-teal);
            color: var(--text-white);
            border: none;
            padding: 15px 40px;
            border-radius: 25px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 20px;
            box-shadow: var(--shadow-soft);
            transition: all var(--transition-fast);
        }

        #congratsContinue:hover {
            background: #5A8B88;
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }

        #congratsContinue:active {
            transform: translateY(0);
        }

        #congratsFruit img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            filter: drop-shadow(0 10px 20px rgba(0, 0, 0, 0.3));
        }

        .sparkle {
            position: absolute;
            width: 10px;
            height: 10px;
            background: #FFD700;
            border-radius: 50%;
            animation: sparkle 1s ease-out forwards;
        }

        @keyframes sparkle {
            0% {
                transform: translate(0, 0) scale(0);
                opacity: 1;
            }
            100% {
                transform: translate(var(--tx), var(--ty)) scale(1);
                opacity: 0;
            }
        }

        /* ãƒ‡ãƒãƒƒã‚°ãƒœã‚¿ãƒ³ï¼ˆæ§ãˆã‚ï¼‰ */
        #debugButton {
            position: fixed;
            bottom: 10px;
            left: 10px;
            background: rgba(139, 69, 19, 0.15);
            color: rgba(139, 69, 19, 0.3);
            border: 1px solid rgba(139, 69, 19, 0.2);
            padding: 8px 12px;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s;
            z-index: 100;
        }

        #debugButton:hover {
            background: rgba(139, 69, 19, 0.25);
            color: rgba(139, 69, 19, 0.5);
        }

        /* ãƒ‡ãƒãƒƒã‚°ãƒ‘ãƒãƒ« */
        #debugPanel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 248, 230, 0.98);
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            border: 3px solid #D2691E;
            z-index: 10004;
            display: none;
        }

        #debugPanel.active {
            display: block;
        }

        #debugPanel h3 {
            font-size: 18px;
            color: #D2691E;
            margin-bottom: 15px;
            text-align: center;
        }

        #debugPanel button {
            width: 100%;
            background: var(--btn-primary);
            color: var(--text-primary);
            border: none;
            padding: 12px 20px;
            margin: 8px 0;
            border-radius: var(--radius-md);
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all var(--transition-fast);
            box-shadow: var(--shadow-minimal);
        }

        #debugPanel button:hover {
            background: var(--btn-primary-hover);
            transform: translateY(-2px);
            box-shadow: var(--shadow-soft);
        }

        #debugPanel button:active {
            transform: translateY(0);
        }

        /* debugCloseã¯çµ±ä¸€ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆä¸Šã§å®šç¾©æ¸ˆã¿ï¼‰ã§ã‚«ãƒãƒ¼ */

        /* ãƒ‡ãƒãƒƒã‚°ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å…¥åŠ› */
        #debugPasswordInput {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 2px solid #D2B48C;
            border-radius: 8px;
            font-size: 14px;
            text-align: center;
            outline: none;
        }

        #debugPasswordInput:focus {
            border-color: #D2691E;
        }

        #debugPasswordError {
            color: #dc3545;
            font-size: 12px;
            text-align: center;
            margin-top: -10px;
            margin-bottom: 10px;
            min-height: 16px;
        }

        /* éŠã³æ–¹èª¬æ˜ç”»é¢ */
        #howToPlayScreen,
        #howToPlayScreenReze,
        #howToPlayScreenGojo {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-overlay);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10002;
        }

        #howToPlayScreen.active,
        #howToPlayScreenReze.active,
        #howToPlayScreenGojo.active {
            display: flex;
        }

        #howToPlayBox {
            background: var(--bg-card);
            padding: 40px 50px;
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-strong);
            text-align: left;
            border: 3px solid var(--border-brown);
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }

        #howToPlayBox h2 {
            font-family: var(--font-display);
            font-size: 28px;
            font-weight: 900;
            color: var(--border-brown);
            margin-bottom: 20px;
            text-align: center;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }

        #howToPlayBox h3 {
            font-family: var(--font-display);
            font-size: 20px;
            font-weight: 700;
            color: var(--border-brown);
            margin-top: 20px;
            margin-bottom: 10px;
        }

        #howToPlayBox p {
            font-size: 16px;
            color: var(--text-primary);
            margin-bottom: 15px;
            line-height: 1.6;
        }

        #howToPlayBox ul {
            margin: 10px 0 15px 20px;
            color: var(--text-primary);
        }

        #howToPlayBox li {
            margin-bottom: 8px;
            line-height: 1.5;
        }

        #closeHowToPlay,
        #closeHowToPlayReze,
        #closeHowToPlayGojo {
            width: 100%;
            background: var(--btn-neutral);
            color: var(--text-primary);
            border: none;
            padding: 15px 40px;
            border-radius: var(--radius-md);
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all var(--transition-fast);
            box-shadow: var(--shadow-minimal);
            margin-top: 20px;
        }

        #closeHowToPlay:hover,
        #closeHowToPlayReze:hover,
        #closeHowToPlayGojo:hover {
            background: var(--btn-neutral-hover);
            transform: translateY(-2px);
            box-shadow: var(--shadow-soft);
        }

        #closeHowToPlay:active,
        #closeHowToPlayReze:active,
        #closeHowToPlayGojo:active {
            transform: translateY(0);
        }

        /* éŠã³æ–¹ãƒœã‚¿ãƒ³ */
        #gameContainer {
            position: relative;
            width: 100%;
            max-width: 600px;
            margin: 20px auto;
            min-height: 100vh;
            display: none;
            flex-direction: column;
            align-items: center;
            padding: 10px;
            gap: 8px;
            box-sizing: border-box;
        }
        
        #gameContainer.active {
            display: flex;
        }

        #topPanel {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 6px;
            width: 100%;
            max-width: 500px;
            flex-shrink: 0;
            z-index: 10;
        }

        .info-bubble {
            background: rgba(255, 248, 230, 0.95);
            border-radius: 15px;
            width: 140px;
            height: 100px;
            padding: 8px 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(139, 69, 19, 0.3);
            border: 3px solid rgba(255, 255, 255, 0.5);
            flex-shrink: 0;
            gap: 3px;
            box-sizing: border-box;
        }

        .info-label {
            font-size: 11px;
            color: #8B4513;
            font-weight: bold;
        }

        .info-value {
            font-size: 20px;
            font-weight: bold;
            color: #D2691E;
            line-height: 1;
        }

        .score-divider {
            width: 80%;
            height: 1px;
            background: rgba(139, 69, 19, 0.2);
            margin: 2px 0;
        }

        .best-score-label {
            font-size: 10px;
            color: #8B4513;
            font-weight: bold;
            line-height: 1;
        }
        }

        .best-score-value {
            font-size: 16px;
            font-weight: bold;
            color: #D2691E;
            opacity: 0.8;
        }

        #nextBall {
            background: rgba(255, 248, 230, 0.95);
            border-radius: 50%;
            width: 100px;
            height: 100px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(139, 69, 19, 0.3);
            border: 3px solid rgba(255, 255, 255, 0.5);
            flex-shrink: 0;
        }

        #gameRestartButton {
            background: var(--accent-teal);
            border-radius: var(--radius-md);
            padding: 8px 12px;
            font-size: 12px;
            font-weight: bold;
            color: var(--text-white);
            cursor: pointer;
            box-shadow: var(--shadow-soft);
            border: none;
            transition: all var(--transition-fast);
            white-space: nowrap;
            flex-shrink: 0;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #gameRestartButton:hover {
            background: #5A8B88;
            transform: translateY(-1px);
            box-shadow: var(--shadow-medium);
        }

        #gameRestartButton:active {
            transform: translateY(0);
        }

        #controlButtons {
            display: flex;
            gap: 6px;
            flex-shrink: 0;
            height: 100px;
        }

        #rightButtons {
            display: flex;
            flex-direction: column;
            gap: 4px;
            height: 100%;
        }

        #seToggleButton {
            background: var(--btn-neutral);
            border-radius: var(--radius-md);
            padding: 6px;
            font-size: 12px;
            font-weight: bold;
            color: var(--text-primary);
            cursor: pointer;
            box-shadow: var(--shadow-soft);
            border: none;
            transition: all var(--transition-fast);
            flex-shrink: 0;
            line-height: 1.3;
            text-align: center;
            height: 48px;
            width: 60px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        #seToggleButton:hover {
            background: var(--btn-neutral-hover);
            transform: translateY(-1px);
            box-shadow: var(--shadow-medium);
        }

        #seToggleButton:active {
            transform: translateY(0);
        }

        #seToggleButton.on {
            background: var(--accent-teal);
            color: var(--text-white);
        }

        #seToggleButton.on:hover {
            background: #5A8B88;
        }

        #seToggleImage {
            width: 70%;
            height: 70%;
            object-fit: contain;
        }

        #howToPlayButton {
            background: var(--btn-neutral);
            border-radius: var(--radius-md);
            padding: 6px;
            font-size: 12px;
            font-weight: bold;
            color: var(--text-primary);
            cursor: pointer;
            box-shadow: var(--shadow-soft);
            border: none;
            transition: all var(--transition-fast);
            flex-shrink: 0;
            line-height: 1.3;
            text-align: center;
            height: 48px;
            width: 60px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        #howToPlayButton:hover {
            background: var(--btn-neutral-hover);
            transform: translateY(-1px);
            box-shadow: var(--shadow-medium);
        }

        #howToPlayButton:active {
            transform: translateY(0);
        }

        #nextBall h3 {
            font-size: 12px;
            color: #8B4513;
            margin-bottom: 5px;
            font-weight: bold;
        }

        #nextPreview {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        #nextPreview img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        #gameArea {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            max-width: 500px;
            gap: 5px;
            min-height: 0;
            overflow: hidden;
        }

        #canvasWrapper {
            position: relative;
            width: 100%;
            aspect-ratio: 1 / 1.1;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
        }

        #gameCanvas {
            border-radius: 10px;
            box-shadow: 
                0 8px 20px rgba(0,0,0,0.2),
                inset 0 2px 5px rgba(255,255,255,0.5);
            border: 3px solid #D2B48C;
            cursor: pointer;
            touch-action: none;
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        #sinkaBar {
            position: relative;
            width: 100%;
            background: rgba(255, 248, 230, 0.95);
            border-radius: 10px;
            padding: 3px;
            box-shadow: 0 4px 15px rgba(139, 69, 19, 0.3);
            border: 3px solid rgba(255, 255, 255, 0.5);
            flex-shrink: 1;
            min-height: 0;
        }

        #tapSafeZone {
            width: 100%;
            height: 90px;
            background: rgba(255, 248, 230, 0.95);
            border: 2px dashed rgba(76, 175, 80, 0.5);
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            color: rgba(76, 175, 80, 0.9);
            font-weight: bold;
            margin: 5px 0;
            user-select: none;
            box-shadow: 0 2px 8px rgba(139, 69, 19, 0.2);
            cursor: pointer;
        }

        #sinkaBar h3 {
            font-size: 11px;
            color: #8B4513;
            text-align: center;
            margin-bottom: 2px;
            font-weight: bold;
            position: relative;
            z-index: 1;
        }

        #sinkaBarImage {
            width: 100%;
            display: block;
            line-height: 0;
        }

        #sinkaBarImage img {
            width: 100%;
            height: auto;
            display: block;
        }

        .placeholder-text {
            font-size: 12px;
            color: #8B4513;
            opacity: 0.5;
            text-align: center;
        }

        #gameOver {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 248, 230, 0.98);
            padding: 40px 60px;
            border-radius: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.4);
            text-align: center;
            display: none;
            pointer-events: all;
            border: 3px solid #D2691E;
            z-index: 1000;
            min-width: 350px;
            white-space: nowrap;
        }

        #gameOver h2 {
            font-size: 28px;
            color: #D2691E;
            margin-bottom: 15px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
            white-space: nowrap;
        }

        #gameOver p {
            font-size: 18px;
            color: #8B4513;
            margin-bottom: 25px;
            white-space: nowrap;
        }

        #restartBtn {
            background: var(--btn-neutral);
            color: var(--text-primary);
            border: none;
            padding: 12px 35px;
            border-radius: 30px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all var(--transition-fast);
            box-shadow: var(--shadow-soft);
            white-space: nowrap;
        }

        #restartBtn:hover {
            background: var(--btn-neutral-hover);
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }

        #restartBtn:active {
            transform: scale(0.95);
        }

        .game-line {
            position: absolute;
            left: 10px;
            right: 10px;
            height: 2px;
            background: rgba(255, 107, 107, 0.6);
            pointer-events: none;
            z-index: 10;
            border-style: dashed;
        }

        @media (max-width: 768px) {
            #gameContainer {
                padding: 8px;
                gap: 6px;
            }
            
            #topPanel {
                gap: 6px;
            }
            
            #nextBall {
                width: 85px;
                height: 85px;
            }
            
            .info-label {
                font-size: 11px;
            }
            
            .info-value {
                font-size: 20px;
            }
            
            #nextPreview {
                width: 50px;
                height: 50px;
            }
            
            /* ã‚·ãƒ³ã‚«ã®æ£’ã‚’å°ã•ãè¡¨ç¤º */
            #sinkaBar {
                padding: 8px;
                border-radius: 8px;
            }
            
            #sinkaBar h3 {
                font-size: 11px;
                margin-bottom: 5px;
            }
        }

        @media (max-width: 480px) {
            #gameContainer {
                padding: 6px;
                gap: 5px;
            }
            
            #topPanel {
                gap: 5px;
            }
            
            #nextBall {
                width: 75px;
                height: 75px;
            }
            
            .info-label, #nextBall h3 {
                font-size: 10px;
            }
            
            .info-value {
                font-size: 18px;
            }
            
            .best-score-label {
                font-size: 8px;
            }
            
            #nextPreview {
                width: 42px;
                height: 42px;
            }
            
            #gameRestartButton {
                padding: 6px 12px;
                font-size: 12px;
            }
            
            #sinkaBar h3 {
                font-size: 10px;
                margin-bottom: 2px;
            }
        }
        
        /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢ã®ã‚¹ãƒ”ãƒ³ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Congratulationsç”»é¢ -->
    <div id="congratsScreen">
        <div id="congratsBox">
            <h1>ğŸ‰ Congratulations! ğŸ‰</h1>
            <div id="congratsFruit">
                <img src="images/fruit_10.png" alt="Maximum Fruit">
            </div>
            <div id="congratsBonus">ãƒœãƒ¼ãƒŠã‚¹: +5000ç‚¹</div>
            <button id="congratsContinue">ã‚²ãƒ¼ãƒ ã‚’ç¶šã‘ã‚‹</button>
        </div>
    </div>

    <!-- éŠã³æ–¹èª¬æ˜ç”»é¢ - é€šå¸¸ -->
    <div id="howToPlayScreen">
        <div id="howToPlayBox">
            <h2>ğŸ“– éŠã³æ–¹</h2>
            
            <h3>ğŸ¯ ã‚²ãƒ¼ãƒ ã®ç›®çš„</h3>
            <p>åŒã˜ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’åˆä½“ã•ã›ã¦ã€ã‚ˆã‚Šå¤§ããªã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’ä½œã‚Šã¾ã—ã‚‡ã†ï¼</p>
            
            <h3>ğŸ® æ“ä½œæ–¹æ³•</h3>
            
            <p><strong>ğŸ“± ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆãƒ»ã‚¹ãƒãƒ›ã®å ´åˆï¼š</strong></p>
            <ul>
                <li>ç”»é¢ã‚’ã‚¿ãƒƒãƒ—ã™ã‚‹ã¨ãƒœãƒ¼ãƒ«ãŒå‡ºç¾</li>
                <li>æŒ‡ã‚’å·¦å³ã«å‹•ã‹ã—ã¦ãƒœãƒ¼ãƒ«ã‚’ç§»å‹•</li>
                <li>æŒ‡ã‚’é›¢ã™ã¨ãƒœãƒ¼ãƒ«ãŒè½ä¸‹</li>
            </ul>
            
            <p><strong>ğŸ–±ï¸ PCã®å ´åˆï¼š</strong></p>
            <ul>
                <li>ãƒã‚¦ã‚¹ã‚’å·¦å³ã«å‹•ã‹ã—ã¦ãƒœãƒ¼ãƒ«ã‚’ç§»å‹•</li>
                <li>ã‚¯ãƒªãƒƒã‚¯ã§ãƒœãƒ¼ãƒ«ãŒè½ä¸‹</li>
            </ul>
            
            <h3>âœ¨ ãƒ«ãƒ¼ãƒ«</h3>
            <ul>
                <li>åŒã˜ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼åŒå£«ãŒè§¦ã‚Œã‚‹ã¨åˆä½“</li>
                <li>åˆä½“ã™ã‚‹ã¨ã‚¹ã‚³ã‚¢ãŒå¢—ãˆã‚‹</li>
                <li>èµ¤ã„ç·šã‚’è¶…ãˆã‚‹ã¨ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼</li>
            </ul>
            
            <button id="closeHowToPlay">é–‰ã˜ã‚‹</button>
        </div>
    </div>

    <!-- éŠã³æ–¹èª¬æ˜ç”»é¢ - ãƒ¬ã‚¼ç¯‡ -->
    <div id="howToPlayScreenReze">
        <div id="howToPlayBox">
            <h2>ğŸ“– éŠã³æ–¹ - ãƒ¬ã‚¼ç¯‡</h2>
            
            <h3>ğŸ® åŸºæœ¬æ“ä½œ</h3>
            <p>é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ã¨åŒã˜æ“ä½œã§ãƒœãƒ¼ãƒ«ã‚’é…ç½®ã—ã¾ã™</p>
            
            <h3>ğŸ’£ ãƒœãƒ ã®ç‰¹åˆ¥ãƒ«ãƒ¼ãƒ«</h3>
            <div style="background: rgba(255, 248, 230, 0.5); padding: 15px; border-radius: 10px; margin: 10px 0;">
                <p><strong>ãƒœãƒ ã®ä½¿ã„æ–¹ï¼š</strong></p>
                <div style="display: flex; align-items: center; gap: 10px; margin: 10px 0;">
                    <img src="images/bakudan_dynamite.png" style="width: 60px; height: 60px; object-fit: contain;">
                    <span style="font-size: 24px;">â†’</span>
                    <img src="images/fruit_4.png" style="width: 50px; height: 50px; object-fit: contain;">
                    <span style="font-size: 16px;">ä»¥ä¸‹ã‚’æ¶ˆå»</span>
                </div>
                <ul style="margin-top: 10px;">
                    <li>ãƒœãƒ ã¯10å›ã«1å›ç¨‹åº¦ã®ç¢ºç‡ã§å‡ºç¾</li>
                    <li><strong>ãƒœãƒ ã‚’ã‚¿ãƒƒãƒ—/ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨çˆ†ç™º</strong></li>
                    <li>å‘¨å›²ã®ä¸€å®šç¯„å›²ã®ãƒœãƒ¼ãƒ«ã‚’æ¶ˆã™</li>
                    <li>æ¶ˆã—ãŸãƒœãƒ¼ãƒ«ã®ã‚¹ã‚³ã‚¢ã‚’ç²å¾—</li>
                    <li>ãƒœãƒ åŒå£«ãƒ»ãƒœãƒ ã¨ä»–ã®ãƒœãƒ¼ãƒ«ã¯åˆä½“ã—ãªã„</li>
                </ul>
            </div>
            
            <button id="closeHowToPlayReze">é–‰ã˜ã‚‹</button>
        </div>
    </div>

    <!-- éŠã³æ–¹èª¬æ˜ç”»é¢ - äº”æ¡ç¯‡ -->
    <div id="howToPlayScreenGojo">
        <div id="howToPlayBox">
            <h2>ğŸ“– éŠã³æ–¹ - äº”æ¡ç¯‡</h2>
            
            <h3>ğŸ® åŸºæœ¬æ“ä½œ</h3>
            <p>é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ã¨åŒã˜æ“ä½œã§ãƒœãƒ¼ãƒ«ã‚’é…ç½®ã—ã¾ã™</p>
            
            <h3>âš¡ è¡“å¼ã®ç‰¹åˆ¥ãƒ«ãƒ¼ãƒ«</h3>
            
            <div style="background: rgba(255, 248, 230, 0.5); padding: 15px; border-radius: 10px; margin: 10px 0;">
                <p><strong>ğŸ”´ åè»¢ã€Œèµ«ã€ï¼š</strong></p>
                <div style="display: flex; align-items: center; gap: 10px; margin: 10px 0;">
                    <img src="images/Go_aka.png" style="width: 60px; height: 60px; object-fit: contain;">
                    <span style="font-size: 24px;">â†’</span>
                    <img src="images/fruit_4.png" style="width: 50px; height: 50px; object-fit: contain;">
                    <span style="font-size: 16px;">ä»¥ä¸‹ã‚’æ¶ˆå»</span>
                </div>
                <p style="font-size: 14px; margin: 5px 0 0 0;">ã‚¿ãƒƒãƒ—ã§å‘¨å›²ã®ãƒœãƒ¼ãƒ«ã‚’æ¶ˆå»</p>
            </div>
            
            <div style="background: rgba(248, 248, 255, 0.5); padding: 15px; border-radius: 10px; margin: 10px 0;">
                <p><strong>ğŸ”µ é †è»¢ã€Œè’¼ã€ï¼š</strong></p>
                <div style="display: flex; align-items: center; gap: 10px; margin: 10px 0;">
                    <img src="images/Go_ao.png" style="width: 60px; height: 60px; object-fit: contain;">
                    <span style="font-size: 24px;">â†’</span>
                    <img src="images/fruit_4.png" style="width: 50px; height: 50px; object-fit: contain;">
                    <span style="font-size: 16px;">ä»¥ä¸‹ã‚’æ¶ˆå»</span>
                </div>
                <p style="font-size: 14px; margin: 5px 0 0 0;">ã‚¿ãƒƒãƒ—ã§å‘¨å›²ã®ãƒœãƒ¼ãƒ«ã‚’æ¶ˆå»</p>
            </div>
            
            <div style="background: rgba(255, 240, 255, 0.5); padding: 15px; border-radius: 10px; margin: 10px 0;">
                <p><strong>ğŸŸ£ è™šå¼ã€ŒèŒˆã€ï¼š</strong></p>
                <div style="display: flex; align-items: center; gap: 10px; margin: 10px 0;">
                    <img src="images/Go_aka.png" style="width: 50px; height: 50px; object-fit: contain;">
                    <span style="font-size: 24px;">+</span>
                    <img src="images/Go_ao.png" style="width: 50px; height: 50px; object-fit: contain;">
                    <span style="font-size: 24px;">â†’</span>
                    <img src="images/Go_murasaki.png" style="width: 60px; height: 60px; object-fit: contain;">
                </div>
                <ul style="margin-top: 10px;">
                    <li><strong>åè»¢ã€Œèµ«ã€ã¨é †è»¢ã€Œè’¼ã€ãŒæ¥è§¦ã™ã‚‹ã¨è™šå¼ã€ŒèŒˆã€ã«å¤‰åŒ–</strong></li>
                    <li><strong>è™šå¼ã€ŒèŒˆã€ã‚’ã‚¿ãƒƒãƒ—ã™ã‚‹ã¨è¶…åºƒç¯„å›²ã‚’æ¶ˆå»</strong></li>
                    <li style="display: flex; align-items: center; gap: 5px; margin-top: 10px;">
                        <img src="images/Go_murasaki.png" style="width: 50px; height: 50px; object-fit: contain;">
                        <span style="font-size: 20px;">â†’</span>
                        <img src="images/fruit_4.png" style="width: 40px; height: 40px; object-fit: contain;">
                        <span style="font-size: 14px;">ä»¥ä¸‹ã‚’è¶…åºƒç¯„å›²ã§æ¶ˆå»</span>
                    </li>
                </ul>
            </div>
            
            <p style="margin-top: 15px;"><strong>âš ï¸ æ³¨æ„ï¼š</strong></p>
            <ul>
                <li>è¡“å¼ãƒœãƒ¼ãƒ«ã¯é€šå¸¸ã®ãƒœãƒ¼ãƒ«ã¨åˆä½“ã—ãªã„</li>
                <li>æ¶ˆã—ãŸãƒœãƒ¼ãƒ«ã®ã‚¹ã‚³ã‚¢ã‚’ç²å¾—</li>
            </ul>
            
            <button id="closeHowToPlayGojo">é–‰ã˜ã‚‹</button>
        </div>
    </div>

    <!-- é›£æ˜“åº¦é¸æŠç”»é¢ -->
    <div id="difficultyScreen">
        <div id="difficultyBox">
            <h2>ãƒ¢ãƒ¼ãƒ‰ã‚’é¸æŠ</h2>
            <button class="difficulty-button" id="normalButton">ãƒãƒ¼ãƒãƒ«</button>
            <p class="difficulty-description">æ¨™æº–ã®é›£æ˜“åº¦</p>
            <button class="difficulty-button" id="easyButton">ã‚„ã•ã—ã„</button>
            <p class="difficulty-description">ãƒœãƒ¼ãƒ«ãŒ0.7å€ã®ã‚µã‚¤ã‚º</p>
            <button class="difficulty-button" id="rezeButton">ãƒ¬ã‚¼ç¯‡</button>
            <p class="difficulty-description">ãƒ‡ãƒ³ã‚¸å›ã®å¿ƒè‡“ è²°ã†ã­ï¼Ÿ</p>
            <button class="difficulty-button" id="gojoButton">äº”æ¡ç¯‡</button>
            <p class="difficulty-description">å¤§ä¸ˆå¤« åƒ• æœ€å¼·ã ã‹ã‚‰</p>
            <div style="margin-top: 40px;"></div>
            <button class="difficulty-button green" id="highScoreButton">ãƒã‚¤ã‚¹ã‚³ã‚¢ä¸€è¦§</button>
            <button class="difficulty-button green" id="rankingButton">ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ©ãƒ³ã‚­ãƒ³ã‚°</button>
            <button class="difficulty-button green" id="newsButton">ãŠçŸ¥ã‚‰ã›</button>
        </div>
        <div id="versionLabel">v.5.8</div>
    </div>

    <!-- åˆå›ãƒ©ãƒ³ã‚­ãƒ³ã‚°å‚åŠ ç¢ºèªç”»é¢ -->
    <div id="rankingConfirmScreen" class="modal-screen" style="display: none;">
        <div class="modal-content" style="max-width: 400px;">
            <h2>ğŸ“Š ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h2>
            <p style="margin: 20px 0; line-height: 1.6;">
                å…¨å›½ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¨ã‚¹ã‚³ã‚¢ã‚’ç«¶ã„ã¾ã™ã‹ï¼Ÿ<br>
                <span style="font-size: 12px; color: var(--text-secondary);">â€»å¾Œã‹ã‚‰è¨­å®šå¤‰æ›´ã§ãã¾ã™</span>
            </p>
            <div style="display: flex; gap: 10px; margin-top: 30px;">
                <button id="rankingYesButton" style="flex: 1; background: var(--btn-primary); color: white; border: none; padding: 15px; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer;">å‚åŠ ã™ã‚‹</button>
                <button id="rankingNoButton" style="flex: 1; background: var(--btn-neutral); color: var(--text-primary); border: none; padding: 15px; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer;">å‚åŠ ã—ãªã„</button>
            </div>
        </div>
    </div>

    <!-- ãƒã‚¤ã‚¹ã‚³ã‚¢ä¸€è¦§ç”»é¢ -->
    <div id="highScoreScreen" class="modal-screen">
        <div id="highScoreBox" class="modal-box">
            <h2>ğŸ“Š ãƒã‚¤ã‚¹ã‚³ã‚¢ä¸€è¦§</h2>
            
            <!-- ãƒ©ãƒ³ã‚­ãƒ³ã‚°é€ä¿¡ãƒˆã‚°ãƒ« -->
            <div style="text-align: center; margin-bottom: 15px;">
                <button id="rankingToggleButton" style="background: var(--btn-primary); color: white; border: none; padding: 8px 20px; border-radius: 8px; font-size: 14px; font-weight: bold; cursor: pointer;">
                    ãƒ©ãƒ³ã‚­ãƒ³ã‚°é€ä¿¡: ON
                </button>
                <p style="font-size: 10px; color: var(--text-secondary); margin: 5px 0 0 0;">â€»OFFã«ã™ã‚‹ã¨ã‚¹ã‚³ã‚¢ã¯ã“ã®ç«¯æœ«ã«ã®ã¿ä¿å­˜ã•ã‚Œã¾ã™</p>
            </div>
            
            <div id="playerNameContainer" style="margin-bottom: 8px; text-align: center;">
                <div id="playerNameDisplay" style="display: none; padding: 10px; background: rgba(255, 248, 230, 0.8); border-radius: 10px; text-align: center; font-weight: bold; color: #D2691E; font-size: 16px; cursor: pointer;"></div>
                <div id="playerNameInputContainer" style="display: none;">
                    <input type="text" id="playerNameInput" maxlength="10" placeholder="åå‰ã‚’å…¥åŠ›" style="padding: 8px; border: 2px solid #D2691E; border-radius: 5px; font-size: 14px; text-align: center; width: 200px;">
                </div>
            </div>
            <div style="text-align: center; margin-bottom: 15px;">
                <p style="font-size: 10px; color: #8B4513; opacity: 0.7; margin: 0; line-height: 1.5;">â€»ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤ºåã«åæ˜ ã•ã‚Œã¾ã™ã€‚<br>â€»ãƒãƒ¼ãƒ ã‚’ã‚¿ãƒƒãƒ—ã™ã‚‹ã¨å¤‰æ›´ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚</p>
            </div>
            <div id="highScoreList">
                <div class="high-score-section">
                    <h3>é€šå¸¸é›£æ˜“åº¦</h3>
                    <div class="high-score-item">
                        <span class="difficulty-name">ãƒãƒ¼ãƒãƒ«</span>
                        <span class="score-value" id="highScore_normal">0</span>
                    </div>
                    <div class="high-score-item">
                        <span class="difficulty-name">ã‚„ã•ã—ã„</span>
                        <span class="score-value" id="highScore_easy">0</span>
                    </div>
                </div>
                <div class="high-score-divider"></div>
                <div class="high-score-section">
                    <h3>ç‰¹åˆ¥ç·¨</h3>
                    <div class="high-score-item">
                        <span class="difficulty-name">ãƒ¬ã‚¼ç¯‡</span>
                        <span class="score-value" id="highScore_reze">0</span>
                    </div>
                    <div class="high-score-item">
                        <span class="difficulty-name">äº”æ¡ç¯‡</span>
                        <span class="score-value" id="highScore_gojo">0</span>
                    </div>
                </div>
            </div>
            <button id="syncToRanking" style="width: 100%; background: var(--accent-gold); color: var(--text-primary); border: none; padding: 12px; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer; margin-bottom: 10px; box-shadow: var(--shadow-minimal);">ğŸ† ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã«åæ˜ </button>
            <button id="closeHighScore">é–‰ã˜ã‚‹</button>
        </div>
    </div>

    <!-- ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ©ãƒ³ã‚­ãƒ³ã‚°ç”»é¢ -->
    <div id="rankingScreen" class="modal-screen">
        <div id="rankingBox" class="modal-box">
            <h2>ğŸ† ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h2>
            <div style="display: flex; gap: 8px; margin-bottom: 15px;">
                <button class="ranking-type-btn active" data-type="normal" style="flex: 1; padding: 10px; background: var(--border-brown); color: white; border: none; border-radius: 8px; font-size: 14px; font-weight: bold; cursor: pointer;">ã‚ªãƒ¼ãƒ«ã‚¿ã‚¤ãƒ </button>
                <button class="ranking-type-btn" data-type="event" style="flex: 1; padding: 10px; background: rgba(139, 111, 71, 0.2); color: var(--text-primary); border: 2px solid var(--border-brown); border-radius: 8px; font-size: 12px; font-weight: bold; cursor: pointer; line-height: 1.3;">å¸¸è¨­ã€Œå¹»æƒ‘ã®æµ·åŸŸã€<br>(22:00~2:00)</button>
            </div>
            <div id="rankingModeSelect">
                <button class="ranking-mode-btn active" data-mode="normal">ãƒãƒ¼ãƒãƒ«</button>
                <button class="ranking-mode-btn" data-mode="easy">ã‚„ã•ã—ã„</button>
                <button class="ranking-mode-btn" data-mode="reze">ãƒ¬ã‚¼ç¯‡</button>
                <button class="ranking-mode-btn" data-mode="gojo">äº”æ¡ç¯‡</button>
            </div>
            <div id="rankingList">
                <div class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>
            </div>
            <p style="font-size: 10px; color: #8B4513; opacity: 0.7; text-align: center; margin: 8px 0;">â€»é€šå¸¸ã¯5åˆ†ã”ã¨ã«èª­ã¿è¾¼ã¿æ›´æ–°ã—ã¦ã„ã¾ã™ã€‚<br>ã‚¤ãƒ™ãƒ³ãƒˆã¯ç‰¹å®šæ™‚é–“ã®ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã§ã€æ¯æ—¥æ›´æ–°ã•ã‚Œã¾ã™ã€‚</p>
            <div style="display: flex; gap: 10px;">
                <button id="refreshRanking" style="flex: 1; background: #B8D4C8; color: #4A6B5C; border: 2px solid #8BA99E; padding: 10px; border-radius: 8px; font-size: 14px; font-weight: bold; cursor: pointer;">è¡¨ç¤ºæ›´æ–°</button>
                <button id="closeRanking" style="flex: 1; background: var(--btn-neutral); color: var(--text-primary); border: none; padding: 10px; border-radius: 8px; font-size: 14px; font-weight: bold; cursor: pointer;">é–‰ã˜ã‚‹</button>
            </div>
        </div>
    </div>

    <!-- ãŠçŸ¥ã‚‰ã›ç”»é¢ -->
    <div id="newsScreen" class="modal-screen">
        <div id="newsBox" class="modal-box">
            <button id="closeNewsX" style="position: absolute; top: 15px; right: 15px; background: transparent; border: none; font-size: 28px; color: #D2691E; cursor: pointer; padding: 0; width: 40px; height: 40px; line-height: 40px;">Ã—</button>
            <h2>ğŸ“¢ ãŠçŸ¥ã‚‰ã›</h2>
            <div id="newsList">
                <div class="news-item">
                    <h3>v5.8 ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆ</h3>
                    <ul>
                        <li>â–  ã‚¢ã‚¤ã‚³ãƒ³è¨­å®šã‚’è¿½åŠ </li>
                        <li>ãƒ»ãƒ–ãƒ©ã‚¦ã‚¶ã‚¿ãƒ–ã«ã‚¢ã‚¤ã‚³ãƒ³ãŒè¡¨ç¤º</li>
                        <li>ãƒ»ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã—ãŸéš›ã®ã‚¢ã‚¤ã‚³ãƒ³ã‚’è¨­å®š</li>
                        <li>â–  ãƒã‚°ä¿®æ­£</li>
                        <li>ãƒ»åŠé€æ˜ãƒœãƒ¼ãƒ«ãŒæ®‹ã‚‹å•é¡Œã‚’ä¿®æ­£</li>
                        <li>ãƒ»å®šæœŸçš„ã«æ®‹éª¸ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã‚’å®Ÿè¡Œ</li>
                    </ul>
                </div>
                <div class="news-item">
                    <h3>v5.7 ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆ</h3>
                    <ul>
                        <li>â–  ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°æ©Ÿèƒ½ã®å®Ÿè£…</li>
                        <li>ãƒ»èµ·å‹•æ™‚ã®èª­ã¿è¾¼ã¿ç”»é¢ã‚’è¿½åŠ </li>
                        <li>ãƒ»ãƒ¢ãƒã‚¤ãƒ«ã§ã®åˆå›å‹•ä½œã‚’æ”¹å–„</li>
                        <li>â–  ãƒã‚°ä¿®æ­£</li>
                        <li>ãƒ»ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã®ã‚¤ãƒ™ãƒ³ãƒˆæ™‚é–“ã‚’ä¿®æ­£</li>
                    </ul>
                </div>
                <div class="news-item">
                    <h3>v5.6 ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆ</h3>
                    <ul>
                        <li>â–  ã‚µã‚¦ãƒ³ãƒ‰æ©Ÿèƒ½ã®å®Ÿè£…</li>
                        <li>ãƒ»ãƒœãƒ¼ãƒ«è½ä¸‹éŸ³ã€åˆä½“éŸ³ã€ãƒœãƒ çˆ†ç™ºéŸ³ã‚’è¿½åŠ </li>
                        <li>ãƒ»ã‚²ãƒ¼ãƒ ç”»é¢å³ä¸Šã®ãƒœã‚¿ãƒ³ã§åŠ¹æœéŸ³ã®ON/OFFåˆ‡ã‚Šæ›¿ãˆå¯èƒ½</li>
                        <li>â–  UIæ”¹å–„</li>
                        <li>ãƒ»ä¸Šéƒ¨ãƒœã‚¿ãƒ³é…ç½®ã‚’æœ€é©åŒ–ï¼ˆãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œï¼‰</li>
                    </ul>
                </div>
                <div class="news-item">
                    <h3>v5.5 ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆ</h3>
                    <ul>
                        <li>â–  ãƒ‡ã‚¶ã‚¤ãƒ³ã®å¤§å¹…ãƒªãƒ‹ãƒ¥ãƒ¼ã‚¢ãƒ«</li>
                        <li>ãƒ»æš—ã„é’ç·‘ã®èƒŒæ™¯ã§è½ã¡ç€ã„ãŸå°è±¡ã«</li>
                        <li>ãƒ»å…¨ãƒœã‚¿ãƒ³ã‚’çµ±ä¸€ãƒ‡ã‚¶ã‚¤ãƒ³ã«</li>
                        <li>â–  ãƒã‚°ä¿®æ­£</li>
                        <li>ãƒ»ãƒ¬ã‚¼ç¯‡ã§ãƒœãƒ ãŒçˆ†ç™ºã—ãªã„å•é¡Œã‚’ä¿®æ­£</li>
                    </ul>
                </div>
                <div class="news-item">
                    <h3>v5.4 ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆ</h3>
                    <ul>
                        <li>ğŸ“¢ ãŠçŸ¥ã‚‰ã›æ©Ÿèƒ½ã‚’è¿½åŠ </li>
                        <li>ğŸ”” åˆå›èµ·å‹•æ™‚ã«è‡ªå‹•è¡¨ç¤º</li>
                        <li>ğŸ“ ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã”ã¨ã®æ—¢èª­ç®¡ç†</li>
                    </ul>
                </div>
                <div class="news-item">
                    <h3>v5.3 ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆ</h3>
                    <ul>
                        <li>ğŸ”´ èµ¤ãƒœãƒ¼ãƒ«ã®å¼¾ãå‡ºã—æ¼”å‡ºã‚’è¿½åŠ </li>
                        <li>ğŸ”µ é’ãƒœãƒ¼ãƒ«ã®å¸ã„è¾¼ã¿æ¼”å‡ºã‚’è¿½åŠ </li>
                        <li>ğŸµ ç´«ãƒœãƒ¼ãƒ«ã®åŠ¹æœéŸ³ã‚’è¿½åŠ ï¼ˆiOSå¯¾å¿œï¼‰</li>
                    </ul>
                </div>
                <div class="news-item">
                    <h3>v5.2 ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆ</h3>
                    <ul>
                        <li>ğŸµ ç´«ãƒœãƒ¼ãƒ«çˆ†ç™ºæ™‚ã®åŠ¹æœéŸ³ã‚’å®Ÿè£…</li>
                        <li>ğŸ”Š éŸ³é‡ã‚’30%ã«èª¿æ•´</li>
                    </ul>
                </div>
                <div class="news-item">
                    <h3>v5.1 ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆ</h3>
                    <ul>
                        <li>ğŸŒŠ å¸¸è¨­ã‚¤ãƒ™ãƒ³ãƒˆã€Œå¹»æƒ‘ã®æµ·åŸŸã€æº–å‚™ä¸­</li>
                        <li>ğŸ“Š ã‚¤ãƒ™ãƒ³ãƒˆãƒ©ãƒ³ã‚­ãƒ³ã‚°æ©Ÿèƒ½ã‚’è¿½åŠ </li>
                    </ul>
                </div>
                <div class="news-item">
                    <h3>v5.0 ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆ</h3>
                    <ul>
                        <li>ğŸ† ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ©ãƒ³ã‚­ãƒ³ã‚°æ©Ÿèƒ½ã‚’å®Ÿè£…</li>
                        <li>ğŸ“± ç«¯æœ«åˆ¥ã‚¹ã‚³ã‚¢ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </li>
                        <li>ğŸ¯ ãƒã‚¤ã‚¹ã‚³ã‚¢ä¸€æ‹¬åæ˜ æ©Ÿèƒ½</li>
                    </ul>
                </div>
            </div>
            <button id="closeNews">é–‰ã˜ã‚‹</button>
        </div>
    </div>

    <!-- ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ -->
    <div id="startScreen">
        <div id="startBox">
            <button id="startButton">ã‚²ãƒ¼ãƒ é–‹å§‹</button>
        </div>
    </div>

    <div id="gameContainer">
        <div id="topPanel">
            <div class="info-bubble">
                <span class="info-value" id="scoreValue" style="font-size: 14px;">ã‚¹ã‚³ã‚¢ï¼š000000</span>
                <span class="best-score-label" id="bestScoreValue" style="font-size: 11px; white-space: nowrap;">Best: 000000</span>
            </div>
            <div id="nextBall">
                <h3>ãƒã‚¯ã‚¹ãƒˆ</h3>
                <div id="nextPreview"></div>
            </div>
            <div id="controlButtons">
                <button id="gameRestartButton">ãƒªã‚¹ã‚¿ãƒ¼ãƒˆ</button>
                <div id="rightButtons">
                    <button id="seToggleButton" class="on">
                        <img id="seToggleImage" src="images/SE_ON.png" alt="SE ON">
                    </button>
                    <button id="howToPlayButton">éŠã³æ–¹<br>ãƒ«ãƒ¼ãƒ«</button>
                </div>
            </div>
        </div>
        <div id="gameArea">
            <div id="canvasWrapper">
                <canvas id="gameCanvas"></canvas>
                <div class="game-line"></div>
                <div id="gameOver">
                    <h2>ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼</h2>
                    <p>ã‚¹ã‚³ã‚¢: <span id="finalScore">0</span></p>
                    <button id="restartBtn">ãƒªã‚¹ã‚¿ãƒ¼ãƒˆ</button>
                </div>
            </div>
            <div id="tapSafeZone">â† ã‚¿ãƒƒãƒ—/ã‚¯ãƒªãƒƒã‚¯å®‰å…¨ç§»å‹•ã‚¨ãƒªã‚¢ â†’</div>
            <div id="sinkaBar">
                <div id="sinkaBarImage">
                    <span class="placeholder-text">ç”»åƒã‚’é…ç½®</span>
                </div>
            </div>
        </div>
    </div>

    <!-- äº”æ¡ç¯‡ ç´«ãƒœãƒ¼ãƒ«åŠ¹æœéŸ³ -->
    <audio id="specialSound" preload="auto">
        <source src="sound/special.mp3" type="audio/mpeg">
    </audio>
    
    <audio id="dropSound" preload="auto">
        <source src="sound/drop.mp3" type="audio/mpeg">
    </audio>
    
    <audio id="mergeSound" preload="auto">
        <source src="sound/merge.mp3" type="audio/mpeg">
    </audio>
    
    <audio id="bombSound" preload="auto">
        <source src="sound/bomb.mp3" type="audio/mpeg">
    </audio>

    <!-- ãƒ‡ãƒãƒƒã‚°ãƒœã‚¿ãƒ³ï¼ˆå·¦ä¸‹ï¼‰ -->
    <button id="debugButton">ğŸ”§</button>

    <!-- ãƒ‡ãƒãƒƒã‚°ãƒ‘ãƒãƒ« -->
    <div id="debugPanel">
        <h3>ğŸ”§ ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰</h3>
        <input type="password" id="debugPasswordInput" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›" />
        <div id="debugPasswordError"></div>
        <div id="debugButtons" style="display: none;">
            <button id="debugCongrats">ğŸ‰ Congratulationsæ¼”å‡º</button>
            <button id="debugGameOver">ğŸ’€ ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼</button>
            <button id="debugSpawnFruit9">ğŸ‡ fruit_9ã‚’å‡ºç¾</button>
            <button id="debugSpawnFruit10">ğŸ‰ fruit_10ã‚’å‡ºç¾</button>
            <hr style="margin: 10px 0; border: 1px solid #D2B48C;">
            <div style="font-size: 12px; color: #8B4513; margin: 5px 0;">ğŸ’£ ãƒ¬ã‚¼ç¯‡</div>
            <button id="debugSpawnBomb">ğŸ’£ ãƒœãƒ ã‚’å‡ºç¾</button>
            <hr style="margin: 10px 0; border: 1px solid #D2B48C;">
            <div style="font-size: 12px; color: #8B4513; margin: 5px 0;">âš¡ äº”æ¡ç¯‡</div>
            <button id="debugSpawnGoAka">ğŸ”´ èµ¤ãƒœãƒ¼ãƒ«ã‚’å‡ºç¾</button>
            <button id="debugSpawnGoAo">ğŸ”µ é’ãƒœãƒ¼ãƒ«ã‚’å‡ºç¾</button>
        </div>
        <button id="debugClose">é–‰ã˜ã‚‹</button>
    </div>

    <script>
        console.log('=== Script Start ===');
        
        // ==================== ãƒ©ãƒ³ã‚­ãƒ³ã‚°é€ä¿¡è¨­å®š ====================
        
        // ãƒ©ãƒ³ã‚­ãƒ³ã‚°é€ä¿¡ãŒæœ‰åŠ¹ã‹ãƒã‚§ãƒƒã‚¯
        function isRankingEnabled() {
            const enabled = localStorage.getItem('rankingEnabled');
            return enabled === null || enabled === 'true'; // æœªè¨­å®šãªã‚‰trueï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆONï¼‰
        }
        
        // ãƒ©ãƒ³ã‚­ãƒ³ã‚°é€ä¿¡è¨­å®šã‚’ä¿å­˜
        function setRankingEnabled(enabled) {
            localStorage.setItem('rankingEnabled', enabled.toString());
            updateRankingToggleButton();
        }
        
        // åˆå›ç¢ºèªç”»é¢ã‚’è¡¨ç¤ºã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
        function shouldShowRankingConfirm() {
            return localStorage.getItem('rankingEnabled') === null;
        }
        
        // ãƒˆã‚°ãƒ«ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºã‚’æ›´æ–°
        function updateRankingToggleButton() {
            const button = document.getElementById('rankingToggleButton');
            if (button) {
                const enabled = isRankingEnabled();
                button.textContent = enabled ? 'ãƒ©ãƒ³ã‚­ãƒ³ã‚°é€ä¿¡: ON' : 'ãƒ©ãƒ³ã‚­ãƒ³ã‚°é€ä¿¡: OFF';
                button.style.background = enabled ? 'var(--btn-primary)' : 'var(--btn-neutral)';
            }
        }
        
        // ==================== æ—¢å­˜ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆ ====================
        
        
        // ====================
        // ãƒªã‚½ãƒ¼ã‚¹èª­ã¿è¾¼ã¿å‡¦ç†
        // ====================
        function preloadResources() {
            console.log('ğŸ”„ preloadResourcesé–‹å§‹');
            return new Promise((resolve) => {
                // èª­ã¿è¾¼ã‚€ãƒªã‚½ãƒ¼ã‚¹ã®ãƒªã‚¹ãƒˆ
                const audioFiles = [
                    'sound/special.mp3',
                    'sound/drop.mp3',
                    'sound/merge.mp3',
                    'sound/bomb.mp3'
                ];
                
                const imageFiles = [
                    'images/fruit_0.png',
                    'images/fruit_1.png',
                    'images/fruit_2.png',
                    'images/fruit_3.png',
                    'images/fruit_4.png',
                    'images/fruit_5.png',
                    'images/fruit_6.png',
                    'images/fruit_7.png',
                    'images/fruit_8.png',
                    'images/fruit_9.png',
                    'images/fruit_10.png',
                    'images/Go_aka.png',
                    'images/Go_ao.png',
                    'images/Go_murasaki.png',
                    'images/bakudan_dynamite.png',
                    'images/sinka_bar.png'
                ];
                
                let loadedCount = 0;
                const totalResources = audioFiles.length + imageFiles.length;
                
                function checkComplete() {
                    loadedCount++;
                    console.log(`ğŸ“¦ ãƒªã‚½ãƒ¼ã‚¹èª­ã¿è¾¼ã¿: ${loadedCount}/${totalResources}`);
                    if (loadedCount >= totalResources) {
                        console.log('âœ… All resources loaded!');
                        console.log('âœ¨ ãƒªã‚½ãƒ¼ã‚¹èª­ã¿è¾¼ã¿å®Œäº†');
                        resolve();
                    }
                }
                
                // éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿
                audioFiles.forEach(src => {
                    const audio = new Audio();
                    audio.addEventListener('canplaythrough', checkComplete, { once: true });
                    audio.addEventListener('error', checkComplete, { once: true });
                    audio.src = src;
                    audio.load();
                });
                
                // ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿
                imageFiles.forEach(src => {
                    const img = new Image();
                    img.onload = checkComplete;
                    img.onerror = checkComplete;
                    img.src = src;
                });
            });
        }
        
        // ãƒ¢ãƒã‚¤ãƒ«ã®éŸ³å£°ãƒ­ãƒƒã‚¯è§£é™¤
        function unlockAudio() {
            console.log('ğŸ”Š unlockAudio() é–‹å§‹');
            const audioElements = [
                // specialSoundã¯é™¤å¤–ï¼ˆç´«ãƒœãƒ¼ãƒ«æ™‚ã«å€‹åˆ¥å‡¦ç†ï¼‰
                document.getElementById('dropSound'),
                document.getElementById('mergeSound'),
                document.getElementById('bombSound')
            ];
            
            audioElements.forEach(audio => {
                if (audio) {
                    // ç¢ºå®Ÿã«ç„¡éŸ³ã«è¨­å®š
                    audio.volume = 0;
                    
                    // ç„¡éŸ³ã§å†ç”Ÿâ†’å³åœæ­¢ï¼ˆéŸ³å£°ãƒ­ãƒƒã‚¯è§£é™¤ï¼‰
                    audio.play().then(() => {
                        audio.pause();
                        audio.currentTime = 0;
                        console.log('âœ… Audio unlocked:', audio.id);
                    }).catch(err => {
                        console.error('âŒ Audio unlock failed:', audio.id, err);
                    });
                }
            });
        }
        
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†å¾Œã«ãƒªã‚½ãƒ¼ã‚¹èª­ã¿è¾¼ã¿é–‹å§‹
        window.addEventListener('DOMContentLoaded', () => {
            preloadResources();
        });
        
        // Webã‚¢ãƒ—ãƒªãƒ¢ãƒ¼ãƒ‰å¯¾ç­–ï¼šãƒšãƒ¼ã‚¸ãŒå†è¡¨ç¤ºã•ã‚ŒãŸæ™‚ã«éŸ³å£°çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible') {
                console.log('ğŸ”„ ãƒšãƒ¼ã‚¸ãŒå†è¡¨ç¤ºã•ã‚Œã¾ã—ãŸ - éŸ³å£°çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ');
                // éŸ³å£°ãƒ­ãƒƒã‚¯çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
                window.specialSoundUnlocked = false;
                window.audioUnlocked = false;
            }
        });
        
        // ====================
        // ãƒ©ãƒ³ã‚­ãƒ³ã‚°APIè¨­å®š
        // ====================
        const RANKING_API_URL = 'https://script.google.com/macros/s/AKfycbxabtrBgE0fDmhDGqqobAL5XADPfCaPVC2XIqr4WlK9BR9YPFgq1fNTiwT6qQso1fXX/exec';
        
        // ç«¯æœ«å›ºæœ‰IDã‚’å–å¾—ã¾ãŸã¯ç”Ÿæˆ
        function getDeviceId() {
            let deviceId = localStorage.getItem('watermelonDeviceId');
            if (!deviceId) {
                // æ–°è¦ç”Ÿæˆ: ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ— + ãƒ©ãƒ³ãƒ€ãƒ å€¤
                deviceId = 'device_' + Date.now() + '_' + Math.random().toString(36).substring(2, 15);
                localStorage.setItem('watermelonDeviceId', deviceId);
                console.log('New device ID created:', deviceId);
            }
            return deviceId;
        }
        
        const DEVICE_ID = getDeviceId();
        console.log('Device ID:', DEVICE_ID);
        
        // ====================
        // åˆæœŸåŒ–
        // ====================
        const difficultyScreen = document.getElementById('difficultyScreen');
        const howToPlayScreen = document.getElementById('howToPlayScreen');
        const howToPlayScreenReze = document.getElementById('howToPlayScreenReze');
        const howToPlayScreenGojo = document.getElementById('howToPlayScreenGojo');
        const rankingScreen = document.getElementById('rankingScreen');
        
        console.log('difficultyScreen:', difficultyScreen);
        console.log('howToPlayScreen:', howToPlayScreen);
        console.log('rankingScreen:', rankingScreen);
        
        // åˆå›è¨ªå•ãƒã‚§ãƒƒã‚¯
        const hasVisited = localStorage.getItem('watermelonGameVisited');
        console.log('hasVisited:', hasVisited);
        
        // åˆå›è¨ªå•ãªã‚‰éŠã³æ–¹ã‚’è¡¨ç¤º
        function showHowToPlayIfFirstTime() {
            if (!hasVisited) {
                console.log('Showing how to play');
                howToPlayScreen.classList.add('active');
                localStorage.setItem('watermelonGameVisited', 'true');
            }
        }
        
        function showDifficultyScreen() {
            console.log('Showing difficulty screen');
            difficultyScreen.classList.add('active');
        }
        
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«é›£æ˜“åº¦é¸æŠã‚’è¡¨ç¤º
        showHowToPlayIfFirstTime();
        showDifficultyScreen();
        console.log('=== Initialization Complete ===');

        // ====================
        // Matter.js ç‰©ç†ã‚¨ãƒ³ã‚¸ãƒ³è¨­å®š
        // ====================
        console.log('=== Loading Matter.js ===');
        console.log('Matter:', typeof Matter);
        
        if (typeof Matter === 'undefined') {
            console.error('Matter.js is not loaded!');
            alert('Matter.jsã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚');
        }
        
        const { Engine, Render, Runner, Bodies, Composite, Events, Body, Sleeping } = Matter;
        
        const canvas = document.getElementById('gameCanvas');
        const wrapper = document.getElementById('canvasWrapper');
        const gameContainer = document.getElementById('gameContainer');
        
        // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚µã‚¤ã‚ºï¼ˆå›ºå®šï¼‰
        let WIDTH = 500;
        let HEIGHT = 550; // 1.1å€
        const WALL_T = 10;
        const GAME_LINE_RATIO = 0.15;
        
        // ã‚²ãƒ¼ãƒ å®šæ•°
        const SPECIAL_BALL_SIZE_LEVEL = 2;  // ãƒœãƒ ãƒ»èµ¤ãƒ»é’ãƒœãƒ¼ãƒ«ã®ã‚µã‚¤ã‚ºãƒ¬ãƒ™ãƒ«ï¼ˆfruit_2ç›¸å½“ï¼‰
        const DEBUG_SPAWN_FRUIT9_LEVEL = 9;  // ãƒ‡ãƒãƒƒã‚°ç”¨fruit_9
        const DEBUG_SPAWN_FRUIT10_LEVEL = 10; // ãƒ‡ãƒãƒƒã‚°ç”¨fruit_10
        
        // ç‰©ç†ã‚¨ãƒ³ã‚¸ãƒ³ä½œæˆ
        const engine = Engine.create({
            constraintIterations: 5,
            positionIterations: 10,
            velocityIterations: 8,
            gravity: { x: 0, y: 0.9 }  // é‡åŠ›è¨­å®š
        });
        
        // ãƒ¬ãƒ³ãƒ€ãƒ©ãƒ¼ä½œæˆï¼ˆMatter.jsã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ¬ãƒ³ãƒ€ãƒ©ãƒ¼ã‚’ä½¿ç”¨ï¼‰
        const render = Render.create({
            canvas: canvas,
            engine: engine,
            options: {
                width: WIDTH,
                height: HEIGHT,
                wireframes: false,
                background: 'linear-gradient(180deg, #FFF8E7 0%, #F5E6D3 100%)'
            }
        });
        
        const runner = Runner.create({
            delta: 1000 / 60 * 4  // é€šå¸¸ã®4å€é€Ÿ
        });
        
        // ====================
        // ç”»åƒè¨­å®š
        // ====================
        const FRUIT_IMAGES = {
            0: 'images/fruit_0.png',
            1: 'images/fruit_1.png',
            2: 'images/fruit_2.png',
            3: 'images/fruit_3.png',
            4: 'images/fruit_4.png',
            5: 'images/fruit_5.png',
            6: 'images/fruit_6.png',
            7: 'images/fruit_7.png',
            8: 'images/fruit_8.png',
            9: 'images/fruit_9.png',
            10: 'images/fruit_10.png'
        };
        
        const SINKA_BAR_IMAGE = 'images/sinka_bar.png';
        const BOMB_IMAGE = 'images/bakudan_dynamite.png';
        const EXPLOSION_IMAGE = 'images/bakuhatsu.png';
        
        // äº”æ¡ç¯‡ã®ç”»åƒ
        const GO_AKA_IMAGE = 'images/Go_aka.png';
        const GO_AO_IMAGE = 'images/Go_ao.png';
        const GO_MURASAKI_IMAGE = 'images/Go_murasaki.png';
        const GO_AKA_MOJI_IMAGE = 'images/Go_aka_moji.png';
        const GO_AO_MOJI_IMAGE = 'images/Go_ao_moji.png';
        const GO_MURASAKI_MOJI_IMAGE = 'images/Go_murasaki_moji.png';
        
        const fruitImageObjects = {};
        let sinkaBarImageObject = null;
        let bombImageObject = null;
        let explosionImageObject = null;
        let goAkaImageObject = null;
        let goAoImageObject = null;
        let goMurasakiImageObject = null;
        
        // ç”»åƒãƒ—ãƒªãƒ­ãƒ¼ãƒ‰
        function preloadImages() {
            for (let key in FRUIT_IMAGES) {
                if (FRUIT_IMAGES[key]) {
                    const img = new Image();
                    img.src = FRUIT_IMAGES[key];
                    fruitImageObjects[key] = img;
                }
            }
            
            if (SINKA_BAR_IMAGE) {
                sinkaBarImageObject = new Image();
                sinkaBarImageObject.onload = () => {
                    const sinkaBarImg = document.getElementById('sinkaBarImage');
                    sinkaBarImg.innerHTML = '';
                    const imgElement = document.createElement('img');
                    imgElement.src = SINKA_BAR_IMAGE;
                    sinkaBarImg.appendChild(imgElement);
                };
                sinkaBarImageObject.src = SINKA_BAR_IMAGE;
            }
            
            // ãƒœãƒ ç”»åƒ
            if (BOMB_IMAGE) {
                bombImageObject = new Image();
                bombImageObject.src = BOMB_IMAGE;
            }
            
            // çˆ†ç™ºã‚¨ãƒ•ã‚§ã‚¯ãƒˆç”»åƒ
            if (EXPLOSION_IMAGE) {
                explosionImageObject = new Image();
                explosionImageObject.src = EXPLOSION_IMAGE;
            }
            
            // äº”æ¡ç¯‡ã®ç”»åƒ
            if (GO_AKA_IMAGE) {
                goAkaImageObject = new Image();
                goAkaImageObject.src = GO_AKA_IMAGE;
            }
            
            if (GO_AO_IMAGE) {
                goAoImageObject = new Image();
                goAoImageObject.src = GO_AO_IMAGE;
            }
            
            if (GO_MURASAKI_IMAGE) {
                goMurasakiImageObject = new Image();
                goMurasakiImageObject.src = GO_MURASAKI_IMAGE;
            }
        }
        
        preloadImages();
        
        // ====================
        // ã‚²ãƒ¼ãƒ è¨­å®š
        // ====================
        const BALL_COLORS = [
            '#FFE66D', '#FFB347', '#FF6B6B', '#C77DFF', '#FFD93D',
            '#FF8C42', '#4ECDC4', '#95E1D3', '#F38181', '#FFEB3B', '#FFD700'
        ];
        
        // å„ãƒœãƒ¼ãƒ«ã®ç›´å¾„æ¯”ç‡ï¼ˆæ¨ªå¹…1.000ã«å¯¾ã™ã‚‹æ¯”ç‡ï¼‰
        // ã€èª¿æ•´ç‰ˆã€‘å®Ÿè·µèª¿æ•´æ¸ˆã¿ï¼ˆ6ã€œ9èª¿æ•´å…¥ã‚Šï¼‰
        const BALL_DIAMETER_RATIOS = [
            0.068,  // fruit_0
            0.098,  // fruit_1
            0.117,  // fruit_2
            0.144,  // fruit_3
            0.180,  // fruit_4
            0.228,  // fruit_5
            0.241,  // fruit_6 â† èª¿æ•´ï¼ˆ0.267 â†’ 0.241ï¼‰
            0.272,  // fruit_7 â† èª¿æ•´ï¼ˆ0.340 â†’ 0.272ï¼‰
            0.275,  // fruit_8 â† èª¿æ•´ï¼ˆ0.366 â†’ 0.275ï¼‰
            0.320,  // fruit_9 â† èª¿æ•´ï¼ˆ0.457 â†’ 0.320ï¼‰
            0.389   // fruit_10 â† èª¿æ•´ï¼ˆ0.556 â†’ 0.389 = 0.556 * 0.7ï¼‰
        ];
        
        /* ã€æœªèª¿æ•´ç‰ˆã€‘ç†è«–å€¤ï¼ˆè¨˜éŒ²ç”¨ï¼‰
        const BALL_DIAMETER_RATIOS = [
            0.068,  // fruit_0
            0.098,  // fruit_1
            0.117,  // fruit_2
            0.144,  // fruit_3
            0.180,  // fruit_4
            0.228,  // fruit_5
            0.267,  // fruit_6
            0.340,  // fruit_7
            0.366,  // fruit_8
            0.457,  // fruit_9
            0.556   // fruit_10
        ];
        */
        
        function getBallSize(type) {
            // æ¨ªå¹…ã«å¯¾ã™ã‚‹æ¯”ç‡ã‹ã‚‰ç›´å¾„ã‚’è¨ˆç®—ã—ã€åŠå¾„ã«å¤‰æ›
            const diameter = WIDTH * BALL_DIAMETER_RATIOS[type];
            const radius = diameter / 2;
            return radius * ballSizeMultiplier; // é›£æ˜“åº¦ã«ã‚ˆã‚‹å€ç‡ã‚’é©ç”¨
        }
        
        // ã‚²ãƒ¼ãƒ çŠ¶æ…‹
        let score = 0;
        
        // é›£æ˜“åº¦åˆ¥ã‚¹ã‚³ã‚¢ç®¡ç†
        const DIFFICULTY_KEYS = {
            easy: 'watermelonScore_easy',
            normal: 'watermelonScore_normal',
            hard: 'watermelonScore_hard',
            reze: 'watermelonScore_reze',
            gojo: 'watermelonScore_gojo'
        };
        
        // é›£æ˜“åº¦åˆ¥ã®æœ€é«˜ã‚¹ã‚³ã‚¢ã‚’å–å¾—
        function getBestScore(difficulty) {
            const key = DIFFICULTY_KEYS[difficulty];
            return parseInt(localStorage.getItem(key)) || 0;
        }
        
        // é›£æ˜“åº¦åˆ¥ã®æœ€é«˜ã‚¹ã‚³ã‚¢ã‚’ä¿å­˜
        function saveBestScore(difficulty, score) {
            const key = DIFFICULTY_KEYS[difficulty];
            const currentBest = getBestScore(difficulty);
            if (score > currentBest) {
                localStorage.setItem(key, score);
                return true; // æ–°è¨˜éŒ²
            }
            return false;
        }
        
        let worldRecord = 0; // ç¾åœ¨ã®é›£æ˜“åº¦ã®æœ€é«˜ã‚¹ã‚³ã‚¢ï¼ˆã‚²ãƒ¼ãƒ é–‹å§‹æ™‚ã«è¨­å®šï¼‰
        let nextBallType = 0;
        let currentBall = null;
        let droppedBall = null; // è½ä¸‹ä¸­ã®ãƒœãƒ¼ãƒ«ã‚’è¿½è·¡
        let isGameOver = false;
        let canPut = false; // æœ€åˆã¯ã‚²ãƒ¼ãƒ é–‹å§‹ã¾ã§è½ã¨ã›ãªã„
        let gameStarted = false; // ã‚²ãƒ¼ãƒ ãŒé–‹å§‹ã•ã‚ŒãŸã‹
        let isTouching = false; // ã‚¿ãƒƒãƒä¸­ã‹ã©ã†ã‹
        let mouseX = WIDTH / 2;
        let seEnabled = true; // ã‚µã‚¦ãƒ³ãƒ‰ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã®ON/OFFï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆONï¼‰
        
        // ====================
        // ã‚²ãƒ¼ãƒ å®šæ•°
        // ====================
        const SPAWN_Y_POSITION = 30; // ãƒœãƒ¼ãƒ«å‡ºç¾æ™‚ã®Yåº§æ¨™ï¼ˆé€šå¸¸ãƒ—ãƒ¬ã‚¤ï¼‰
        const DEBUG_SPAWN_Y_RATIO = 0.3; // ãƒ‡ãƒãƒƒã‚°å‡ºç¾æ™‚ã®Yåº§æ¨™æ¯”ç‡ï¼ˆHEIGHT * ã“ã®å€¤ï¼‰
        const BOMB_DEFAULT_SPAWN_RATE = 10; // ãƒœãƒ ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå‡ºç¾ç‡
        const BOMB_EXPLOSION_RADIUS = 3; // ãƒœãƒ ã®çˆ†ç™ºç¯„å›²å€ç‡ï¼ˆãƒœãƒ åŠå¾„ Ã— ã“ã®å€¤ï¼‰
        const GOJO_DEFAULT_SPAWN_RATE = 17; // äº”æ¡ãƒœãƒ¼ãƒ«ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå‡ºç¾ç‡
        const GOJO_EXPLOSION_RADIUS = 3; // èµ¤/é’ã®çˆ†ç™ºç¯„å›²å€ç‡
        const MURASAKI_EXPLOSION_RADIUS = 24; // ç´«ã®çˆ†ç™ºç¯„å›²å€ç‡
        
        // é›£æ˜“åº¦è¨­å®š
        let currentDifficulty = 'normal'; // 'normal', 'easy', 'hard', or 'reze'
        let ballSizeMultiplier = 1.0; // ãƒœãƒ¼ãƒ«ã‚µã‚¤ã‚ºã®å€ç‡
        let fieldHeightRatio = 1.1; // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®é«˜ã•æ¯”ç‡ï¼ˆæ¨ªå¹…ã«å¯¾ã—ã¦ï¼‰
        
        // ãƒ¬ã‚¼ç¯‡ãƒ¢ãƒ¼ãƒ‰è¨­å®š
        let isRezeMode = false; // ãƒ¬ã‚¼ç¯‡ãƒ¢ãƒ¼ãƒ‰ã‹ã©ã†ã‹
        let bombSpawnCounter = 0; // ãƒœãƒ å‡ºç¾ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼
        let bombSpawnRate = BOMB_DEFAULT_SPAWN_RATE; // ãƒœãƒ å‡ºç¾ç¢ºç‡
        let explosionEffectEnabled = true; // çˆ†ç™ºã‚¨ãƒ•ã‚§ã‚¯ãƒˆæœ‰åŠ¹åŒ–
        
        // äº”æ¡ç¯‡ãƒ¢ãƒ¼ãƒ‰è¨­å®š
        let isGojoMode = false; // äº”æ¡ç¯‡ãƒ¢ãƒ¼ãƒ‰ã‹ã©ã†ã‹
        let gojoSpawnCounter = 0; // èµ¤/é’ãƒœãƒ¼ãƒ«å‡ºç¾ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼
        let gojoSpawnRate = GOJO_DEFAULT_SPAWN_RATE; // èµ¤/é’ãƒœãƒ¼ãƒ«å‡ºç¾ç¢ºç‡
        let gojoExplosionRadius = GOJO_EXPLOSION_RADIUS; // èµ¤/é’ã®çˆ†ç™ºç¯„å›²
        let murasakiExplosionRadius = MURASAKI_EXPLOSION_RADIUS; // ç´«ã®çˆ†ç™ºç¯„å›²
        
        // ã‚„ã•ã—ã„ãƒ¢ãƒ¼ãƒ‰é–‹æ”¾ãƒã‚§ãƒƒã‚¯
        const normalPlayCount = parseInt(localStorage.getItem('watermelonNormalPlayCount')) || 0;
        const easyButton = document.getElementById('easyButton');
        
        // ã‚„ã•ã—ã„ãƒ¢ãƒ¼ãƒ‰ã¯å¸¸ã«é–‹æ”¾
        easyButton.classList.remove('locked');
        easyButton.textContent = 'ã‚„ã•ã—ã„';
        
        // ã‚¹ã‚³ã‚¢æ›´æ–°
        function updateScore() {
            document.getElementById('scoreValue').textContent = `ã‚¹ã‚³ã‚¢ï¼š${score}`;
            document.getElementById('bestScoreValue').textContent = `Best: ${worldRecord}`;
            
            if (score > worldRecord) {
                worldRecord = score;
                document.getElementById('bestScoreValue').textContent = `Best: ${worldRecord}`;
            }
        }
        
        // æ¬¡ã®ãƒœãƒ¼ãƒ«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
        function updateNextPreview() {
            const preview = document.getElementById('nextPreview');
            preview.innerHTML = '';
            
            if (nextBallType === 'go_aka') {
                // èµ¤ãƒœãƒ¼ãƒ«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
                if (goAkaImageObject) {
                    const img = document.createElement('img');
                    img.src = goAkaImageObject.src;
                    preview.appendChild(img);
                } else {
                    preview.style.backgroundColor = '#FF0000';
                    preview.textContent = 'èµ¤';
                }
            } else if (nextBallType === 'go_ao') {
                // é’ãƒœãƒ¼ãƒ«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
                if (goAoImageObject) {
                    const img = document.createElement('img');
                    img.src = goAoImageObject.src;
                    preview.appendChild(img);
                } else {
                    preview.style.backgroundColor = '#0000FF';
                    preview.textContent = 'é’';
                }
            } else if (nextBallType === 'bomb') {
                // ãƒœãƒ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
                if (bombImageObject) {
                    const img = document.createElement('img');
                    img.src = bombImageObject.src;
                    preview.appendChild(img);
                } else {
                    preview.style.backgroundColor = '#8B4513';
                    preview.textContent = 'ğŸ’£';
                }
            } else if (fruitImageObjects[nextBallType]) {
                const img = document.createElement('img');
                img.src = fruitImageObjects[nextBallType].src;
                preview.appendChild(img);
            } else {
                preview.style.backgroundColor = BALL_COLORS[nextBallType];
                preview.textContent = nextBallType;
            }
        }
        
        function getRandomBallType() {
            // ãƒ¬ã‚¼ç¯‡ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã€ãƒœãƒ å‡ºç¾åˆ¤å®š
            if (isRezeMode) {
                bombSpawnCounter++;
                
                // 3å›ç›®ã¯å¿…ãšãƒœãƒ 
                if (bombSpawnCounter === 3) {
                    return 'bomb';
                }
                
                // ãã‚Œä»¥é™ã¯7å›ã«1å›ãƒœãƒ 
                if (bombSpawnCounter > 3 && bombSpawnCounter % bombSpawnRate === 0) {
                    return 'bomb';
                }
            }
            
            // äº”æ¡ç¯‡ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã€èµ¤/é’ãƒœãƒ¼ãƒ«å‡ºç¾åˆ¤å®š
            if (isGojoMode) {
                gojoSpawnCounter++;
                
                // 3å›ç›®ã¯å¿…ãšèµ¤
                if (gojoSpawnCounter === 3) {
                    return 'go_aka';
                }
                
                // 4å›ç›®ã¯å¿…ãšé’
                if (gojoSpawnCounter === 4) {
                    return 'go_ao';
                }
                
                // ãã‚Œä»¥é™ã¯10å›ã«1å›èµ¤ã¾ãŸã¯é’
                if (gojoSpawnCounter > 4 && gojoSpawnCounter % gojoSpawnRate === 0) {
                    return Math.random() < 0.5 ? 'go_aka' : 'go_ao';
                }
            }
            
            return Math.floor(Math.random() * 5);
        }
        
        // ====================
        // ã‚²ãƒ¼ãƒ åˆæœŸåŒ–
        // ====================
        function initGame() {
            // canvasã‚µã‚¤ã‚ºã¯å›ºå®šï¼ˆWIDTH, HEIGHTã¯å¤‰æ›´ã—ãªã„ï¼‰
            canvas.width = WIDTH;
            canvas.height = HEIGHT;
            render.options.width = WIDTH;
            render.options.height = HEIGHT;
            
            // ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ³ä½ç½®ï¼ˆå›ºå®šï¼‰
            const gameLine = document.querySelector('.game-line');
            gameLine.style.top = (550 * 0.15) + 'px'; // HEIGHT * GAME_LINE_RATIO
            
            // ãƒ¯ãƒ¼ãƒ«ãƒ‰ã‚’ã‚¯ãƒªã‚¢
            Composite.clear(engine.world);
            
            // å£ã¨åºŠã‚’ä½œæˆ
            const ground = Bodies.rectangle(WIDTH / 2, HEIGHT - WALL_T / 2, WIDTH, WALL_T, {
                isStatic: true,
                render: { fillStyle: '#D2B48C' }
            });
            
            const leftWall = Bodies.rectangle(WALL_T / 2, HEIGHT / 2, WALL_T, HEIGHT, {
                isStatic: true,
                render: { fillStyle: '#D2B48C' }
            });
            
            const rightWall = Bodies.rectangle(WIDTH - WALL_T / 2, HEIGHT / 2, WALL_T, HEIGHT, {
                isStatic: true,
                render: { fillStyle: '#D2B48C' }
            });
            
            Composite.add(engine.world, [ground, leftWall, rightWall]);
            
            // çŠ¶æ…‹ãƒªã‚»ãƒƒãƒˆ
            score = 0;
            isGameOver = false;
            canPut = false; // ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¾ã§å¾…ã¤
            gameStarted = false;
            currentBall = null;
            droppedBall = null;
            nextBallType = getRandomBallType();
            
            updateScore();
            updateNextPreview();
            
            // æœ€é«˜ã‚¹ã‚³ã‚¢ã‚’è¡¨ç¤º
            document.getElementById('bestScoreValue').textContent = `Best: ${worldRecord}`;
            
            // ãƒ¬ãƒ³ãƒ€ãƒ©ãƒ¼ã¨ãƒ©ãƒ³ãƒŠãƒ¼ã‚’åœæ­¢ã—ã¦ã‹ã‚‰å†èµ·å‹•
            Runner.stop(runner);
            Render.stop(render);
            
            Render.run(render);
            Runner.run(runner, engine);
            
            // ã‚¤ãƒ™ãƒ³ãƒˆç™»éŒ²
            setupEvents();
        }
        
        // é›£æ˜“åº¦é¸æŠãƒœã‚¿ãƒ³å‡¦ç†
        document.getElementById('normalButton').addEventListener('click', () => {
            // ãƒ¢ãƒã‚¤ãƒ«ã®éŸ³å£°ãƒ­ãƒƒã‚¯è§£é™¤ï¼ˆæ¯å›å®Ÿè¡Œï¼‰
            console.log('ğŸ”“ ã‚²ãƒ¼ãƒ é–‹å§‹ãƒœã‚¿ãƒ³ã§éŸ³å£°ãƒ­ãƒƒã‚¯è§£é™¤');
            unlockAudio();
            
            currentDifficulty = 'normal';
            ballSizeMultiplier = 1.0;
            fieldHeightRatio = 1.1;
            isRezeMode = false;
            isGojoMode = false;
            worldRecord = getBestScore('normal');
            
            // Bestè¡¨ç¤ºã‚’åˆæœŸåŒ–
            document.getElementById('bestScoreValue').textContent = `Best: ${worldRecord}`;
            
            difficultyScreen.classList.remove('active');
            gameContainer.classList.add('active');
            document.getElementById('startScreen').classList.add('active');
            initGame();
        });
        
        document.getElementById('easyButton').addEventListener('click', () => {
            // ãƒ¢ãƒã‚¤ãƒ«ã®éŸ³å£°ãƒ­ãƒƒã‚¯è§£é™¤ï¼ˆæ¯å›å®Ÿè¡Œï¼‰
            console.log('ğŸ”“ ã‚²ãƒ¼ãƒ é–‹å§‹ãƒœã‚¿ãƒ³ã§éŸ³å£°ãƒ­ãƒƒã‚¯è§£é™¤');
            unlockAudio();
            
            currentDifficulty = 'easy';
            ballSizeMultiplier = 0.7;
            fieldHeightRatio = 1.1;
            isRezeMode = false;
            isGojoMode = false;
            worldRecord = getBestScore('easy');
            
            // Bestè¡¨ç¤ºã‚’åˆæœŸåŒ–
            document.getElementById('bestScoreValue').textContent = `Best: ${worldRecord}`;
            
            difficultyScreen.classList.remove('active');
            gameContainer.classList.add('active');
            document.getElementById('startScreen').classList.add('active');
            initGame();
        });
        
        document.getElementById('rezeButton').addEventListener('click', () => {
            // ãƒ¢ãƒã‚¤ãƒ«ã®éŸ³å£°ãƒ­ãƒƒã‚¯è§£é™¤ï¼ˆæ¯å›å®Ÿè¡Œï¼‰
            console.log('ğŸ”“ ã‚²ãƒ¼ãƒ é–‹å§‹ãƒœã‚¿ãƒ³ã§éŸ³å£°ãƒ­ãƒƒã‚¯è§£é™¤');
            unlockAudio();
            
            currentDifficulty = 'reze';
            ballSizeMultiplier = 1.0;
            fieldHeightRatio = 1.1;
            isRezeMode = true;
            isGojoMode = false;
            bombSpawnCounter = 0;
            worldRecord = getBestScore('reze');
            
            // Bestè¡¨ç¤ºã‚’åˆæœŸåŒ–
            document.getElementById('bestScoreValue').textContent = `Best: ${worldRecord}`;
            
            difficultyScreen.classList.remove('active');
            gameContainer.classList.add('active');
            document.getElementById('startScreen').classList.add('active');
            initGame();
        });
        
        document.getElementById('gojoButton').addEventListener('click', () => {
            // ãƒ¢ãƒã‚¤ãƒ«ã®éŸ³å£°ãƒ­ãƒƒã‚¯è§£é™¤ï¼ˆæ¯å›å®Ÿè¡Œï¼‰
            console.log('ğŸ”“ ã‚²ãƒ¼ãƒ é–‹å§‹ãƒœã‚¿ãƒ³ã§éŸ³å£°ãƒ­ãƒƒã‚¯è§£é™¤');
            unlockAudio();
            
            currentDifficulty = 'gojo';
            ballSizeMultiplier = 1.0;
            fieldHeightRatio = 1.1;
            isRezeMode = false;
            isGojoMode = true;
            gojoSpawnCounter = 0;
            worldRecord = getBestScore('gojo');
            
            // Bestè¡¨ç¤ºã‚’åˆæœŸåŒ–
            document.getElementById('bestScoreValue').textContent = `Best: ${worldRecord}`;
            
            // iOSã®éŸ³å£°å•é¡Œå¯¾ç­–ï¼šéŸ³å£°ã‚’å†ãƒ­ãƒ¼ãƒ‰
            const specialSound = document.getElementById('specialSound');
            if (specialSound) {
                specialSound.load();
            }
            
            difficultyScreen.classList.remove('active');
            gameContainer.classList.add('active');
            document.getElementById('startScreen').classList.add('active');
            initGame();
        });
        
        // ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³å‡¦ç†
        document.getElementById('startButton').addEventListener('click', () => {
            console.log('ğŸ® ã‚²ãƒ¼ãƒ é–‹å§‹ãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ');
            
            // ãƒ¢ãƒã‚¤ãƒ«ã®éŸ³å£°ãƒ­ãƒƒã‚¯è§£é™¤ï¼ˆæ¯å›å®Ÿè¡Œï¼‰
            console.log('ğŸ”“ ã‚²ãƒ¼ãƒ é–‹å§‹ãƒœã‚¿ãƒ³ã§éŸ³å£°ãƒ­ãƒƒã‚¯è§£é™¤');
            unlockAudio();
            
            document.getElementById('startScreen').classList.remove('active');
            gameStarted = true;
            canPut = true;
            
            // iOSã®éŸ³å£°å•é¡Œå¯¾ç­–ï¼šéŸ³å£°ã‚’å†ãƒ­ãƒ¼ãƒ‰
            const specialSound = document.getElementById('specialSound');
            if (specialSound) {
                specialSound.load();
            }
            
            createNewBall(); // æœ€åˆã®ãƒœãƒ¼ãƒ«ã‚’è¡¨ç¤º
            console.log('âœ… ã‚²ãƒ¼ãƒ é–‹å§‹ï¼');
        });
        
        // ====================
        // ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
        // ====================
        function setupEvents() {
            // è¡çªã‚¤ãƒ™ãƒ³ãƒˆ
            Events.on(engine, 'collisionStart', handleCollision);
            
            // ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼åˆ¤å®š
            Events.on(engine, 'afterUpdate', checkGameOver);
            
            // åŠé€æ˜ãƒœãƒ¼ãƒ«ã®å®šæœŸã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
            setInterval(() => {
                cleanupTransparentBalls();
            }, 2000); // 2ç§’ã”ã¨
        }
        
        // åŠé€æ˜ãƒœãƒ¼ãƒ«ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
        function cleanupTransparentBalls() {
            const allBodies = Composite.allBodies(engine.world);
            let removedCount = 0;
            
            allBodies.forEach(body => {
                // ä¸é€æ˜åº¦ãŒ0.5æœªæº€ã®ãƒœãƒ¼ãƒ«ã‚’å‰Šé™¤
                if (body.render && body.render.opacity !== undefined && body.render.opacity < 0.5) {
                    // currentBallã¯ä¿è­·
                    if (body === currentBall) return;
                    
                    // åºŠã¨å£ã¯é™¤å¤–
                    if (body.isStatic) return;
                    
                    console.log('ğŸ§¹ åŠé€æ˜ãƒœãƒ¼ãƒ«ã‚’å‰Šé™¤:', body.label, 'opacity:', body.render.opacity);
                    Composite.remove(engine.world, body);
                    removedCount++;
                }
            });
            
            if (removedCount > 0) {
                console.log(`âœ¨ ${removedCount}å€‹ã®åŠé€æ˜ãƒœãƒ¼ãƒ«ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã—ã¾ã—ãŸ`);
            }
        }
        
        // è¡çªå‡¦ç†
        function handleCollision({ pairs }) {
            for (const pair of pairs) {
                const { bodyA, bodyB } = pair;
                
                // è½ä¸‹ä¸­ã®ãƒœãƒ¼ãƒ«ãŒä½•ã‹ã«è§¦ã‚ŒãŸã‚‰æ¬¡ã®ãƒœãƒ¼ãƒ«ã‚’å‡ºã›ã‚‹ã‚ˆã†ã«ã™ã‚‹
                if (droppedBall && (bodyA.id === droppedBall.id || bodyB.id === droppedBall.id)) {
                    droppedBall = null;
                    
                    // çŸ­ã„ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«å¾Œã«æ¬¡ã®ãƒœãƒ¼ãƒ«ã‚’å‡ºã™
                    setTimeout(() => {
                        canPut = true;
                        createNewBall();
                    }, 100);
                }
                
                if (!Composite.get(engine.world, bodyA.id, 'body') ||
                    !Composite.get(engine.world, bodyB.id, 'body')) {
                    continue;
                }
                
                // ãƒœãƒ ã¯åˆæˆã—ãªã„
                if (bodyA.label === 'bomb' || bodyB.label === 'bomb') {
                    continue;
                }
                
                // èµ¤ãƒœãƒ¼ãƒ«ãƒ»é’ãƒœãƒ¼ãƒ«ãƒ»ç´«ãƒœãƒ¼ãƒ«ã¯åˆæˆã—ãªã„ï¼ˆç´«ã®ã¿ä¾‹å¤–å‡¦ç†ï¼‰
                if (bodyA.label === 'go_aka' && bodyB.label === 'go_aka') {
                    continue;
                }
                if (bodyA.label === 'go_ao' && bodyB.label === 'go_ao') {
                    continue;
                }
                if (bodyA.label === 'go_murasaki' || bodyB.label === 'go_murasaki') {
                    continue;
                }
                
                // èµ¤+é’â†’ç´«ã¸ã®å¤‰åŒ–
                if ((bodyA.label === 'go_aka' && bodyB.label === 'go_ao') ||
                    (bodyA.label === 'go_ao' && bodyB.label === 'go_aka')) {
                    
                    const newX = (bodyA.position.x + bodyB.position.x) / 2;
                    const newY = (bodyA.position.y + bodyB.position.y) / 2;
                    const murasakiSize = getBallSize(3); // fruit_3ç›¸å½“
                    
                    // èµ¤é’åˆä½“éŸ³ã‚’å†ç”Ÿ
                    if (seEnabled) {
                        const mergeSound = document.getElementById('mergeSound');
                        if (mergeSound) {
                            mergeSound.volume = 0.2;
                            mergeSound.currentTime = 0;
                            mergeSound.play().catch(err => console.log('Merge sound failed:', err));
                        }
                    }
                    
                    const murasakiBall = Bodies.circle(newX, newY, murasakiSize, {
                        label: 'go_murasaki',
                        restitution: 0.2,
                        friction: 0.5,
                        frictionAir: 0.01,
                        density: 0.002,
                        slop: 0.05,
                        render: {
                            sprite: goMurasakiImageObject ? {
                                texture: GO_MURASAKI_IMAGE,
                                xScale: (murasakiSize * 2) / 500,
                                yScale: (murasakiSize * 2) / 500
                            } : {
                                fillStyle: '#8B00FF'
                            }
                        }
                    });
                    
                    Composite.remove(engine.world, [bodyA, bodyB]);
                    Composite.add(engine.world, murasakiBall);
                    continue;
                }
                
                // isSleepingçŠ¶æ…‹ã®ãƒœãƒ¼ãƒ«ï¼ˆæ“ä½œä¸­ã®åŠé€æ˜ãƒœãƒ¼ãƒ«ï¼‰ã¯åˆæˆã—ãªã„
                if (bodyA.isSleeping || bodyB.isSleeping) {
                    continue;
                }
                
                if (bodyA.label === bodyB.label && bodyA.label.startsWith('bubble_')) {
                    const currentLevel = Number(bodyA.label.substring(7));
                    
                    // ã‚¹ã‚³ã‚¢åŠ ç®—
                    score += Math.pow(2, currentLevel + 1);
                    
                    // ãƒœãƒ¼ãƒ«åˆä½“éŸ³ã‚’å†ç”Ÿ
                    if (seEnabled) {
                        const mergeSound = document.getElementById('mergeSound');
                        if (mergeSound) {
                            mergeSound.volume = 0.2;
                            mergeSound.currentTime = 0;
                            mergeSound.play().catch(err => console.log('Merge sound failed:', err));
                        }
                    }
                    
                    // fruit_9 Ã— 2ã®å ´åˆã€5000ç‚¹ãƒœãƒ¼ãƒŠã‚¹
                    if (currentLevel === 9) {
                        const bonus = 5000;
                        score += bonus;
                    }
                    
                    updateScore();
                    
                    if (currentLevel === 10) {
                        // fruit_10åŒå£«ãŒåˆæˆã•ã‚ŒãŸå ´åˆï¼šæ¶ˆãˆã‚‹ã®ã¿
                        // ãƒœãƒ¼ãƒ«ã‚’å‰Šé™¤
                        Composite.remove(engine.world, [bodyA, bodyB]);
                        continue;
                    }
                    
                    const newLevel = currentLevel + 1;
                    const newX = (bodyA.position.x + bodyB.position.x) / 2;
                    const newY = (bodyA.position.y + bodyB.position.y) / 2;
                    const newRadius = getBallSize(newLevel);
                    
                    const newBall = Bodies.circle(newX, newY, newRadius, {
                        label: 'bubble_' + newLevel,
                        restitution: 0.2,
                        friction: 0.5,
                        frictionAir: 0.01,
                        density: 0.002,
                        slop: 0.05,
                        render: {
                            fillStyle: BALL_COLORS[newLevel],
                            sprite: fruitImageObjects[newLevel] ? {
                                texture: FRUIT_IMAGES[newLevel],
                                xScale: (newRadius * 2) / 500,
                                yScale: (newRadius * 2) / 500
                            } : undefined
                        }
                    });
                    
                    Composite.remove(engine.world, [bodyA, bodyB]);
                    Composite.add(engine.world, [newBall]);
                    
                    // fruit_10ãŒç”Ÿæˆã•ã‚ŒãŸå ´åˆã€ãŠç¥ã„æ¼”å‡ºã‚’è¡¨ç¤º
                    if (newLevel === 10) {
                        showCongratulations();
                    }
                }
            }
        }
        
        // ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼åˆ¤å®š
        function checkGameOver() {
            const gameLineY = HEIGHT * GAME_LINE_RATIO;
            const bubbles = Composite.allBodies(engine.world).filter(body => 
                body.label.startsWith('bubble_') && !body.isSleeping  // isSleepingçŠ¶æ…‹ï¼ˆæ“ä½œä¸­ã®ãƒœãƒ¼ãƒ«ï¼‰ã¯é™¤å¤–
            );
            
            for (const bubble of bubbles) {
                if (bubble.position.y - bubble.circleRadius < gameLineY && bubble.velocity.y < 0) {
                    Runner.stop(runner);
                    isGameOver = true;
                    showGameOver();
                    break;
                }
            }
        }
        
        // ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼è¡¨ç¤º
        // ãŠç¥ã„æ¼”å‡º
        function showCongratulations() {
            const congratsScreen = document.getElementById('congratsScreen');
            const congratsBox = document.getElementById('congratsBox');
            
            // é…ç½®å¾…ã¡ã®åŠé€æ˜ãƒœãƒ¼ãƒ«ã‚’å‰Šé™¤
            if (currentBall) {
                Composite.remove(engine.world, currentBall);
                currentBall = null;
            }
            
            // ç”»é¢ã‚’è¡¨ç¤º
            congratsScreen.classList.add('active');
            
            // ã‚­ãƒ©ã‚­ãƒ©ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚’è¿½åŠ 
            createSparkles(congratsBox);
            
            // ã‚²ãƒ¼ãƒ ä¸€æ™‚åœæ­¢
            canPut = false;
        }
        
        // ã‚­ãƒ©ã‚­ãƒ©ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚’ç”Ÿæˆ
        function createSparkles(container) {
            const sparkleCount = 30;
            for (let i = 0; i < sparkleCount; i++) {
                setTimeout(() => {
                    const sparkle = document.createElement('div');
                    sparkle.className = 'sparkle';
                    
                    // ãƒ©ãƒ³ãƒ€ãƒ ãªæ–¹å‘ã«é£›ã°ã™
                    const angle = (Math.PI * 2 * i) / sparkleCount;
                    const distance = 150 + Math.random() * 100;
                    const tx = Math.cos(angle) * distance;
                    const ty = Math.sin(angle) * distance;
                    
                    sparkle.style.setProperty('--tx', tx + 'px');
                    sparkle.style.setProperty('--ty', ty + 'px');
                    sparkle.style.left = '50%';
                    sparkle.style.top = '50%';
                    
                    container.appendChild(sparkle);
                    
                    // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³çµ‚äº†å¾Œã«å‰Šé™¤
                    setTimeout(() => sparkle.remove(), 1000);
                }, i * 30);
            }
        }
        
        // ç¶šã‘ã‚‹ãƒœã‚¿ãƒ³
        document.getElementById('congratsContinue').addEventListener('click', () => {
            document.getElementById('congratsScreen').classList.remove('active');
            canPut = true;
            createNewBall();
        });
        
        // ====================
        // ãƒœãƒ çˆ†ç™ºæ©Ÿèƒ½
        // ====================
        function explodeBomb(bomb) {
            const bombX = bomb.position.x;
            const bombY = bomb.position.y;
            const bombRadius = bomb.circleRadius;
            const explosionRange = bombRadius * BOMB_EXPLOSION_RADIUS;
            
            // çˆ†ç™ºã‚¨ãƒ•ã‚§ã‚¯ãƒˆè¡¨ç¤º
            if (explosionEffectEnabled) {
                showExplosionEffect(bombX, bombY, explosionRange);
            }
            
            // ãƒœãƒ çˆ†ç™ºéŸ³ã‚’å†ç”Ÿ
            if (seEnabled) {
                const bombSound = document.getElementById('bombSound');
                if (bombSound) {
                    bombSound.volume = 0.3;
                    bombSound.currentTime = 0;
                    bombSound.play().catch(err => console.log('Bomb sound failed:', err));
                }
            }
            
            // å‘¨å›²ã®fruit_0ã€œfruit_4ã‚’æ¤œå‡ºã—ã¦å‰Šé™¤
            const allBodies = Composite.allBodies(engine.world);
            const bodiesToRemove = [];
            
            for (const body of allBodies) {
                // æ“ä½œä¸­ã®ãƒœãƒ¼ãƒ«ï¼ˆcurrentBallï¼‰ã¯ä¿è­·
                if (body === currentBall) continue;
                
                if (body.label.startsWith('bubble_')) {
                    const level = Number(body.label.substring(7));
                    
                    // fruit_0ã€œfruit_4ã®ã¿å¯¾è±¡
                    if (level >= 0 && level <= 4) {
                        const dx = body.position.x - bombX;
                        const dy = body.position.y - bombY;
                        const distance = Math.sqrt(dx * dx + dy * dy);
                        
                        // çˆ†ç™ºç¯„å›²å†…
                        if (distance <= explosionRange) {
                            bodiesToRemove.push(body);
                            // ã‚¹ã‚³ã‚¢åŠ ç®—
                            score += Math.pow(2, level + 1);
                        }
                    }
                }
            }
            
            // ãƒœãƒ¼ãƒ«å‰Šé™¤
            for (const body of bodiesToRemove) {
                Composite.remove(engine.world, body);
            }
            
            // ãƒœãƒ è‡ªä½“ã‚‚å‰Šé™¤
            Composite.remove(engine.world, bomb);
            
            // ã‚¹ã‚³ã‚¢æ›´æ–°
            updateScore();
            
            // ä¿é™ºï¼šcurrentBallãŒæ¶ˆãˆã¦ã—ã¾ã£ãŸå ´åˆã®å¾©æ—§
            if (!currentBall && canPut) {
                createNewBall();
            }
        }
        
        // äº”æ¡ç¯‡ï¼šèµ¤ãƒ»é’ãƒœãƒ¼ãƒ«çˆ†ç™ºå‡¦ç†
        function explodeGojo(gojoBall) {
            const gojoX = gojoBall.position.x;
            const gojoY = gojoBall.position.y;
            const gojoRadius = gojoBall.circleRadius;
            const explosionRange = gojoRadius * gojoExplosionRadius;
            
            // èµ¤é’ãƒœãƒ¼ãƒ«ã®æ¼”å‡º
            if (gojoBall.label === 'go_aka') {
                showAkaEffect(gojoX, gojoY, gojoRadius);
            } else if (gojoBall.label === 'go_ao') {
                showAoEffect(gojoX, gojoY, gojoRadius);
            }
            
            // ã‚«ãƒƒãƒˆã‚¤ãƒ³è¡¨ç¤º
            const mojiImage = gojoBall.label === 'go_aka' ? GO_AKA_MOJI_IMAGE : GO_AO_MOJI_IMAGE;
            showCutIn(mojiImage);
            
            // å‘¨å›²ã®fruit_0ã€œfruit_4ã‚’æ¤œå‡ºã—ã¦å‰Šé™¤
            const allBodies = Composite.allBodies(engine.world);
            const bodiesToRemove = [];
            
            for (const body of allBodies) {
                // æ“ä½œä¸­ã®ãƒœãƒ¼ãƒ«ï¼ˆcurrentBallï¼‰ã¯ä¿è­·
                if (body === currentBall) continue;
                
                // äº”æ¡ãƒœãƒ¼ãƒ«ã¯å‰Šé™¤å¯¾è±¡å¤–
                if (body.label === 'go_aka' || body.label === 'go_ao' || body.label === 'go_murasaki') continue;
                
                if (body.label.startsWith('bubble_')) {
                    const level = Number(body.label.substring(7));
                    
                    // fruit_0ã€œfruit_4ã®ã¿å¯¾è±¡
                    if (level >= 0 && level <= 4) {
                        const dx = body.position.x - gojoX;
                        const dy = body.position.y - gojoY;
                        const distance = Math.sqrt(dx * dx + dy * dy);
                        
                        // çˆ†ç™ºç¯„å›²å†…
                        if (distance <= explosionRange) {
                            bodiesToRemove.push(body);
                            // ã‚¹ã‚³ã‚¢åŠ ç®—
                            score += Math.pow(2, level + 1);
                        }
                    }
                }
            }
            
            // ãƒœãƒ¼ãƒ«å‰Šé™¤
            for (const body of bodiesToRemove) {
                Composite.remove(engine.world, body);
            }
            
            // äº”æ¡ãƒœãƒ¼ãƒ«è‡ªä½“ã‚‚å‰Šé™¤
            Composite.remove(engine.world, gojoBall);
            
            // ã‚¹ã‚³ã‚¢æ›´æ–°
            updateScore();
            
            // ä¿é™ºï¼šcurrentBallãŒæ¶ˆãˆã¦ã—ã¾ã£ãŸå ´åˆã®å¾©æ—§
            if (!currentBall && canPut) {
                createNewBall();
            }
        }
        
        // äº”æ¡ç¯‡ï¼šç´«ãƒœãƒ¼ãƒ«çˆ†ç™ºå‡¦ç†
        function explodeMurasaki(murasakiBall) {
            const murasakiX = murasakiBall.position.x;
            const murasakiY = murasakiBall.position.y;
            const murasakiRadius = murasakiBall.circleRadius;
            const explosionRange = murasakiRadius * murasakiExplosionRadius;
            
            // åŠ¹æœéŸ³ã‚’å†ç”Ÿ
            if (seEnabled) {
                const specialSound = document.getElementById('specialSound');
                if (specialSound) {
                    // åˆå›ã®ã¿éŸ³å£°ãƒ­ãƒƒã‚¯è§£é™¤ï¼ˆWebã‚¢ãƒ—ãƒªãƒ¢ãƒ¼ãƒ‰å¯¾å¿œï¼‰
                    if (!window.specialSoundUnlocked) {
                        console.log('ğŸ”“ ç´«ãƒœãƒ¼ãƒ«åˆå›ï¼šéŸ³å£°ãƒ­ãƒƒã‚¯è§£é™¤');
                        specialSound.volume = 0;
                        specialSound.play().then(() => {
                            specialSound.pause();
                            specialSound.currentTime = 0;
                            window.specialSoundUnlocked = true;
                            
                            // ã™ãã«æœ¬ç•ªå†ç”Ÿ
                            specialSound.volume = 0.3;
                            specialSound.play().catch(err => console.log('Special sound play failed:', err));
                        }).catch(err => {
                            console.error('âŒ ç´«ãƒœãƒ¼ãƒ«éŸ³å£°ãƒ­ãƒƒã‚¯è§£é™¤å¤±æ•—:', err);
                        });
                    } else {
                        // 2å›ç›®ä»¥é™ã¯é€šå¸¸å†ç”Ÿ
                        specialSound.volume = 0.3;
                        specialSound.currentTime = 0;
                        specialSound.play().catch(err => console.log('Special sound play failed:', err));
                    }
                }
            }
            
            // ç™½ãƒ•ãƒ©ãƒƒã‚·ãƒ¥æ¼”å‡º
            showWhiteFlash();
            
            // ã‚«ãƒƒãƒˆã‚¤ãƒ³è¡¨ç¤ºï¼ˆå°‘ã—é…å»¶ã•ã›ã‚‹ï¼‰
            setTimeout(() => {
                showCutIn(GO_MURASAKI_MOJI_IMAGE);
            }, 100);
            
            // ã™ãã«å‘¨å›²ã®ãƒœãƒ¼ãƒ«ã‚’å‰Šé™¤ï¼ˆæ‹¡å¤§ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã¯å‰Šé™¤ï¼‰
            setTimeout(() => {
                // å‘¨å›²ã®fruit_0ã€œfruit_4ã‚’æ¤œå‡ºã—ã¦å‰Šé™¤
                const allBodies = Composite.allBodies(engine.world);
                const bodiesToRemove = [];
                
                for (const body of allBodies) {
                    // æ“ä½œä¸­ã®ãƒœãƒ¼ãƒ«ï¼ˆcurrentBallï¼‰ã¯ä¿è­·
                    if (body === currentBall) continue;
                    
                    // äº”æ¡ãƒœãƒ¼ãƒ«ã¯å‰Šé™¤å¯¾è±¡å¤–
                    if (body.label === 'go_aka' || body.label === 'go_ao' || body.label === 'go_murasaki') continue;
                    
                    if (body.label.startsWith('bubble_')) {
                        const level = Number(body.label.substring(7));
                        
                        // fruit_0ã€œfruit_4ã®ã¿å¯¾è±¡
                        if (level >= 0 && level <= 4) {
                            const dx = body.position.x - murasakiX;
                            const dy = body.position.y - murasakiY;
                            const distance = Math.sqrt(dx * dx + dy * dy);
                            
                            // çˆ†ç™ºç¯„å›²å†…
                            if (distance <= explosionRange) {
                                bodiesToRemove.push(body);
                                // ã‚¹ã‚³ã‚¢åŠ ç®—
                                score += Math.pow(2, level + 1);
                            }
                        }
                    }
                }
                
                // ãƒœãƒ¼ãƒ«å‰Šé™¤
                for (const body of bodiesToRemove) {
                    Composite.remove(engine.world, body);
                }
                
                // ç´«ãƒœãƒ¼ãƒ«è‡ªä½“ã‚‚å‰Šé™¤
                Composite.remove(engine.world, murasakiBall);
                
                // ã‚¹ã‚³ã‚¢æ›´æ–°
                updateScore();
                
                // ä¿é™ºï¼šcurrentBallãŒæ¶ˆãˆã¦ã—ã¾ã£ãŸå ´åˆã®å¾©æ—§
                if (!currentBall && canPut) {
                    createNewBall();
                }
            }, 300); // ç™½ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ã¨ã‚«ãƒƒãƒˆã‚¤ãƒ³ã®å¾Œã«å‰Šé™¤
        }
        
        // çˆ†ç™ºã‚¨ãƒ•ã‚§ã‚¯ãƒˆè¡¨ç¤º
        function showExplosionEffect(x, y, radius) {
            const effectDiv = document.createElement('div');
            effectDiv.style.position = 'absolute';
            effectDiv.style.pointerEvents = 'none';
            effectDiv.style.zIndex = '1000';
            
            const rect = canvas.getBoundingClientRect();
            const canvasX = rect.left + (x / WIDTH) * rect.width;
            const canvasY = rect.top + (y / HEIGHT) * rect.height;
            const size = (radius / WIDTH) * rect.width * 2;
            
            effectDiv.style.left = (canvasX - size / 2) + 'px';
            effectDiv.style.top = (canvasY - size / 2) + 'px';
            effectDiv.style.width = size + 'px';
            effectDiv.style.height = size + 'px';
            
            if (explosionImageObject) {
                const img = document.createElement('img');
                img.src = explosionImageObject.src;
                img.style.width = '100%';
                img.style.height = '100%';
                effectDiv.appendChild(img);
            } else {
                effectDiv.style.background = 'radial-gradient(circle, rgba(255,255,0,0.8) 0%, rgba(255,100,0,0.4) 50%, transparent 100%)';
                effectDiv.style.borderRadius = '50%';
            }
            
            document.body.appendChild(effectDiv);
            
            // 0.3ç§’å¾Œã«å‰Šé™¤
            setTimeout(() => {
                effectDiv.remove();
            }, 300);
        }
        
        // ã‚«ãƒƒãƒˆã‚¤ãƒ³è¡¨ç¤º
        function showCutIn(imageUrl) {
            const cutInDiv = document.createElement('div');
            cutInDiv.style.position = 'absolute';
            cutInDiv.style.pointerEvents = 'none';
            cutInDiv.style.zIndex = '10000';
            cutInDiv.style.opacity = '0';
            cutInDiv.style.transition = 'opacity 0.1s';
            
            // ã‚­ãƒ£ãƒ³ãƒã‚¹ã®ä½ç½®ã¨ã‚µã‚¤ã‚ºã‚’å–å¾—
            const rect = canvas.getBoundingClientRect();
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;
            
            const img = document.createElement('img');
            img.src = imageUrl;
            img.style.maxWidth = Math.min(rect.width * 0.8, 400) + 'px';
            img.style.maxHeight = Math.min(rect.height * 0.4, 200) + 'px';
            img.style.filter = 'drop-shadow(0 0 20px rgba(255,255,255,0.8))';
            
            // ç”»åƒèª­ã¿è¾¼ã¿å®Œäº†å¾Œã«é…ç½®
            img.onload = () => {
                const imgWidth = img.offsetWidth;
                const imgHeight = img.offsetHeight;
                cutInDiv.style.left = (centerX - imgWidth / 2) + 'px';
                cutInDiv.style.top = (centerY - imgHeight / 2) + 'px';
                cutInDiv.style.opacity = '1';
            };
            
            // ç”»åƒèª­ã¿è¾¼ã¿å¤±æ•—æ™‚ã‚‚ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³ï¼ˆä¸­å¤®ã«é…ç½®ï¼‰
            img.onerror = () => {
                cutInDiv.style.left = centerX + 'px';
                cutInDiv.style.top = centerY + 'px';
                cutInDiv.style.transform = 'translate(-50%, -50%)';
                cutInDiv.style.opacity = '1';
            };
            
            cutInDiv.appendChild(img);
            document.body.appendChild(cutInDiv);
            
            // 1.3ç§’å¾Œã«ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆé–‹å§‹
            setTimeout(() => {
                cutInDiv.style.opacity = '0';
            }, 1300);
            
            // 1.5ç§’å¾Œã«å‰Šé™¤
            setTimeout(() => {
                cutInDiv.remove();
            }, 1500);
        }
        
        // ç™½ãƒ•ãƒ©ãƒƒã‚·ãƒ¥æ¼”å‡º
        function showWhiteFlash() {
            const flashDiv = document.createElement('div');
            flashDiv.style.position = 'fixed';
            flashDiv.style.top = '0';
            flashDiv.style.left = '0';
            flashDiv.style.width = '100vw';
            flashDiv.style.height = '100vh';
            flashDiv.style.backgroundColor = 'white';
            flashDiv.style.zIndex = '9999';
            flashDiv.style.pointerEvents = 'none';
            flashDiv.style.opacity = '1';
            flashDiv.style.transition = 'opacity 0.4s';
            
            document.body.appendChild(flashDiv);
            
            // 0.3ç§’å¾Œã«ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆé–‹å§‹
            setTimeout(() => {
                flashDiv.style.opacity = '0';
            }, 300);
            
            // 0.7ç§’å¾Œã«å‰Šé™¤
            setTimeout(() => {
                flashDiv.remove();
            }, 700);
        }
        
        // èµ¤ãƒœãƒ¼ãƒ«æ¼”å‡ºï¼ˆå¼¾ãå‡ºã™ï¼šå°â†’å¤§ï¼‰
        function showAkaEffect(x, y, radius) {
            const effectDiv = document.createElement('div');
            effectDiv.style.position = 'absolute';
            effectDiv.style.pointerEvents = 'none';
            effectDiv.style.zIndex = '9998';
            
            const rect = canvas.getBoundingClientRect();
            const centerX = rect.left + (x / WIDTH) * rect.width;
            const centerY = rect.top + (y / HEIGHT) * rect.height;
            
            const img = document.createElement('img');
            img.src = 'images/Go_aka_migimawari.png';
            img.style.position = 'absolute';
            img.style.left = '50%';
            img.style.top = '50%';
            img.style.transform = 'translate(-50%, -50%)';
            img.style.transition = 'all 0.5s ease-out';
            
            // åˆæœŸã‚µã‚¤ã‚ºï¼ˆå°ã•ã„ï¼‰
            const startSize = radius * 0.5;
            img.style.width = startSize + 'px';
            img.style.height = startSize + 'px';
            
            effectDiv.style.left = centerX + 'px';
            effectDiv.style.top = centerY + 'px';
            effectDiv.appendChild(img);
            document.body.appendChild(effectDiv);
            
            // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹
            setTimeout(() => {
                const endSize = radius * 6; // ãƒœãƒ¼ãƒ«ã®3å€ï¼ˆç›´å¾„åŸºæº–ï¼‰
                img.style.width = endSize + 'px';
                img.style.height = endSize + 'px';
                img.style.opacity = '0';
                
                // é«˜é€Ÿå³å›è»¢
                img.style.animation = 'spinRight 0.5s linear';
            }, 10);
            
            // å‰Šé™¤
            setTimeout(() => {
                effectDiv.remove();
            }, 600);
        }
        
        // é’ãƒœãƒ¼ãƒ«æ¼”å‡ºï¼ˆå¸ã„è¾¼ã‚€ï¼šå¤§â†’å°ï¼‰
        function showAoEffect(x, y, radius) {
            const effectDiv = document.createElement('div');
            effectDiv.style.position = 'absolute';
            effectDiv.style.pointerEvents = 'none';
            effectDiv.style.zIndex = '9998';
            
            const rect = canvas.getBoundingClientRect();
            const centerX = rect.left + (x / WIDTH) * rect.width;
            const centerY = rect.top + (y / HEIGHT) * rect.height;
            
            const img = document.createElement('img');
            img.src = 'images/Go_ao_hidarimawari.png';
            img.style.position = 'absolute';
            img.style.left = '50%';
            img.style.top = '50%';
            img.style.transform = 'translate(-50%, -50%)';
            img.style.transition = 'all 0.5s ease-in';
            
            // åˆæœŸã‚µã‚¤ã‚ºï¼ˆå¤§ãã„ï¼‰
            const startSize = radius * 6; // ãƒœãƒ¼ãƒ«ã®3å€ï¼ˆç›´å¾„åŸºæº–ï¼‰
            img.style.width = startSize + 'px';
            img.style.height = startSize + 'px';
            
            effectDiv.style.left = centerX + 'px';
            effectDiv.style.top = centerY + 'px';
            effectDiv.appendChild(img);
            document.body.appendChild(effectDiv);
            
            // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹
            setTimeout(() => {
                const endSize = radius * 0.5;
                img.style.width = endSize + 'px';
                img.style.height = endSize + 'px';
                img.style.opacity = '0';
                
                // é«˜é€Ÿå·¦å›è»¢
                img.style.animation = 'spinLeft 0.5s linear';
            }, 10);
            
            // å‰Šé™¤
            setTimeout(() => {
                effectDiv.remove();
            }, 600);
        }
        
        // ç´«ãƒœãƒ¼ãƒ«ã®æ‹¡å¤§ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
        function expandMurasaki(murasakiBall, callback) {
            const startRadius = murasakiBall.circleRadius;
            const endRadius = startRadius * 8;
            const duration = 400; // 0.4ç§’
            const startTime = Date.now();
            
            function animate() {
                const elapsed = Date.now() - startTime;
                const progress = Math.min(elapsed / duration, 1);
                
                // ã‚¤ãƒ¼ã‚¸ãƒ³ã‚°ï¼ˆåŠ é€Ÿï¼‰
                const eased = progress * progress;
                const currentRadius = startRadius + (endRadius - startRadius) * eased;
                
                // ãƒœãƒ¼ãƒ«ã®ã‚µã‚¤ã‚ºã‚’æ›´æ–°
                if (Composite.get(engine.world, murasakiBall.id, 'body')) {
                    Body.scale(murasakiBall, currentRadius / murasakiBall.circleRadius, currentRadius / murasakiBall.circleRadius);
                    
                    if (progress < 1) {
                        requestAnimationFrame(animate);
                    } else {
                        callback();
                    }
                } else {
                    callback();
                }
            }
            
            animate();
        }
        
        function showGameOver() {
            // é…ç½®å¾…ã¡ã®åŠé€æ˜ãƒœãƒ¼ãƒ«ã‚’å‰Šé™¤
            if (currentBall) {
                Composite.remove(engine.world, currentBall);
                currentBall = null;
            }
            
            // ã‚¹ã‚³ã‚¢ã‚’ä¿å­˜
            saveBestScore(currentDifficulty, score);
            
            // ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã«ã‚¹ã‚³ã‚¢ã‚’é€ä¿¡
            const playerName = localStorage.getItem('watermelonPlayerName') || 'åç„¡ã—';
            submitScore(currentDifficulty, playerName, score);
            
            document.getElementById('finalScore').textContent = score;
            document.getElementById('gameOver').style.display = 'block';
        }
        
        // ãƒªã‚¹ã‚¿ãƒ¼ãƒˆ
        document.getElementById('restartBtn').addEventListener('click', () => {
            document.getElementById('gameOver').style.display = 'none';
            
            // é›£æ˜“åº¦é¸æŠã«æˆ»ã‚‹
            showDifficultyScreen();
        });
        
        // ã‚²ãƒ¼ãƒ ç”»é¢ã®ãƒªã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³
        document.getElementById('gameRestartButton').addEventListener('click', () => {
            if (gameStarted && !isGameOver) {
                // ã‚²ãƒ¼ãƒ ä¸­ã®å ´åˆã€ç¢ºèªã—ã¦ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ã«ã™ã‚‹
                if (confirm('ã‚²ãƒ¼ãƒ ã‚’çµ‚äº†ã—ã¦ãƒªã‚¹ã‚¿ãƒ¼ãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
                    Runner.stop(runner);
                    isGameOver = true;
                    
                    // iOSã®éŸ³å£°å•é¡Œå¯¾ç­–ï¼šéŸ³å£°ã‚’å†ãƒ­ãƒ¼ãƒ‰
                    const specialSound = document.getElementById('specialSound');
                    if (specialSound) {
                        specialSound.load();
                    }
                    
                    showGameOver();
                }
            }
        });
        
        // SE ON/OFFãƒœã‚¿ãƒ³
        const seToggleButton = document.getElementById('seToggleButton');
        seToggleButton.addEventListener('click', () => {
            seEnabled = !seEnabled;
            const img = seToggleButton.querySelector('img');
            if (img) {
                img.src = seEnabled ? 'images/SE_ON.png' : 'images/SE_OFF.png';
                img.alt = seEnabled ? 'SE ON' : 'SE OFF';
            }
            seToggleButton.classList.toggle('on', seEnabled);
            
            // localStorageã«ä¿å­˜
            localStorage.setItem('seEnabled', seEnabled);
        });
        
        // SEè¨­å®šã‚’localStorageã‹ã‚‰å¾©å…ƒ
        const savedSeEnabled = localStorage.getItem('seEnabled');
        if (savedSeEnabled !== null) {
            seEnabled = savedSeEnabled === 'true';
            const img = seToggleButton.querySelector('img');
            if (img) {
                img.src = seEnabled ? 'images/SE_ON.png' : 'images/SE_OFF.png';
                img.alt = seEnabled ? 'SE ON' : 'SE OFF';
            }
            seToggleButton.classList.toggle('on', seEnabled);
        }
        
        // ====================
        // ãƒœãƒ¼ãƒ«é…ç½®
        // ====================
        const tapSafeZone = document.getElementById('tapSafeZone');
        
        canvas.addEventListener('mousemove', (e) => {
            if (isGameOver || !canPut) return;
            const rect = canvas.getBoundingClientRect();
            mouseX = (e.clientX - rect.left) * (WIDTH / rect.width);
            
            if (currentBall) {
                const radius = currentBall.circleRadius;
                const newX = Math.max(WALL_T + radius, Math.min(WIDTH - WALL_T - radius, mouseX));
                Body.setPosition(currentBall, { x: newX, y: currentBall.position.y });
            }
        });
        
        // ã‚¿ãƒƒãƒ—ç§»å‹•ã‚¨ãƒªã‚¢ã§ã‚‚ãƒœãƒ¼ãƒ«ã‚’ç§»å‹•
        tapSafeZone.addEventListener('mousemove', (e) => {
            if (isGameOver || !canPut) return;
            const canvasRect = canvas.getBoundingClientRect();
            const tapRect = tapSafeZone.getBoundingClientRect();
            // ã‚¿ãƒƒãƒ—ã‚¨ãƒªã‚¢ã®Xåº§æ¨™ã‚’ã‚­ãƒ£ãƒ³ãƒã‚¹ã®Xåº§æ¨™ã«å¤‰æ›
            const relativeX = e.clientX - tapRect.left;
            const canvasX = (relativeX / tapRect.width) * canvasRect.width;
            mouseX = (canvasX / canvasRect.width) * WIDTH;
            
            if (currentBall) {
                const radius = currentBall.circleRadius;
                const newX = Math.max(WALL_T + radius, Math.min(WIDTH - WALL_T - radius, mouseX));
                Body.setPosition(currentBall, { x: newX, y: currentBall.position.y });
            }
        });
        
        tapSafeZone.addEventListener('touchmove', (e) => {
            if (isGameOver || !canPut) return;
            e.preventDefault();
            const touch = e.touches[0];
            const canvasRect = canvas.getBoundingClientRect();
            const tapRect = tapSafeZone.getBoundingClientRect();
            // ã‚¿ãƒƒãƒ—ã‚¨ãƒªã‚¢ã®Xåº§æ¨™ã‚’ã‚­ãƒ£ãƒ³ãƒã‚¹ã®Xåº§æ¨™ã«å¤‰æ›
            const relativeX = touch.clientX - tapRect.left;
            const canvasX = (relativeX / tapRect.width) * canvasRect.width;
            mouseX = (canvasX / canvasRect.width) * WIDTH;
            
            if (currentBall) {
                const radius = currentBall.circleRadius;
                const newX = Math.max(WALL_T + radius, Math.min(WIDTH - WALL_T - radius, mouseX));
                Body.setPosition(currentBall, { x: newX, y: currentBall.position.y });
            }
        }, { passive: false });
        
        // ã‚¿ãƒƒãƒ—ç§»å‹•ã‚¨ãƒªã‚¢ã§ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒœãƒ¼ãƒ«ã‚’è½ã¨ã™
        tapSafeZone.addEventListener('click', (e) => {
            if (isGameOver || !canPut) return;
            if (!currentBall) {
                createNewBall();
            } else {
                dropBall();
            }
        });
        
        // ã‚¿ãƒƒãƒ—ç§»å‹•ã‚¨ãƒªã‚¢ã§ã‚¿ãƒƒãƒçµ‚äº†æ™‚ã«ãƒœãƒ¼ãƒ«ã‚’è½ã¨ã™
        tapSafeZone.addEventListener('touchend', (e) => {
            if (isGameOver || !canPut) return;
            e.preventDefault();
            if (!currentBall) {
                createNewBall();
            } else {
                dropBall();
            }
        }, { passive: false });
        
        canvas.addEventListener('click', (e) => {
            if (isGameOver) return;
            
            const rect = canvas.getBoundingClientRect();
            const clickX = (e.clientX - rect.left) * (WIDTH / rect.width);
            const clickY = (e.clientY - rect.top) * (HEIGHT / rect.height);
            
            // ãƒ¬ã‚¼ç¯‡ãƒ¢ãƒ¼ãƒ‰ï¼šãƒœãƒ ã‚¯ãƒªãƒƒã‚¯åˆ¤å®š
            if (isRezeMode) {
                const allBodies = Composite.allBodies(engine.world);
                for (const body of allBodies) {
                    if (body.label === 'bomb') {
                        const dx = clickX - body.position.x;
                        const dy = clickY - body.position.y;
                        const distance = Math.sqrt(dx * dx + dy * dy);
                        
                        if (distance <= body.circleRadius) {
                            explodeBomb(body);
                            return;
                        }
                    }
                }
            }
            
            // äº”æ¡ç¯‡ãƒ¢ãƒ¼ãƒ‰ï¼šèµ¤ãƒ»é’ãƒ»ç´«ãƒœãƒ¼ãƒ«ã‚¯ãƒªãƒƒã‚¯åˆ¤å®š
            if (isGojoMode) {
                const allBodies = Composite.allBodies(engine.world);
                for (const body of allBodies) {
                    if (body.label === 'go_aka' || body.label === 'go_ao' || body.label === 'go_murasaki') {
                        const dx = clickX - body.position.x;
                        const dy = clickY - body.position.y;
                        const distance = Math.sqrt(dx * dx + dy * dy);
                        
                        if (distance <= body.circleRadius) {
                            if (body.label === 'go_murasaki') {
                                explodeMurasaki(body);
                            } else {
                                explodeGojo(body);
                            }
                            return;
                        }
                    }
                }
            }
            
            // é€šå¸¸ã®ãƒœãƒ¼ãƒ«é…ç½®å‡¦ç†
            if (!canPut) return;
            
            mouseX = clickX;
            
            if (!currentBall) {
                createNewBall();
            } else {
                dropBall();
            }
        });
        
        // ã‚¿ãƒƒãƒé–‹å§‹
        canvas.addEventListener('touchstart', (e) => {
            if (isGameOver) return;
            e.preventDefault();
            
            const rect = canvas.getBoundingClientRect();
            const touchX = (e.touches[0].clientX - rect.left) * (WIDTH / rect.width);
            const touchY = (e.touches[0].clientY - rect.top) * (HEIGHT / rect.height);
            
            // ãƒ¬ã‚¼ç¯‡ãƒ¢ãƒ¼ãƒ‰ï¼šãƒœãƒ ã‚¿ãƒƒãƒ—åˆ¤å®š
            if (isRezeMode) {
                const allBodies = Composite.allBodies(engine.world);
                for (const body of allBodies) {
                    if (body.label === 'bomb') {
                        const dx = touchX - body.position.x;
                        const dy = touchY - body.position.y;
                        const distance = Math.sqrt(dx * dx + dy * dy);
                        
                        if (distance <= body.circleRadius) {
                            explodeBomb(body);
                            return;
                        }
                    }
                }
            }
            
            // äº”æ¡ç¯‡ãƒ¢ãƒ¼ãƒ‰ï¼šèµ¤ãƒ»é’ãƒ»ç´«ãƒœãƒ¼ãƒ«ã‚¿ãƒƒãƒ—åˆ¤å®š
            if (isGojoMode) {
                const allBodies = Composite.allBodies(engine.world);
                for (const body of allBodies) {
                    if (body.label === 'go_aka' || body.label === 'go_ao' || body.label === 'go_murasaki') {
                        const dx = touchX - body.position.x;
                        const dy = touchY - body.position.y;
                        const distance = Math.sqrt(dx * dx + dy * dy);
                        
                        if (distance <= body.circleRadius) {
                            if (body.label === 'go_murasaki') {
                                explodeMurasaki(body);
                            } else {
                                explodeGojo(body);
                            }
                            return;
                        }
                    }
                }
            }
            
            // é€šå¸¸ã®ãƒœãƒ¼ãƒ«é…ç½®å‡¦ç†
            if (!canPut) return;
            
            isTouching = true;
            mouseX = touchX;
            
            if (!currentBall) {
                createNewBall();
            }
        });
        
        canvas.addEventListener('touchmove', (e) => {
            if (isGameOver || !canPut || !isTouching) return;
            e.preventDefault();
            const rect = canvas.getBoundingClientRect();
            mouseX = (e.touches[0].clientX - rect.left) * (WIDTH / rect.width);
            
            if (currentBall) {
                const radius = currentBall.circleRadius;
                const newX = Math.max(WALL_T + radius, Math.min(WIDTH - WALL_T - radius, mouseX));
                Body.setPosition(currentBall, { x: newX, y: currentBall.position.y });
            }
        });
        
        canvas.addEventListener('touchend', (e) => {
            if (isGameOver || !canPut || !isTouching) return;
            e.preventDefault();
            isTouching = false;
            
            // æŒ‡ã‚’é›¢ã—ãŸç¬é–“ã«ãƒœãƒ¼ãƒ«ã‚’è½ã¨ã™
            if (currentBall) {
                dropBall();
            }
        });
        
        function createNewBall() {
            // èµ¤ãƒœãƒ¼ãƒ«ã®å ´åˆ
            if (nextBallType === 'go_aka') {
                const akaSize = getBallSize(SPECIAL_BALL_SIZE_LEVEL);
                const x = Math.max(WALL_T + akaSize, Math.min(WIDTH - WALL_T - akaSize, mouseX));
                
                currentBall = Bodies.circle(x, SPAWN_Y_POSITION, akaSize, {
                    isSleeping: true,
                    label: 'go_aka',
                    restitution: 0.2,
                    friction: 0.5,
                    frictionAir: 0.01,
                    density: 0.002,
                    slop: 0.05,
                    render: {
                        sprite: goAkaImageObject ? {
                            texture: GO_AKA_IMAGE,
                            xScale: (akaSize * 2) / 500,
                            yScale: (akaSize * 2) / 500
                        } : {
                            fillStyle: '#FF0000'
                        }
                    }
                });
            } 
            // é’ãƒœãƒ¼ãƒ«ã®å ´åˆ
            else if (nextBallType === 'go_ao') {
                const aoSize = getBallSize(SPECIAL_BALL_SIZE_LEVEL);
                const x = Math.max(WALL_T + aoSize, Math.min(WIDTH - WALL_T - aoSize, mouseX));
                
                currentBall = Bodies.circle(x, SPAWN_Y_POSITION, aoSize, {
                    isSleeping: true,
                    label: 'go_ao',
                    restitution: 0.2,
                    friction: 0.5,
                    frictionAir: 0.01,
                    density: 0.002,
                    slop: 0.05,
                    render: {
                        sprite: goAoImageObject ? {
                            texture: GO_AO_IMAGE,
                            xScale: (aoSize * 2) / 500,
                            yScale: (aoSize * 2) / 500
                        } : {
                            fillStyle: '#0000FF'
                        }
                    }
                });
            }
            // ãƒœãƒ ã®å ´åˆ
            else if (nextBallType === 'bomb') {
                const bombSize = getBallSize(SPECIAL_BALL_SIZE_LEVEL);
                const x = Math.max(WALL_T + bombSize, Math.min(WIDTH - WALL_T - bombSize, mouseX));
                
                currentBall = Bodies.circle(x, SPAWN_Y_POSITION, bombSize, {
                    isSleeping: true,
                    label: 'bomb',
                    restitution: 0.2,
                    friction: 0.5,
                    frictionAir: 0.01,
                    density: 0.002,
                    slop: 0.05,
                    render: {
                        sprite: bombImageObject ? {
                            texture: BOMB_IMAGE,
                            xScale: (bombSize * 2) / 500,
                            yScale: (bombSize * 2) / 500
                        } : {
                            fillStyle: '#8B4513'
                        }
                    }
                });
            } else {
                // é€šå¸¸ã®ãƒ•ãƒ«ãƒ¼ãƒ„ãƒœãƒ¼ãƒ«
                const radius = getBallSize(nextBallType);
                const x = Math.max(WALL_T + radius, Math.min(WIDTH - WALL_T - radius, mouseX));
                
                currentBall = Bodies.circle(x, SPAWN_Y_POSITION, radius, {
                    isSleeping: true,
                    label: 'bubble_' + nextBallType,
                    restitution: 0.2,
                    friction: 0.5,
                    frictionAir: 0.01,
                    density: 0.002,
                    slop: 0.05,
                    render: {
                        fillStyle: BALL_COLORS[nextBallType],
                        sprite: fruitImageObjects[nextBallType] ? {
                            texture: FRUIT_IMAGES[nextBallType],
                            xScale: (radius * 2) / 500,
                            yScale: (radius * 2) / 500
                        } : undefined
                    }
                });
            }
            
            Composite.add(engine.world, [currentBall]);
            
            // currentBallã‚’ä½œæˆã—ãŸã‚‰ã€æ¬¡ã®ãƒã‚¯ã‚¹ãƒˆã‚’å³åº§ã«æº–å‚™
            nextBallType = getRandomBallType();
            updateNextPreview();
        }
        
        function dropBall() {
            if (!currentBall) return;
            
            Sleeping.set(currentBall, false);
            droppedBall = currentBall; // è½ä¸‹ä¸­ã®ãƒœãƒ¼ãƒ«ã‚’è¨˜éŒ²
            currentBall = null;
            
            // ãƒœãƒ¼ãƒ«ãŒä»–ã®ãƒœãƒ¼ãƒ«ã«è§¦ã‚Œã‚‹ã¾ã§æ¬¡ã‚’å‡ºã•ãªã„
            canPut = false;
            
            // ãƒœãƒ¼ãƒ«è½ä¸‹éŸ³ã‚’å†ç”Ÿ
            if (seEnabled) {
                const dropSound = document.getElementById('dropSound');
                if (dropSound) {
                    dropSound.volume = 0.3;
                    dropSound.currentTime = 0;
                    dropSound.play().catch(err => console.log('Drop sound failed:', err));
                }
            }
        }
        
        // ====================
        // éŠã³æ–¹èª¬æ˜
        // ====================
        const howToPlayButton = document.getElementById('howToPlayButton');
        
        // éŠã³æ–¹ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ - ãƒ¢ãƒ¼ãƒ‰ã«å¿œã˜ã¦è¡¨ç¤º
        howToPlayButton.addEventListener('click', () => {
            console.log('â“ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ - isRezeMode:', isRezeMode, 'isGojoMode:', isGojoMode);
            if (isRezeMode) {
                console.log('ãƒ¬ã‚¼ç¯‡ã®èª¬æ˜ã‚’è¡¨ç¤º');
                howToPlayScreenReze.classList.add('active');
            } else if (isGojoMode) {
                console.log('äº”æ¡ç¯‡ã®èª¬æ˜ã‚’è¡¨ç¤º');
                howToPlayScreenGojo.classList.add('active');
            } else {
                console.log('é€šå¸¸ã®èª¬æ˜ã‚’è¡¨ç¤º');
                howToPlayScreen.classList.add('active');
            }
        });
        
        // é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ - é€šå¸¸
        document.getElementById('closeHowToPlay').addEventListener('click', () => {
            howToPlayScreen.classList.remove('active');
        });
        
        // é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ - ãƒ¬ã‚¼ç¯‡
        document.getElementById('closeHowToPlayReze').addEventListener('click', () => {
            howToPlayScreenReze.classList.remove('active');
        });
        
        // é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ - äº”æ¡ç¯‡
        document.getElementById('closeHowToPlayGojo').addEventListener('click', () => {
            howToPlayScreenGojo.classList.remove('active');
        });

        // ====================
        // ãƒ‡ãƒãƒƒã‚°æ©Ÿèƒ½
        // ====================
        const DEBUG_PASSWORD = 'suika';
        const debugButton = document.getElementById('debugButton');
        const debugPanel = document.getElementById('debugPanel');
        const debugPasswordInput = document.getElementById('debugPasswordInput');
        const debugPasswordError = document.getElementById('debugPasswordError');
        const debugButtons = document.getElementById('debugButtons');
        let debugUnlocked = false;

        // ãƒ‡ãƒãƒƒã‚°ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯
        debugButton.addEventListener('click', () => {
            debugPanel.classList.add('active');
            debugPasswordInput.value = '';
            debugPasswordError.textContent = '';
            if (debugUnlocked) {
                debugPasswordInput.style.display = 'none';
                debugButtons.style.display = 'block';
            } else {
                debugPasswordInput.style.display = 'block';
                debugButtons.style.display = 'none';
                debugPasswordInput.focus();
            }
        });

        // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å…¥åŠ›
        debugPasswordInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                if (debugPasswordInput.value === DEBUG_PASSWORD) {
                    debugUnlocked = true;
                    debugPasswordInput.style.display = 'none';
                    debugButtons.style.display = 'block';
                    debugPasswordError.textContent = '';
                } else {
                    debugPasswordError.textContent = 'âŒ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™';
                    debugPasswordInput.value = '';
                    setTimeout(() => {
                        debugPasswordError.textContent = '';
                    }, 2000);
                }
            }
        });

        // Congratulationsæ¼”å‡º
        document.getElementById('debugCongrats').addEventListener('click', () => {
            debugPanel.classList.remove('active');
            showCongratulations();
        });

        // ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼
        document.getElementById('debugGameOver').addEventListener('click', () => {
            debugPanel.classList.remove('active');
            isGameOver = true;
            showGameOver();
        });

        // fruit_9ã‚’å‡ºç¾
        document.getElementById('debugSpawnFruit9').addEventListener('click', () => {
            debugPanel.classList.remove('active');
            
            // æ—¢å­˜ã®currentBallãŒã‚ã‚Œã°å‰Šé™¤
            if (currentBall) {
                Composite.remove(engine.world, currentBall);
                currentBall = null;
            }
            
            const x = WIDTH / 2;
            const y = HEIGHT * DEBUG_SPAWN_Y_RATIO;
            const radius = getBallSize(DEBUG_SPAWN_FRUIT9_LEVEL);
            
            const fruit9 = Bodies.circle(x, y, radius, {
                label: 'bubble_9',
                restitution: 0.2,
                friction: 0.5,
                frictionAir: 0.01,
                density: 0.002,
                slop: 0.05,
                render: {
                    fillStyle: BALL_COLORS[9],
                    sprite: fruitImageObjects[9] ? {
                        texture: FRUIT_IMAGES[9],
                        xScale: (radius * 2) / 500,
                        yScale: (radius * 2) / 500
                    } : null
                }
            });
            
            Composite.add(engine.world, fruit9);
            
            // çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
            canPut = true;
        });

        // fruit_10ã‚’å‡ºç¾
        document.getElementById('debugSpawnFruit10').addEventListener('click', () => {
            debugPanel.classList.remove('active');
            
            // æ—¢å­˜ã®currentBallãŒã‚ã‚Œã°å‰Šé™¤
            if (currentBall) {
                Composite.remove(engine.world, currentBall);
                currentBall = null;
            }
            
            const x = WIDTH / 2;
            const y = HEIGHT * DEBUG_SPAWN_Y_RATIO;
            const radius = getBallSize(DEBUG_SPAWN_FRUIT10_LEVEL);
            
            const fruit10 = Bodies.circle(x, y, radius, {
                label: 'bubble_10',
                restitution: 0.2,
                friction: 0.5,
                frictionAir: 0.01,
                density: 0.002,
                slop: 0.05,
                render: {
                    fillStyle: BALL_COLORS[10],
                    sprite: fruitImageObjects[10] ? {
                        texture: FRUIT_IMAGES[10],
                        xScale: (radius * 2) / 500,
                        yScale: (radius * 2) / 500
                    } : null
                }
            });
            
            Composite.add(engine.world, fruit10);
            
            // çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
            canPut = true;
        });

        // ====================
        // ãƒ‡ãƒãƒƒã‚°ç”¨ã®ç›´æ¥å‡ºç¾é–¢æ•°
        // ====================
        function spawnBomb() {
            const bombSize = getBallSize(SPECIAL_BALL_SIZE_LEVEL);
            const x = WIDTH / 2; // ä¸­å¤®ã«å‡ºç¾
            const y = HEIGHT * DEBUG_SPAWN_Y_RATIO; // ä¸Šéƒ¨ã‹ã‚‰
            
            const bomb = Bodies.circle(x, y, bombSize, {
                label: 'bomb',
                restitution: 0.2,
                friction: 0.5,
                frictionAir: 0.01,
                density: 0.002,
                slop: 0.05,
                render: {
                    sprite: bombImageObject ? {
                        texture: BOMB_IMAGE,
                        xScale: (bombSize * 2) / 500,
                        yScale: (bombSize * 2) / 500
                    } : {
                        fillStyle: '#8B4513'
                    }
                }
            });
            
            Composite.add(engine.world, bomb);
        }
        
        function spawnGojoSpecialBall(type) {
            const ballSize = getBallSize(SPECIAL_BALL_SIZE_LEVEL);
            const x = WIDTH / 2; // ä¸­å¤®ã«å‡ºç¾
            const y = HEIGHT * DEBUG_SPAWN_Y_RATIO; // ä¸Šéƒ¨ã‹ã‚‰
            
            let texture, color;
            if (type === 'go_aka') {
                texture = GO_AKA_IMAGE;
                color = '#FF0000';
            } else if (type === 'go_ao') {
                texture = GO_AO_IMAGE;
                color = '#0000FF';
            }
            
            const ball = Bodies.circle(x, y, ballSize, {
                label: type,
                restitution: 0.2,
                friction: 0.5,
                frictionAir: 0.01,
                density: 0.002,
                slop: 0.05,
                render: {
                    sprite: (type === 'go_aka' && goAkaImageObject) || (type === 'go_ao' && goAoImageObject) ? {
                        texture: texture,
                        xScale: (ballSize * 2) / 500,
                        yScale: (ballSize * 2) / 500
                    } : {
                        fillStyle: color
                    }
                }
            });
            
            Composite.add(engine.world, ball);
        }

        // ãƒ¬ã‚¼ç¯‡è¨­å®šã®èª¿æ•´
        // ãƒ‡ãƒãƒƒã‚°ï¼šãƒœãƒ ã‚’å‡ºç¾ï¼ˆãƒ¬ã‚¼ç¯‡ã®ã¿ï¼‰
        document.getElementById('debugSpawnBomb').addEventListener('click', () => {
            if (!gameStarted || isGameOver) return;
            if (!isRezeMode) {
                alert('ğŸ’£ ãƒœãƒ ã¯ãƒ¬ã‚¼ç¯‡ã§ã®ã¿å‡ºç¾ã§ãã¾ã™');
                return;
            }
            spawnBomb();
            debugPanel.classList.remove('active'); // ãƒ‘ãƒãƒ«ã‚’é–‰ã˜ã‚‹
        });

        // ãƒ‡ãƒãƒƒã‚°ï¼šèµ¤ãƒœãƒ¼ãƒ«ã‚’å‡ºç¾ï¼ˆäº”æ¡ç¯‡ã®ã¿ï¼‰
        document.getElementById('debugSpawnGoAka').addEventListener('click', () => {
            if (!gameStarted || isGameOver) return;
            if (!isGojoMode) {
                alert('ğŸ”´ èµ¤ãƒœãƒ¼ãƒ«ã¯äº”æ¡ç¯‡ã§ã®ã¿å‡ºç¾ã§ãã¾ã™');
                return;
            }
            spawnGojoSpecialBall('go_aka');
            debugPanel.classList.remove('active'); // ãƒ‘ãƒãƒ«ã‚’é–‰ã˜ã‚‹
        });

        // ãƒ‡ãƒãƒƒã‚°ï¼šé’ãƒœãƒ¼ãƒ«ã‚’å‡ºç¾ï¼ˆäº”æ¡ç¯‡ã®ã¿ï¼‰
        document.getElementById('debugSpawnGoAo').addEventListener('click', () => {
            if (!gameStarted || isGameOver) return;
            if (!isGojoMode) {
                alert('ğŸ”µ é’ãƒœãƒ¼ãƒ«ã¯äº”æ¡ç¯‡ã§ã®ã¿å‡ºç¾ã§ãã¾ã™');
                return;
            }
            spawnGojoSpecialBall('go_ao');
            debugPanel.classList.remove('active'); // ãƒ‘ãƒãƒ«ã‚’é–‰ã˜ã‚‹
        });

        // ãƒã‚¤ã‚¹ã‚³ã‚¢ä¸€è¦§ãƒœã‚¿ãƒ³
        document.getElementById('highScoreButton').addEventListener('click', () => {
            updateHighScoreDisplay();
            updateRankingToggleButton(); // ãƒˆã‚°ãƒ«ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°
            document.getElementById('highScoreScreen').classList.add('active');
        });
        
        // ãƒ©ãƒ³ã‚­ãƒ³ã‚°å‚åŠ ç¢ºèªç”»é¢ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        document.getElementById('rankingYesButton').addEventListener('click', () => {
            setRankingEnabled(true);
            document.getElementById('rankingConfirmScreen').style.display = 'none';
            
            // ãŠçŸ¥ã‚‰ã›ç”»é¢ã‚’è¡¨ç¤º
            if (isNewsUnviewed()) {
                setTimeout(() => {
                    newsScreen.classList.add('active');
                    markNewsAsViewed();
                }, 300);
            }
        });
        
        document.getElementById('rankingNoButton').addEventListener('click', () => {
            setRankingEnabled(false);
            document.getElementById('rankingConfirmScreen').style.display = 'none';
            
            // ãŠçŸ¥ã‚‰ã›ç”»é¢ã‚’è¡¨ç¤º
            if (isNewsUnviewed()) {
                setTimeout(() => {
                    newsScreen.classList.add('active');
                    markNewsAsViewed();
                }, 300);
            }
        });
        
        // ãƒ©ãƒ³ã‚­ãƒ³ã‚°é€ä¿¡ãƒˆã‚°ãƒ«ãƒœã‚¿ãƒ³
        document.getElementById('rankingToggleButton').addEventListener('click', () => {
            const currentEnabled = isRankingEnabled();
            setRankingEnabled(!currentEnabled);
        });

        // ãƒã‚¤ã‚¹ã‚³ã‚¢ä¸€è¦§ã®è¡¨ç¤ºæ›´æ–°
        function updateHighScoreDisplay() {
            document.getElementById('highScore_easy').textContent = getBestScore('easy');
            document.getElementById('highScore_normal').textContent = getBestScore('normal');
            document.getElementById('highScore_reze').textContent = getBestScore('reze');
            document.getElementById('highScore_gojo').textContent = getBestScore('gojo');
            
            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åã®è¡¨ç¤ºçŠ¶æ…‹ã‚’æ›´æ–°
            updatePlayerNameDisplay();
        }

        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åã®è¡¨ç¤ºçŠ¶æ…‹ã‚’æ›´æ–°
        function updatePlayerNameDisplay() {
            const playerName = localStorage.getItem('watermelonPlayerName') || '';
            const playerNameDisplay = document.getElementById('playerNameDisplay');
            const playerNameInputContainer = document.getElementById('playerNameInputContainer');
            
            if (playerName) {
                // åå‰ãŒã‚ã‚‹å ´åˆã¯è¡¨ç¤ºæ¬„ã‚’è¡¨ç¤º
                playerNameDisplay.textContent = `ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼: ${playerName}`;
                playerNameDisplay.style.display = 'block';
                playerNameInputContainer.style.display = 'none';
            } else {
                // åå‰ãŒãªã„å ´åˆã¯å…¥åŠ›æ¬„ã‚’è¡¨ç¤º
                playerNameDisplay.style.display = 'none';
                playerNameInputContainer.style.display = 'block';
            }
        }

        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åè¡¨ç¤ºæ¬„ã‚’ã‚¯ãƒªãƒƒã‚¯ã§ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã«
        document.getElementById('playerNameDisplay').addEventListener('click', () => {
            const playerName = localStorage.getItem('watermelonPlayerName') || '';
            const playerNameInput = document.getElementById('playerNameInput');
            const playerNameDisplay = document.getElementById('playerNameDisplay');
            const playerNameInputContainer = document.getElementById('playerNameInputContainer');
            
            playerNameInput.value = playerName;
            playerNameDisplay.style.display = 'none';
            playerNameInputContainer.style.display = 'block';
            playerNameInput.focus();
        });

        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åã®å…¥åŠ›å‡¦ç†ï¼ˆãƒ•ã‚©ãƒ¼ã‚«ã‚¹ãŒå¤–ã‚ŒãŸã‚‰ç¢ºå®šï¼‰
        document.getElementById('playerNameInput').addEventListener('blur', (e) => {
            const playerName = e.target.value.trim();
            localStorage.setItem('watermelonPlayerName', playerName);
            updatePlayerNameDisplay();
        });

        // Enterã‚­ãƒ¼ã§ã‚‚ç¢ºå®š
        document.getElementById('playerNameInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.target.blur();
            }
        });

        // ãƒã‚¤ã‚¹ã‚³ã‚¢ä¸€è¦§ã‚’é–‰ã˜ã‚‹
        document.getElementById('closeHighScore').addEventListener('click', () => {
            document.getElementById('highScoreScreen').classList.remove('active');
        });

        // é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³
        document.getElementById('debugClose').addEventListener('click', () => {
            debugPanel.classList.remove('active');
        });

        // ====================
        // ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ©ãƒ³ã‚­ãƒ³ã‚°æ©Ÿèƒ½
        // ====================
        
        // ãƒ©ãƒ³ã‚­ãƒ³ã‚°ç”»é¢ã‚’é–‹ã
        document.getElementById('rankingButton').addEventListener('click', () => {
            rankingScreen.classList.add('active');
            currentRankingType = 'normal'; // ãƒªã‚»ãƒƒãƒˆ
            loadRankings('normal', false); // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ãƒãƒ¼ãƒãƒ«ãƒ¢ãƒ¼ãƒ‰ã€é€šå¸¸ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’è¡¨ç¤º
        });

        // ãŠçŸ¥ã‚‰ã›ãƒœã‚¿ãƒ³
        const newsScreen = document.getElementById('newsScreen');
        const CURRENT_VERSION = 'v5.8'; // ç¾åœ¨ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³
        const NEWS_STORAGE_KEY = `newsViewed_${CURRENT_VERSION}`;
        
        // ãŠçŸ¥ã‚‰ã›ã‚’æ—¢èª­ã«ã™ã‚‹
        function markNewsAsViewed() {
            localStorage.setItem(NEWS_STORAGE_KEY, 'true');
        }
        
        // ãŠçŸ¥ã‚‰ã›ãŒæœªèª­ã‹ãƒã‚§ãƒƒã‚¯
        function isNewsUnviewed() {
            return !localStorage.getItem(NEWS_STORAGE_KEY);
        }
        
        // ãŠçŸ¥ã‚‰ã›ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯
        document.getElementById('newsButton').addEventListener('click', () => {
            newsScreen.classList.add('active');
            markNewsAsViewed(); // é–‹ã„ãŸã‚‰æ—¢èª­ã«ã™ã‚‹
        });

        // ãŠçŸ¥ã‚‰ã›ç”»é¢ã‚’é–‰ã˜ã‚‹ï¼ˆä¸‹ã®ãƒœã‚¿ãƒ³ï¼‰
        document.getElementById('closeNews').addEventListener('click', () => {
            newsScreen.classList.remove('active');
        });
        
        // ãŠçŸ¥ã‚‰ã›ç”»é¢ã‚’é–‰ã˜ã‚‹ï¼ˆÃ—ãƒœã‚¿ãƒ³ï¼‰
        document.getElementById('closeNewsX').addEventListener('click', () => {
            newsScreen.classList.remove('active');
        });
        
        // ã‚²ãƒ¼ãƒ é–‹å§‹æ™‚ã«æœªèª­ã®ãŠçŸ¥ã‚‰ã›ãŒã‚ã‚Œã°è‡ªå‹•è¡¨ç¤º
        window.addEventListener('load', () => {
            // åˆå›ç¢ºèªç”»é¢ã‚’è¡¨ç¤º
            if (shouldShowRankingConfirm()) {
                setTimeout(() => {
                    document.getElementById('rankingConfirmScreen').style.display = 'flex';
                }, 300);
            } else if (isNewsUnviewed()) {
                // 0.5ç§’é…å»¶ã•ã›ã¦è¡¨ç¤º
                setTimeout(() => {
                    newsScreen.classList.add('active');
                    markNewsAsViewed();
                }, 500);
            }
            
            // ãƒˆã‚°ãƒ«ãƒœã‚¿ãƒ³ã®åˆæœŸè¡¨ç¤ºã‚’æ›´æ–°
            updateRankingToggleButton();
        });

        // ãƒ©ãƒ³ã‚­ãƒ³ã‚°ç”»é¢ã‚’é–‰ã˜ã‚‹
        document.getElementById('closeRanking').addEventListener('click', () => {
            rankingScreen.classList.remove('active');
        });

        // é€šå¸¸/ã‚¤ãƒ™ãƒ³ãƒˆåˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³
        let currentRankingType = 'normal'; // 'normal' or 'event'
        
        document.querySelectorAll('.ranking-type-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’åˆ‡ã‚Šæ›¿ãˆ
                document.querySelectorAll('.ranking-type-btn').forEach(b => {
                    b.style.background = 'rgba(139, 111, 71, 0.2)';
                    b.style.color = '#5C4A3A';
                    b.style.border = '2px solid #8B6F47';
                });
                btn.style.background = '#8B6F47';
                btn.style.color = 'white';
                btn.style.border = 'none';
                
                // ã‚¿ã‚¤ãƒ—ã‚’å¤‰æ›´
                currentRankingType = btn.dataset.type;
                
                // ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’èª­ã¿è¾¼ã¿
                const activeMode = document.querySelector('.ranking-mode-btn.active');
                const mode = activeMode ? activeMode.dataset.mode : 'normal';
                loadRankings(mode, currentRankingType === 'event');
            });
        });

        // ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³
        document.querySelectorAll('.ranking-mode-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’åˆ‡ã‚Šæ›¿ãˆ
                document.querySelectorAll('.ranking-mode-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                
                // ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’èª­ã¿è¾¼ã¿
                const mode = btn.dataset.mode;
                loadRankings(mode, currentRankingType === 'event');
            });
        });

        // æ›´æ–°ãƒœã‚¿ãƒ³
        document.getElementById('refreshRanking').addEventListener('click', () => {
            const activeBtn = document.querySelector('.ranking-mode-btn.active');
            const mode = activeBtn ? activeBtn.dataset.mode : 'normal';
            loadRankings(mode, currentRankingType === 'event');
        });

        // ãƒã‚¤ã‚¹ã‚³ã‚¢ã‚’ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã«åæ˜ 
        document.getElementById('syncToRanking').addEventListener('click', async () => {
            const btn = document.getElementById('syncToRanking');
            btn.disabled = true;
            btn.textContent = 'é€ä¿¡ä¸­...';
            
            const playerName = localStorage.getItem('watermelonPlayerName') || 'åç„¡ã—';
            let successCount = 0;
            
            console.log('=== ğŸ† ãƒ©ãƒ³ã‚­ãƒ³ã‚°åæ˜ é–‹å§‹ ===');
            console.log('ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å:', playerName);
            console.log('Device ID:', DEVICE_ID);
            console.log('API URL:', RANKING_API_URL);
            
            // ç”»é¢ã«è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã‚¹ã‚³ã‚¢ã‚’ç›´æ¥å–å¾—
            const scores = {
                normal: parseInt(document.getElementById('highScore_normal').textContent) || 0,
                easy: parseInt(document.getElementById('highScore_easy').textContent) || 0,
                reze: parseInt(document.getElementById('highScore_reze').textContent) || 0,
                gojo: parseInt(document.getElementById('highScore_gojo').textContent) || 0
            };
            
            console.log('å–å¾—ã—ãŸã‚¹ã‚³ã‚¢:', scores);
            
            for (const [mode, score] of Object.entries(scores)) {
                console.log(`--- ${mode}ãƒ¢ãƒ¼ãƒ‰å‡¦ç†é–‹å§‹ ---`);
                console.log(`ã‚¹ã‚³ã‚¢: ${score}ç‚¹`);
                
                if (score > 0) {
                    console.log('â†’ é€ä¿¡ã—ã¾ã™');
                    const success = await submitScore(mode, playerName, score);
                    console.log(`â†’ é€ä¿¡çµæœ: ${success ? 'æˆåŠŸ' : 'å¤±æ•—'}`);
                    if (success) successCount++;
                } else {
                    console.log('â†’ ã‚¹ã‚³ã‚¢ãŒ0ã®ãŸã‚ã‚¹ã‚­ãƒƒãƒ—');
                }
            }
            
            console.log('=== é€ä¿¡å®Œäº† ===');
            console.log('æˆåŠŸä»¶æ•°:', successCount);
            
            btn.disabled = false;
            
            if (successCount === 0) {
                btn.textContent = 'âŒ é€ä¿¡å¤±æ•—';
                console.error('å…¨ã¦ã®é€ä¿¡ãŒå¤±æ•—ã—ã¾ã—ãŸ');
            } else {
                btn.textContent = `âœ… ${successCount}ä»¶é€ä¿¡å®Œäº†`;
                console.log(`${successCount}ä»¶ã®é€ä¿¡ã«æˆåŠŸã—ã¾ã—ãŸ`);
            }
            
            setTimeout(() => {
                btn.textContent = 'ğŸ† ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã«åæ˜ ';
            }, 2000);
        });

        // ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€
        async function loadRankings(mode, isEvent = false) {
            const rankingList = document.getElementById('rankingList');
            rankingList.innerHTML = '<div class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>';
            
            try {
                const url = isEvent 
                    ? `${RANKING_API_URL}?mode=${mode}&event=true`
                    : `${RANKING_API_URL}?mode=${mode}`;
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.success && data.rankings) {
                    if (isEvent && data.eventActive === false) {
                        rankingList.innerHTML = '<div class="loading">ã‚¤ãƒ™ãƒ³ãƒˆæº–å‚™ä¸­</div>';
                    } else {
                        displayRankings(data.rankings);
                    }
                } else {
                    rankingList.innerHTML = '<div class="error">ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
                }
            } catch (error) {
                console.error('Ranking load error:', error);
                rankingList.innerHTML = '<div class="error">ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</div>';
            }
        }

        // ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’è¡¨ç¤º
        function displayRankings(rankings) {
            const rankingList = document.getElementById('rankingList');
            
            let html = '';
            
            // 1ä½ï½10ä½ã¾ã§å¿…ãšæ ã‚’è¡¨ç¤º
            for (let rank = 1; rank <= 10; rank++) {
                const item = rankings.find(r => r.rank === rank);
                const isTop3 = rank <= 3;
                const rankEmoji = rank === 1 ? 'ğŸ¥‡' : rank === 2 ? 'ğŸ¥ˆ' : rank === 3 ? 'ğŸ¥‰' : '';
                
                if (item) {
                    // ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆ
                    html += `
                        <div class="ranking-item ${isTop3 ? 'top3' : ''}">
                            <div class="ranking-rank">${rankEmoji}${rank}</div>
                            <div class="ranking-player">${escapeHtml(item.player || 'åç„¡ã—')}</div>
                            <div class="ranking-score">${item.score.toLocaleString()}</div>
                        </div>
                    `;
                } else {
                    // ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯ç©ºæ¬„
                    html += `
                        <div class="ranking-item">
                            <div class="ranking-rank">${rankEmoji}${rank}</div>
                            <div class="ranking-player" style="opacity: 0.3;">---</div>
                            <div class="ranking-score" style="opacity: 0.3;">---</div>
                        </div>
                    `;
                }
            }
            
            rankingList.innerHTML = html;
        }

        // ã‚¹ã‚³ã‚¢ã‚’é€ä¿¡
        async function submitScore(mode, playerName, score) {
            // ãƒ©ãƒ³ã‚­ãƒ³ã‚°é€ä¿¡ãŒç„¡åŠ¹ãªã‚‰ä½•ã‚‚ã—ãªã„
            if (!isRankingEnabled()) {
                console.log('ãƒ©ãƒ³ã‚­ãƒ³ã‚°é€ä¿¡: OFFï¼ˆã‚¹ã‚³ã‚¢ã¯é€ä¿¡ã•ã‚Œã¾ã›ã‚“ï¼‰');
                return true; // ãƒ­ãƒ¼ã‚«ãƒ«ã«ã¯ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ã®ã§trueã‚’è¿”ã™
            }
            
            try {
                console.log('é€ä¿¡ãƒ‡ãƒ¼ã‚¿:', { mode, playerName, score, deviceId: DEVICE_ID });
                
                // GETæ–¹å¼ã§ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’é€ä¿¡
                const url = `${RANKING_API_URL}?action=submit&mode=${encodeURIComponent(mode)}&player=${encodeURIComponent(playerName || 'åç„¡ã—')}&score=${score}&deviceId=${encodeURIComponent(DEVICE_ID)}`;
                
                const response = await fetch(url);
                
                console.log('ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:', response.status);
                const data = await response.json();
                console.log('ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ‡ãƒ¼ã‚¿:', data);
                
                return data.success;
            } catch (error) {
                console.error('Score submission error:', error);
                return false;
            }
        }

        // HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ï¼ˆXSSå¯¾ç­–ï¼‰
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>